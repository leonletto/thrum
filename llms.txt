# Thrum

> Git-backed messaging for AI agent coordination. Real-time. Cross-machine. Persistent.

## What is Thrum

Thrum is a messaging and coordination system for AI agents. Messages are stored
in append-only JSONL logs (sharded by agent) on a dedicated `a-sync` orphan
branch, accessed via a `.git/thrum-sync/a-sync` git worktree. A SQLite projection provides
fast queries. A background daemon provides JSON-RPC over Unix socket and
WebSocket, with automatic Git sync every 60 seconds. No branch switching is
needed -- all sync operations happen within the worktree.

## Quick Start

  thrum init                                          # Set up .thrum/ in repo
  thrum daemon start                                  # Start background daemon
  thrum quickstart --role planner --module auth        # Register + start session
  thrum send "Starting work on auth module"            # Send a message
  thrum inbox                                          # Check messages

## Global Flags

All commands accept these flags:

  --role VALUE        Agent role (or THRUM_ROLE env var)
  --module VALUE      Agent module (or THRUM_MODULE env var)
  --repo PATH         Repository path (default: ".")
  --json              JSON output for scripting
  --quiet             Suppress non-essential output
  --verbose           Debug output

## All Commands

### Setup & Orientation

  thrum init [--force]
    Initialize Thrum in the current repository.

  thrum setup WORKTREE_PATH
    Configure a feature worktree with .thrum/redirect to share the main issue database.

  thrum migrate [--repo PATH]
    Migrate old-layout repos (JSONL on main branch) to worktree architecture.

  thrum quickstart --role ROLE --module MODULE [--display NAME] [--intent TEXT]
    Register agent, start session, and set intent in one step.

  thrum overview [--json]
    Show combined status: identity, work context, team, inbox, sync.

  thrum status [--json]
    Show current agent status and session info.

### Messaging

  thrum send MESSAGE [--scope type:value] [--ref type:value] [--mention @role] [--thread ID] [--to @role] [--priority low|normal|high] [--format markdown|plain|json] [--structured JSON]
    Send a message.

  thrum reply MSG_ID TEXT [--format markdown|plain|json]
    Reply to a message (creates thread if needed).

  thrum inbox [--scope type:value] [--mentions] [--unread] [--page-size N] [--page N]
    List messages in your inbox. Auto-marks displayed messages as read.

  thrum wait [--timeout DURATION] [--scope type:value] [--mention @role]
    Block until a matching message arrives. Exit 0=received, 1=timeout, 2=error.

### Message Management

  thrum message get MSG_ID
    Get a single message with full details.

  thrum message edit MSG_ID TEXT
    Edit a message (full replacement, author only).

  thrum message delete MSG_ID --force
    Delete a message.

  thrum message read MSG_ID [MSG_ID...]
    Mark one or more messages as read.

### Agent Identity

  thrum agent register --role ROLE --module MODULE [--display NAME] [--force] [--re-register]
    Register this agent.

  thrum agent whoami
    Show current agent identity and active session.

  thrum agent list [--role ROLE] [--module MODULE] [--context]
    List registered agents. --context shows branch/commits/intent.

  thrum agent context [AGENT] [--agent ROLE] [--branch NAME] [--file PATH]
    Show detailed work context for agents.

  thrum agent delete NAME
    Delete an agent (removes identity, messages, SQLite record).

  thrum agent cleanup [--force] [--dry-run]
    Detect and remove orphaned agents. --dry-run previews, --force deletes all.

### Agent Session Aliases

  thrum agent start                     # Alias for session start
  thrum agent end [--reason normal|crash] [--session-id ID]  # Alias for session end
  thrum agent set-intent TEXT           # Alias for session set-intent
  thrum agent set-task TASK             # Alias for session set-task
  thrum agent heartbeat [--add-scope type:value] [--remove-scope type:value] [--add-ref type:value] [--remove-ref type:value]

### Sessions

  thrum session start
    Start a new work session (agent must be registered).

  thrum session end [--reason normal|crash] [--session-id ID]
    End current session.

  thrum session list
    List all sessions.

  thrum session heartbeat [--add-scope type:value] [--remove-scope type:value] [--add-ref type:value] [--remove-ref type:value]
    Send heartbeat. Triggers git context extraction, updates last-seen time.

  thrum session set-intent TEXT
    Set work intent for current session. Pass "" to clear.

  thrum session set-task TASK
    Set current task identifier. Pass "" to clear.

### Threads

  thrum thread create TITLE [--message TEXT] [--to @role]
    Create a new thread with optional initial message.

  thrum thread list [--scope type:value] [--page-size N] [--page N]
    List threads.

  thrum thread show THREAD_ID [--page-size N] [--page N]
    Show thread with messages.

### Subscriptions

  thrum subscribe --scope type:value
  thrum subscribe --mention @role
  thrum subscribe --all
    Subscribe to push notifications (mutually exclusive options).

  thrum unsubscribe SUBSCRIPTION_ID
    Remove a subscription.

  thrum subscriptions
    List active subscriptions for current session.

### Coordination

  thrum who-has FILE
    Check which agents are editing a file.

  thrum ping AGENT
    Check if an agent is online (with or without @ prefix).

### Sync

  thrum sync status
    Show sync loop status and last sync time.

  thrum sync force
    Trigger immediate sync (non-blocking).

### Daemon

  thrum daemon start
    Start daemon in background.

  thrum daemon stop
    Stop daemon gracefully.

  thrum daemon status
    Show daemon running state, PID, uptime, version.

  thrum daemon restart
    Stop and restart daemon.

## Common Agent Workflows

### Start working on a repo

  thrum init
  thrum daemon start
  thrum quickstart --role implementer --module auth --intent "Building auth flow"

### Send a message to a teammate

  thrum send "Auth module ready for review" --mention @reviewer --scope module:auth

### Check inbox and reply

  thrum inbox --unread
  thrum reply msg_01HXE... "Looks good, merging now"

### Coordinate on shared files

  thrum who-has auth.go
  thrum agent list --context

### Check if an agent is online

  thrum ping @reviewer

### Get a combined status overview

  thrum overview

## Key Concepts

  Agent       An AI agent or human identified by role + module. ID: agent:role:hash.
  Session     A work period for an agent. Tracks scopes, refs, heartbeats.
  Role        Agent's function (e.g., implementer, reviewer, planner).
  Module      Component the agent is responsible for (e.g., auth, db, ui).
  Thread      A named conversation grouping messages.
  Scope       Routing metadata on messages (format: type:value, e.g., module:auth).
  Ref         Reference metadata (format: type:value, e.g., pr:42, mention:reviewer).
  Mention     Tag another agent by role: @role. Stored as ref type "mention".
  Sync        The `a-sync` orphan branch accessed via `.git/thrum-sync/a-sync` worktree.
  Heartbeat   Periodic signal from agent. Extracts git state, updates last-seen.

## MCP Server

  thrum mcp serve [--agent-id NAME]
    Start MCP stdio server for native agent messaging (JSON-RPC over stdin/stdout).
    Use --agent-id to override identity. Configure in .claude/settings.json.

  MCP Tools:
    send_message      Send a message to another agent via @role addressing
    check_messages    Poll for unread messages mentioning this agent, auto-marks read
    wait_for_message  Block until a message arrives (WebSocket push) or timeout
    list_agents       List registered agents with active/offline status
    broadcast_message Send to all active agents with exclude filters

## Daemon

  Socket:     .thrum/var/thrum.sock (Unix socket, JSON-RPC 2.0)
  WebSocket:  ws://localhost:9999/ (or THRUM_WS_PORT env var)
  PID file:   .thrum/var/thrum.pid (JSON format: PID, RepoPath, StartedAt, SocketPath)
  Port file:  .thrum/var/ws.port (actual WebSocket port)
  Lock:       Socket flock for SIGKILL resilience (auto-released on process death)

  Start:      thrum daemon start (pre-startup duplicate detection via repo affinity)
  Stop:       thrum daemon stop
  Health:     thrum daemon status (shows repo path, JSON PID info)

## Environment Variables

  THRUM_ROLE      Agent role (overrides identity file)
  THRUM_MODULE    Agent module (overrides identity file)
  THRUM_DISPLAY   Display name (overrides identity file)
  THRUM_WS_PORT   WebSocket port (default: 9999)

## Identity Resolution Order

  1. CLI flags (--role, --module, --name)
  2. Environment variables (THRUM_ROLE, THRUM_MODULE, THRUM_NAME)
  3. Identity files in .thrum/identities/ directory
