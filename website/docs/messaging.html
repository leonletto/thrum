<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messaging — Thrum</title>
  <meta name="description" content="Thrum messaging system — sending, receiving, replies, priorities, scopes, mentions, and inbox filtering">
  <!-- Open Graph -->
  <meta property="og:type" content="article">
  <meta property="og:title" content="Messaging — Thrum">
  <meta property="og:description" content="Thrum messaging system — sending, receiving, replies, priorities, scopes, mentions, and inbox filtering">
  <meta property="og:url" content="https://leonletto.github.io/thrum/docs/messaging.html">
  <meta property="og:site_name" content="Thrum">
  <meta property="og:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Messaging — Thrum">
  <meta name="twitter:description" content="Thrum messaging system — sending, receiving, replies, priorities, scopes, mentions, and inbox filtering">
  <meta name="twitter:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <!-- Canonical: SPA is the primary URL -->
  <link rel="canonical" href="https://leonletto.github.io/thrum/docs.html#messaging.html">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x26A1;</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/theme.css">
  <link rel="stylesheet" href="../css/docs.css">
  <script>
    (function(){var t=localStorage.getItem('thrum-theme');if(t){document.documentElement.setAttribute('data-theme',t)}else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:light)').matches){document.documentElement.setAttribute('data-theme','light')}else{document.documentElement.setAttribute('data-theme','dark')}})();
  </script>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <nav class="header-nav">
        <a href="../index.html" class="logo">
          <span class="logo-glyph">&gt;_</span>
          <span class="logo-text">thrum</span>
        </a>
        <div class="nav-links">
          <a href="../index.html" class="nav-link">Home</a>
          <a href="../docs.html" class="nav-link nav-link-active">Docs</a>
          <a href="../about.html" class="nav-link">About</a>
          <a href="https://github.com/leonletto/thrum" class="nav-link nav-link-external" target="_blank" rel="noopener">GitHub</a>
        </div>
      </nav>
    </div>
  </header>
  <main class="docs-content" style="max-width:48rem;margin:2rem auto;padding:0 1.5rem">
    <div class="docs-content-inner">
<h2>Thrum Messaging System</h2>
<h2>Overview</h2>
<p>The Thrum messaging system provides structured communication between agents with<br>support for direct messaging, read tracking, scoping, references, and rich<br>content formats. Messages are persisted in a Git-backed event log and projected<br>into SQLite for fast queries.</p>
<p>This document covers the CLI commands and behaviors for sending, receiving,<br>replying to, and managing messages.</p>
<h2>Quick Reference</h2>
<h3>Top-Level Commands</h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>thrum send MESSAGE</code></td>
<td>Send a message (with optional <code>--to</code>, <code>--scope</code>, <code>--ref</code>, <code>--mention</code>)</td>
</tr>
<tr>
<td><code>thrum reply MSG_ID TEXT</code></td>
<td>Reply to a message, creating a reply-to reference</td>
</tr>
<tr>
<td><code>thrum inbox</code></td>
<td>List messages with read/unread indicators</td>
</tr>
<tr>
<td><code>thrum message read</code></td>
<td>Mark messages as read (single, multiple, or --all)</td>
</tr>
</tbody></table>
<h3>Message Subcommands</h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>thrum message get MSG_ID</code></td>
<td>Retrieve a single message with full details</td>
</tr>
<tr>
<td><code>thrum message edit MSG_ID TEXT</code></td>
<td>Replace a message&#39;s content (author only)</td>
</tr>
<tr>
<td><code>thrum message delete MSG_ID --force</code></td>
<td>Soft-delete a message</td>
</tr>
<tr>
<td><code>thrum message read MSG_ID [...]</code></td>
<td>Manually mark messages as read</td>
</tr>
</tbody></table>
<h2>Sending Messages</h2>
<h3>Basic Send</h3>
<pre><code class="language-bash hljs">thrum send <span class="hljs-string">&quot;Test suite is green, ready for review&quot;</span>
```go

The daemon resolves the current agent identity and session automatically. The
message is written as a `message.create` event to the agent<span class="hljs-string">&#x27;s sharded JSONL log
(`.git/thrum-sync/a-sync/messages/{agent_name}.jsonl`) and projected into
SQLite.

### Flags

| Flag           | Format                  | Description                             |
| -------------- | ----------------------- | --------------------------------------- |
| `--to`         | `@role`                 | Direct recipient (adds a mention ref)   |
| `--scope`      | `type:value`            | Attach scope context (repeatable)       |
| `--ref`        | `type:value`            | Attach reference (repeatable)           |
| `--mention`    | `@role`                 | Mention an agent role (repeatable)      |
| `--format`     | `markdown\|plain\|json` | Content format (default: `markdown`)    |
| `--structured` | JSON string             | Typed payload for machine-readable data |

### Direct Messaging with --to

The `--to` flag provides a shorthand for directing a message to a specific
agent, role, or group. Under the hood, `--to @reviewer` appends `@reviewer` to
the mentions list, which is stored as a `mention` ref on the message.

```bash
# These are equivalent:
thrum send &quot;Please review PR #42&quot; --to @reviewer
thrum send &quot;Please review PR #42&quot; --mention @reviewer

# Send to a group
thrum send &quot;Deploy complete&quot; --to @everyone

# Send to a custom group
thrum send &quot;Backend review needed&quot; --to @backend
```go

The `@` prefix is optional -- `--to reviewer` and `--to @reviewer` both work.

### Mention Routing

When a message includes mentions (via `--to`, `--mention`, or `@role` in the
mentions list), Thrum stores them as refs with type `mention` and the role name
as the value:

```json
{ &quot;type&quot;: &quot;mention&quot;, &quot;value&quot;: &quot;reviewer&quot; }
```text

Agents can then filter their inbox to only messages that mention them:

```bash
thrum inbox --mentions
```text

This queries for messages where a `mention` ref matches the current agent&#x27;</span>s
role.

<span class="hljs-comment">### Name vs Role Routing (v0.4.5+)</span>

Thrum routes `@mentions` differently depending on whether the target is a name
or a role:

| Target      | Routing behaviour                                                                 |
| ----------- | --------------------------------------------------------------------------------- |
| `@furiosa`  | Routes directly to agent named `furiosa`                                          |
| `@reviewer` | Routes via the auto-created `reviewer` role group (all agents with role reviewer) |
| `@everyone` | Broadcasts to all agents                                                          |
| `@mygroup`  | Routes to the named custom group                                                  |

**Important:** Sending to an unknown name/group that doesn<span class="hljs-string">&#x27;t exist is a **hard
error** — the message is rejected and not stored. Unknown recipients must be
created as agents or groups first.

**Registration rule:** Agent names must differ from their role. Use distinct
names like `--name coord_main --role coordinator` rather than
`--name coordinator --role coordinator`.

### Example: Agent-to-Agent Coordination

```bash
# Implementer finishes a task and notifies the reviewer
thrum send &quot;Auth module complete, all tests passing&quot; \
  --to @reviewer \
  --scope module:auth \
  --ref issue:beads-42

# Reviewer checks inbox for messages directed at them
thrum inbox --mentions

# Reviewer replies to the message
thrum reply msg_01HXE... &quot;Looks good, merging now&quot;
```text

## Replying to Messages

The `reply` command creates a reply-to reference linking your message to the
original:

```bash
thrum reply MSG_ID &quot;Your reply text&quot;
```text

**What happens internally:**

1. Creates a new message with a `reply_to` ref pointing to the original message.
2. The inbox groups replies with the original message using a `↳` prefix.
3. Marks the original message as read (auto mark-as-read).

### Flags

| Flag       | Format                  | Description                          |
| ---------- | ----------------------- | ------------------------------------ |
| `--format` | `markdown\|plain\|json` | Content format (default: `markdown`) |

### Example

```bash
# Reply to a message
thrum reply msg_01HXE... &quot;Good idea, let&#x27;</span>s <span class="hljs-keyword">do</span> that<span class="hljs-string">&quot;

# Reply with plain text format
thrum reply msg_01HXF... &quot;</span>Acknowledged<span class="hljs-string">&quot; --format plain
```text

**Output:**

```text
&gt; Reply sent: msg_01HXG...
  In reply to: msg_01HXE...
```text

## Inbox

The inbox displays messages with read/unread indicators, relative timestamps,
and pagination.

```bash
thrum inbox
```text

### Flags

| Flag                 | Description                                |
| -------------------- | ------------------------------------------ |
| `--scope type:value` | Filter by scope                            |
| `--mentions`         | Only messages mentioning the current agent |
| `--unread`           | Only unread messages                       |
| `--page-size N`      | Results per page (default: 10)             |
| `--limit N`          | Alias for `--page-size`                    |
| `--page N`           | Page number (default: 1)                   |

### Read/Unread Indicators

Each message in the inbox shows a read-state indicator:

- `●` (filled circle) -- unread
- `○` (open circle) -- read

The header line for each message follows this format:

```text
│ ● msg_01HXE...  @implementer  5m ago                     │
│ ○ msg_01HXF...  @reviewer     1h ago  (edited)           │
│ ↳ msg_01HXG...  @implementer  10m ago                    │
```text

Messages that have been edited show an `(edited)` tag in the header. Replies are
displayed with a `↳` prefix and grouped with the original message.

### Auto Mark-as-Read

Viewing the inbox automatically marks all displayed messages as read
(best-effort; failure does not block the command). This behavior is skipped when
using the `--unread` filter, so that repeatedly checking unread messages does
not clear them before you act on them.

The footer shows pagination and unread count:

```text
Showing 1-10 of 23 messages (3 unread)
```text

### Empty States

When no messages match the current filters, the inbox shows contextual feedback:

```bash
# No messages at all
thrum inbox
# Output: No messages in inbox.

# No messages matching a scope filter
thrum inbox --scope module:auth
# Output: No messages matching filter --scope module:auth
#         Showing 0 of 15 total messages (filter: scope=module:auth)
```text

## Message Operations

### Get

Retrieve a single message with its full details: author, timestamps, scopes,
refs, edit and delete status.

```bash
thrum message get msg_01HXE...
```text

**Output:**

```yaml
Message: msg_01HXE...
  From:    @implementer
  Time:    5m ago
  Scopes:  module:auth
  Refs:    issue:beads-42, mention:reviewer
  Edited:  2m ago

Auth module complete, all tests passing
```text

The `get` command automatically marks the message as read.

### Edit

Replace a message&#x27;s content entirely. Only the original author (matching
`agent_id`) can edit their own messages. Deleted messages cannot be edited.

```bash
thrum message edit msg_01HXE... &quot;</span>Updated: auth module complete with rate limiting<span class="hljs-string">&quot;
```text

**Output:**

```text
&gt; Message edited: msg_01HXE... (version 2)
```text

Each edit is recorded in the `message_edits` table with before/after content,
the editor&#x27;s session, and a timestamp. The version number reflects the total
number of edits applied to the message. Edits trigger subscription notifications
just like new messages.

### Delete

Soft-delete a message. Requires the `--force` flag as a safety confirmation.

```bash
thrum message delete msg_01HXE... --force
```text

**Output:**

```text
&gt; Message deleted: msg_01HXE...
```text

Deleted messages:

- Are flagged with `deleted=1` in SQLite and a `message.delete` event is
  appended to the JSONL log.
- Still appear in `message get` (with a `DELETED` status label) but are excluded
  from inbox listings by default.
- Cannot be un-deleted (the JSONL log is append-only).
- Can include an optional deletion reason in the RPC request.

### Mark Read

Explicitly mark one or more messages as read. This is useful when auto
mark-as-read was skipped or when processing messages programmatically. Use
`--all` to mark every unread message as read at once.

```bash
thrum message read msg_01HXE...
thrum message read msg_01 msg_02 msg_03
thrum message read --all
```text

**Output:**

```text
&gt; Marked 3 messages as read
```text

Read state is tracked per session and per agent in the `message_reads` table. A
message is considered &quot;</span><span class="hljs-built_in">read</span><span class="hljs-string">&quot; if any session or agent matching the current
identity has a read record for it.

### Auto Mark-as-Read Summary

Several commands mark messages as read automatically:

| Command                    | Behavior                                                       |
| -------------------------- | -------------------------------------------------------------- |
| `thrum inbox`              | Marks all displayed messages as read (skipped with `--unread`) |
| `thrum reply MSG_ID ...`   | Marks the replied-to message as read                           |
| `thrum message get MSG_ID` | Marks the retrieved message as read                            |

All auto mark-as-read operations are best-effort: if they fail, the parent
command still succeeds.

## Message Structure

### Core Fields

Every message has these core fields:

```json
{
  &quot;</span>message_id<span class="hljs-string">&quot;: &quot;</span>msg_01HXE...<span class="hljs-string">&quot;,
  &quot;</span>author<span class="hljs-string">&quot;: {
    &quot;</span>agent_id<span class="hljs-string">&quot;: &quot;</span>agent:role:HASH<span class="hljs-string">&quot;,
    &quot;</span>session_id<span class="hljs-string">&quot;: &quot;</span>ses_01HXE...<span class="hljs-string">&quot;
  },
  &quot;</span>body<span class="hljs-string">&quot;: {
    &quot;</span>format<span class="hljs-string">&quot;: &quot;</span>markdown<span class="hljs-string">&quot;,
    &quot;</span>content<span class="hljs-string">&quot;: &quot;</span>Message content<span class="hljs-string">&quot;,
    &quot;</span>structured<span class="hljs-string">&quot;: &quot;</span>{...}<span class="hljs-string">&quot;
  },
  &quot;</span>scopes<span class="hljs-string">&quot;: [],
  &quot;</span>refs<span class="hljs-string">&quot;: [],
  &quot;</span>metadata<span class="hljs-string">&quot;: {},
  &quot;</span>created_at<span class="hljs-string">&quot;: &quot;</span>2026-02-03T10:00:00Z<span class="hljs-string">&quot;,
  &quot;</span>updated_at<span class="hljs-string">&quot;: &quot;</span>2026-02-03T11:00:00Z<span class="hljs-string">&quot;,
  &quot;</span>deleted<span class="hljs-string">&quot;: false
}
```text

### Body Formats

Messages support three content formats:

**Markdown** (default) -- best for human-readable documentation, notes, and
status updates:

```json
{ &quot;</span>format<span class="hljs-string">&quot;: &quot;</span>markdown<span class="hljs-string">&quot;, &quot;</span>content<span class="hljs-string">&quot;: &quot;</span># Heading\n\nWith **formatting**<span class="hljs-string">&quot; }
```text

**Plain text** -- best for log messages, simple status, and system
notifications:

```json
{ &quot;</span>format<span class="hljs-string">&quot;: &quot;</span>plain<span class="hljs-string">&quot;, &quot;</span>content<span class="hljs-string">&quot;: &quot;</span>Simple unformatted text<span class="hljs-string">&quot; }
```go

**JSON** -- best for machine-readable data, API responses, and structured
status:

```json
{ &quot;</span>format<span class="hljs-string">&quot;: &quot;</span>json<span class="hljs-string">&quot;, &quot;</span>content<span class="hljs-string">&quot;: &quot;</span>{\&quot;<span class="hljs-built_in">type</span>\&quot;:\&quot;status\&quot;,\&quot;value\&quot;:\&quot;complete\&quot;}<span class="hljs-string">&quot; }
```go

### Structured Data

In addition to the main content, messages can include typed structured data via
the `--structured` flag:

```bash
thrum send &quot;</span>Test results <span class="hljs-keyword">for</span> feature X<span class="hljs-string">&quot; \
  --structured &#x27;{&quot;</span><span class="hljs-built_in">type</span><span class="hljs-string">&quot;:&quot;</span>test_result<span class="hljs-string">&quot;,&quot;</span>passed<span class="hljs-string">&quot;:45,&quot;</span>failed<span class="hljs-string">&quot;:2,&quot;</span>coverage<span class="hljs-string">&quot;:85.9}&#x27;
```go

The `structured` field allows agents to parse machine-readable payloads, build
dashboards, trigger automated workflows, and index by structured fields.

## Scopes

Scopes define the context and visibility of a message. They answer &quot;</span>What is this
message about?<span class="hljs-string">&quot;

### Scope Structure

```json
{ &quot;</span><span class="hljs-built_in">type</span><span class="hljs-string">&quot;: &quot;</span>scope_type<span class="hljs-string">&quot;, &quot;</span>value<span class="hljs-string">&quot;: &quot;</span>scope_value<span class="hljs-string">&quot; }
```text

### Common Scope Types

| Type        | Example                       | Use                                     |
| ----------- | ----------------------------- | --------------------------------------- |
| `repo`      | `repo:github.com/user/repo`   | Messages about a specific repository    |
| `file`      | `file:src/main.go`            | Messages related to a specific file     |
| `dir`       | `dir:src/components`          | Messages about a directory and contents |
| `feature`   | `feature:user-authentication` | Messages about a feature or epic        |
| `component` | `component:api-server`        | Messages about a system component       |
| `module`    | `module:auth`                 | Messages about a code module            |

### Multiple Scopes

A message can have multiple scopes:

```bash
thrum send &quot;</span>Fixed authentication bug<span class="hljs-string">&quot; \
  --scope repo:github.com/user/repo \
  --scope file:src/auth.go \
  --scope feature:user-authentication
```text

### Filtering by Scope

```bash
thrum inbox --scope file:src/main.go
thrum inbox --scope module:auth
```go

## References (Refs)

References link messages to external entities. They answer &quot;</span>What does this
message reference?<span class="hljs-string">&quot;

### Ref Structure

```json
{ &quot;</span><span class="hljs-built_in">type</span><span class="hljs-string">&quot;: &quot;</span>ref_type<span class="hljs-string">&quot;, &quot;</span>value<span class="hljs-string">&quot;: &quot;</span>ref_value<span class="hljs-string">&quot; }
```text

### Common Ref Types

| Type       | Example                             | Use                                                     |
| ---------- | ----------------------------------- | ------------------------------------------------------- |
| `issue`    | `issue:beads-123`                   | Links to a Beads issue                                  |
| `commit`   | `commit:abc123def456`               | Links to a Git commit                                   |
| `pr`       | `pr:42`                             | Links to a pull request                                 |
| `ticket`   | `ticket:JIRA-456`                   | Links to an external ticket                             |
| `url`      | `url:https://docs.example.com/page` | Links to a web page                                     |
| `mention`  | `mention:reviewer`                  | Created automatically from `--to` and `--mention` flags |
| `reply_to` | `reply_to:msg_01HXE...`             | Created by `thrum reply` to link to parent message      |

### Multiple Refs

```bash
thrum send &quot;</span>Implemented feature from design doc, closes issue<span class="hljs-string">&quot; \
  --ref issue:beads-123 \
  --ref commit:abc123def \
  --ref url:https://docs.example.com/design
```text

## Groups

Groups allow you to send messages to collections of agents and roles using a
single `--to @groupname` address.

### Built-in Groups

**`@everyone`** — Automatically created on daemon startup. All registered agents
are implicit members. This group cannot be deleted.

```bash
# Send to all agents
thrum send &quot;</span>Deploy complete<span class="hljs-string">&quot; --to @everyone
```text

### Creating Custom Groups

```bash
# Create a group
thrum group create reviewers --description &quot;</span>Code review team<span class="hljs-string">&quot;

# Add members (agents or roles)
thrum group add reviewers @alice
thrum group add reviewers --role reviewer

# Send to the group
thrum send &quot;</span>PR ready <span class="hljs-keyword">for</span> review<span class="hljs-string">&quot; --to @reviewers
```text

### Group Operations

| Command                           | Description                                     |
| --------------------------------- | ----------------------------------------------- |
| `thrum group create NAME`         | Create a new group                              |
| `thrum group delete NAME`         | Delete a group (cannot delete `@everyone`)      |
| `thrum group add GROUP MEMBER`    | Add agent or role to group                      |
| `thrum group remove GROUP MEMBER` | Remove a member                                 |
| `thrum group list`                | List all groups                                 |
| `thrum group info NAME`           | Show group details                              |
| `thrum group members NAME`        | List members (`--expand` resolves to agent IDs) |

### Message Resolution

When a message is sent to a group, the daemon resolves group membership at
**read time**. This means:

- New agents added to a group automatically receive messages sent to that group
- The `@everyone` group dynamically includes all registered agents
- Role-based members are resolved to all agents with that role at query time

### Broadcast

Both `--broadcast` and `--to @everyone` send to all agents:

```bash
thrum send &quot;</span>Deploy complete<span class="hljs-string">&quot; --broadcast
thrum send &quot;</span>Deploy complete<span class="hljs-string">&quot; --to @everyone
thrum send &quot;</span>Deploy complete<span class="hljs-string">&quot; --everyone
```go

## Global Flags

These flags are available on all commands:

| Flag        | Description                                   |
| ----------- | --------------------------------------------- |
| `--json`    | Output as JSON (for scripting and automation) |
| `--quiet`   | Suppress non-essential output (hints, tips)   |
| `--verbose` | Debug output                                  |
| `--role`    | Agent role (or `THRUM_ROLE` env var)          |
| `--module`  | Agent module (or `THRUM_MODULE` env var)      |
| `--repo`    | Repository path (default: `.`)                |

## Implementation Details

### Storage

Messages are stored in two places:

1. **Sharded JSONL Event Logs** (in the `a-sync` Git worktree at
   `.git/thrum-sync/a-sync/`) -- the append-only source of truth. Events are
   sharded per agent:
   - `.git/thrum-sync/a-sync/events.jsonl` -- agent lifecycle events
     (`agent.register`, `agent.session.start`, `agent.session.end`,
     `agent.cleanup`)
   - `.git/thrum-sync/a-sync/messages/{agent_name}.jsonl` -- per-agent message
     events (`message.create`, `message.edit`, `message.delete`, `agent.update`)

2. **SQLite Projection** (`.thrum/var/messages.db`) -- derived from the JSONL
   logs for query performance. Can be rebuilt from the logs. Contains the tables
   described below.

### Tables

#### messages

```sql
CREATE TABLE messages (
  message_id TEXT PRIMARY KEY,
  agent_id TEXT NOT NULL,
  session_id TEXT NOT NULL,
  created_at TEXT NOT NULL,
  updated_at TEXT,
  deleted INTEGER DEFAULT 0,
  deleted_at TEXT,
  delete_reason TEXT,
  body_format TEXT NOT NULL,
  body_content TEXT NOT NULL,
  body_structured TEXT
)
```text

#### message_scopes

```sql
CREATE TABLE message_scopes (
  message_id TEXT NOT NULL,
  scope_type TEXT NOT NULL,
  scope_value TEXT NOT NULL,
  PRIMARY KEY (message_id, scope_type, scope_value)
)
```text

#### message_refs

```sql
CREATE TABLE message_refs (
  message_id TEXT NOT NULL,
  ref_type TEXT NOT NULL,
  ref_value TEXT NOT NULL,
  PRIMARY KEY (message_id, ref_type, ref_value)
)
```text

#### message_edits

```sql
CREATE TABLE message_edits (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  message_id TEXT NOT NULL,
  edited_at TEXT NOT NULL,
  edited_by TEXT NOT NULL,
  old_content TEXT,
  new_content TEXT,
  old_structured TEXT,
  new_structured TEXT
)
```text

Each row represents one edit operation with before/after values for both content
and structured data.

#### message_reads

```sql
CREATE TABLE message_reads (
  message_id TEXT NOT NULL,
  session_id TEXT NOT NULL,
  agent_id TEXT NOT NULL,
  read_at TEXT NOT NULL,
  PRIMARY KEY (message_id, session_id),
  FOREIGN KEY (message_id) REFERENCES messages(message_id) ON DELETE CASCADE
)
```text

Read state is tracked per message per session. A message is considered read for
an agent if any matching `session_id` or `agent_id` has a record. This means
read state persists across session restarts for the same agent.

### Indexes

Optimized for common query patterns:

- `idx_messages_time` -- time-based sorting
- `idx_messages_agent` -- author filtering
- `idx_messages_session` -- session filtering
- `idx_scopes_lookup` -- scope filtering
- `idx_refs_lookup` -- ref filtering (including reply_to references)
- `idx_edits_message` -- edit history lookup by message and timestamp
- `idx_message_reads_agent` -- read state by agent
- `idx_message_reads_message` -- read state by message

## MCP Server Integration

The MCP server (`thrum mcp serve`) provides native messaging tools for AI agents
running in Claude Code or similar environments. It exposes 11 MCP tools
organized into two categories:

**Core messaging (5 tools):**

| MCP Tool            | Description                                                                        |
| ------------------- | ---------------------------------------------------------------------------------- |
| `send_message`      | Send a message to `@role` or agent name                                            |
| `check_messages`    | Poll for unread messages mentioning this agent, auto-marks read                    |
| `wait_for_message`  | Block until a message arrives via WebSocket push or timeout (max 600s)             |
| `list_agents`       | List registered agents with active/offline status                                  |
| `broadcast_message` | Send to all agents (convenience wrapper around `send_message` with `to=@everyone`) |

**Group management (6 tools):**

| MCP Tool              | Description                                                      |
| --------------------- | ---------------------------------------------------------------- |
| `create_group`        | Create a named messaging group                                   |
| `delete_group`        | Delete a messaging group                                         |
| `add_group_member`    | Add an agent or role as a member of a group                      |
| `remove_group_member` | Remove a member from a group                                     |
| `list_groups`         | List all messaging groups                                        |
| `get_group`           | Get group details including members (expand=true resolves roles) |

MCP tools use the same underlying RPC methods (`message.send`, `message.list`,
`message.markRead`) but add convenience features like `@role` addressing and
real-time WebSocket push notifications.

## Agent Identity

Agents are identified by name using identity files stored at
`.thrum/identities/{name}.json`. Identity is resolved in this priority order:

1. `THRUM_NAME` environment variable (selects which identity file to load)
2. `THRUM_ROLE` and `THRUM_MODULE` environment variables
3. CLI flags (`--role`, `--module`, `--name`)
4. Single identity file auto-selection (solo-agent worktrees)

Agent names must match `[a-z0-9_]+`. Reserved names: `daemon`, `system`,
`thrum`, `all`, `broadcast`.

For multi-agent worktrees, each agent gets its own identity file and JSONL
shard.

## See Also

- RPC API Reference: `docs/rpc-api.md`
- Daemon Architecture: `docs/daemon.md`
- Development Guide: `docs/development.md`</span></code></pre>

    </div>
    <p style="margin-top:2rem"><a href="../docs.html#messaging.html">&larr; View in documentation</a></p>
  </main>
  <script>
    // Redirect browsers to the SPA for full navigation experience.
    // Crawlers (which don't execute JS) will index the static content above.
    if (window.location.search.indexOf('nospa') === -1) {
      window.location.replace('../docs.html#messaging.html');
    }
  </script>
</body>
</html>