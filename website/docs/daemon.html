<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daemon Architecture — Thrum</title>
  <meta name="description" content="Background service managing state, RPC handlers, sync loop, WebSocket server, and embedded UI on single port">
  <!-- Open Graph -->
  <meta property="og:type" content="article">
  <meta property="og:title" content="Daemon Architecture — Thrum">
  <meta property="og:description" content="Background service managing state, RPC handlers, sync loop, WebSocket server, and embedded UI on single port">
  <meta property="og:url" content="https://leonletto.github.io/thrum/docs/daemon.html">
  <meta property="og:site_name" content="Thrum">
  <meta property="og:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Daemon Architecture — Thrum">
  <meta name="twitter:description" content="Background service managing state, RPC handlers, sync loop, WebSocket server, and embedded UI on single port">
  <meta name="twitter:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <!-- Canonical: SPA is the primary URL -->
  <link rel="canonical" href="https://leonletto.github.io/thrum/docs.html#daemon.html">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x26A1;</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/theme.css">
  <link rel="stylesheet" href="../css/docs.css">
  <script>
    (function(){var t=localStorage.getItem('thrum-theme');if(t){document.documentElement.setAttribute('data-theme',t)}else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:light)').matches){document.documentElement.setAttribute('data-theme','light')}else{document.documentElement.setAttribute('data-theme','dark')}})();
  </script>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <nav class="header-nav">
        <a href="../index.html" class="logo">
          <span class="logo-glyph">&gt;_</span>
          <span class="logo-text">thrum</span>
        </a>
        <div class="nav-links">
          <a href="../index.html" class="nav-link">Home</a>
          <a href="../docs.html" class="nav-link nav-link-active">Docs</a>
          <a href="../about.html" class="nav-link">About</a>
          <a href="https://github.com/leonletto/thrum" class="nav-link nav-link-external" target="_blank" rel="noopener">GitHub</a>
        </div>
      </nav>
    </div>
  </header>
  <main class="docs-content" style="max-width:48rem;margin:2rem auto;padding:0 1.5rem">
    <div class="docs-content-inner">
<h2>Thrum Daemon Architecture</h2>
<blockquote>
<p><strong>See also:</strong> <a href="overview.html">System Overview</a> for how the daemon fits into the<br>larger Thrum ecosystem.</p>
</blockquote>
<h2>Overview</h2>
<p>The Thrum daemon is a background service that manages the <code>.thrum/</code> directory<br>and the sync worktree (at <code>.git/thrum-sync/a-sync/</code> on the <code>a-sync</code> orphan<br>branch), handles client connections via Unix socket and WebSocket, serves the<br>embedded web UI, and coordinates message synchronization with Git. It serves as<br>the central coordinator for all Thrum clients (CLI, Web UI, and MCP server).</p>
<h2>Architecture</h2>
<pre><code class="language-go hljs">┌─────────────┐  ┌──────────────┐  ┌──────────────┐
│   CLI       │  │   Web UI     │  │  MCP Server  │
│  (client)   │  │  (browser)   │  │ (thrum mcp)  │
└──────┬──────┘  └──────┬───────┘  └──────┬───────┘
       │ Unix socket     │ WebSocket       │ Unix socket
       │ JSON-RPC <span class="hljs-number">2.0</span>    │ JSON-RPC <span class="hljs-number">2.0</span>    │ JSON-RPC <span class="hljs-number">2.0</span>
       ▼                 ▼                 ▼
┌──────────────────────────────────────────────────┐
│                     Daemon                        │
├──────────────────────────────────────────────────┤
│ • Unix Socket Server    (.thrum/<span class="hljs-keyword">var</span>/thrum.sock)   │
│ • WebSocket + SPA       (localhost:<span class="hljs-number">9999</span>)           │
│ • Lifecycle (flock, JSON PID, <span class="hljs-keyword">defer</span> cleanup)       │
│ • RPC Handlers          (agent, message, sync)     │
│ • Sync Loop             (<span class="hljs-number">60</span>s interval)             │
│ • Stale Context Cleanup                            │
└──────────────────┬───────────────────────────────┘
                   │
                   ▼
  .git/thrum-sync/a-sync/    (worktree on a-sync branch)
  ├── events.jsonl           (agent lifecycle events)
  └── messages/              (per-agent message logs)
      └── {agent_name}.jsonl

  .thrum/
  ├── <span class="hljs-keyword">var</span>/
  │   ├── thrum.sock         (Unix socket)
  │   ├── thrum.pid          (JSON PID file)
  │   ├── thrum.lock         (flock <span class="hljs-keyword">for</span> SIGKILL resilience)
  │   ├── ws.port            (WebSocket port number)
  │   ├── sync.lock          (sync loop file lock)
  │   └── messages.db        (SQLite projection)
  ├── identities/            (per-worktree agent identity files)
  │   └── {agent_name}.json
  └── redirect               (feature worktrees only)
<span class="hljs-string">``</span><span class="hljs-string">`go

## Components

### 1. Unix Socket Server

**Location:** `</span>internal/daemon/server.<span class="hljs-keyword">go</span><span class="hljs-string">`

The socket server implements JSON-RPC 2.0 protocol for client-daemon
communication.

**Key features:**

- Listens on `</span>.thrum/<span class="hljs-keyword">var</span>/thrum.sock<span class="hljs-string">`
- Accepts multiple concurrent connections
- Dispatches requests to registered handlers
- Handles JSON-RPC 2.0 protocol correctly
- Sets socket permissions to 0600 (owner-only)
- Detects and removes stale sockets from dead daemons

**JSON-RPC 2.0 format:**

`</span><span class="hljs-string">``</span>json
<span class="hljs-comment">// Request</span>
{
  <span class="hljs-string">&quot;jsonrpc&quot;</span>: <span class="hljs-string">&quot;2.0&quot;</span>,
  <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;health&quot;</span>,
  <span class="hljs-string">&quot;params&quot;</span>: {},
  <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>
}

<span class="hljs-comment">// Response (success)</span>
{
  <span class="hljs-string">&quot;jsonrpc&quot;</span>: <span class="hljs-string">&quot;2.0&quot;</span>,
  <span class="hljs-string">&quot;result&quot;</span>: {<span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;ok&quot;</span>},
  <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>
}

<span class="hljs-comment">// Response (error)</span>
{
  <span class="hljs-string">&quot;jsonrpc&quot;</span>: <span class="hljs-string">&quot;2.0&quot;</span>,
  <span class="hljs-string">&quot;error&quot;</span>: {
    <span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-number">-32601</span>,
    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Method not found&quot;</span>
  },
  <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>
}
<span class="hljs-string">``</span><span class="hljs-string">`go

### 2. PID File Management

**Location:** `</span>internal/daemon/pidfile.<span class="hljs-keyword">go</span><span class="hljs-string">`

Manages process ID file with JSON metadata for daemon lifecycle.

**JSON PID format:**

`</span><span class="hljs-string">``</span>json
{
  <span class="hljs-string">&quot;pid&quot;</span>: <span class="hljs-number">12345</span>,
  <span class="hljs-string">&quot;repo_path&quot;</span>: <span class="hljs-string">&quot;/Users/leon/dev/myproject&quot;</span>,
  <span class="hljs-string">&quot;started_at&quot;</span>: <span class="hljs-string">&quot;2026-02-08T12:00:00Z&quot;</span>,
  <span class="hljs-string">&quot;socket_path&quot;</span>: <span class="hljs-string">&quot;/Users/leon/dev/myproject/.thrum/var/thrum.sock&quot;</span>
}
<span class="hljs-string">``</span><span class="hljs-string">`go

**Functions:**

- `</span>WritePIDFileJSON(path, info)<span class="hljs-string">` - Write JSON PID with metadata
- `</span>ReadPIDFileJSON(path)<span class="hljs-string">` - Read JSON PID (falls back to plain integer format
  for backward compatibility)
- `</span>CheckPIDFileJSON(path)<span class="hljs-string">` - Check if process is running and return PID info
- `</span>ValidatePIDRepo(info, repoPath)<span class="hljs-string">` - Verify PID belongs to the same repository
- `</span>RemovePIDFile(path)<span class="hljs-string">` - Clean up PID file

**PID file location:** `</span>.thrum/<span class="hljs-keyword">var</span>/thrum.pid<span class="hljs-string">`

**Features:**

- JSON format with repository affinity (repo path, socket path, start time)
- Backward-compatible reader supports plain integer format
- Pre-startup duplicate detection prevents multiple daemons per repo
- Automatic cleanup on shutdown

### 3. File Locking (flock)

**Location:** `</span>internal/daemon/flock.<span class="hljs-keyword">go</span><span class="hljs-string">`, `</span>internal/daemon/flock_unix.<span class="hljs-keyword">go</span><span class="hljs-string">`,
`</span>internal/daemon/flock_other.<span class="hljs-keyword">go</span><span class="hljs-string">`

Provides SIGKILL-resilient daemon process detection using OS-level file locking.

**How it works:**

- Uses `</span>syscall.Flock()<span class="hljs-string">` with `</span>LOCK_EX|LOCK_NB<span class="hljs-string">` for exclusive non-blocking lock
- Lock is held on `</span>.thrum/<span class="hljs-keyword">var</span>/thrum.lock<span class="hljs-string">` for the daemon&#x27;s entire lifetime
- The OS automatically releases the lock when the process dies, even on SIGKILL
- Non-unix platforms have no-op stubs (lock detection falls back to PID file
  only)

**Key functions:**

- `</span>AcquireLock(path)<span class="hljs-string">` - Try to acquire exclusive lock, returns error if held
- `</span>FileLock.Release()<span class="hljs-string">` - Release lock and remove lock file (idempotent,
  nil-safe)
- `</span>IsLocked(path)<span class="hljs-string">` - Check if lock is currently held (unix only)

### 4. Lifecycle Management

**Location:** `</span>internal/daemon/lifecycle.<span class="hljs-keyword">go</span><span class="hljs-string">`

Manages daemon startup, signal handling, and graceful shutdown with
defense-in-depth cleanup.

**Startup sequence (`</span>Lifecycle.Run()<span class="hljs-string">`):**

1. Acquire file lock (flock) for SIGKILL resilience
2. Pre-startup validation: check for existing daemon (repo affinity)
3. Write JSON PID file with metadata
4. Register defer safety net (catches panics, early returns)
5. Start Unix socket server
6. Start WebSocket server (if configured), write port file
7. Start signal handler goroutine
8. Wait for shutdown signal

**Signal handling:**

- `</span>SIGTERM<span class="hljs-string">` - Graceful shutdown
- `</span>SIGINT<span class="hljs-string">` - Graceful shutdown
- `</span>SIGHUP<span class="hljs-string">` - Reserved for config reload (future)

**Shutdown sequence:**

1. Stop WebSocket server, remove port file
2. Stop Unix socket server (waits up to 5s for in-flight requests), remove
   socket
3. Remove PID file
4. Release file lock

**Defer cleanup safety net:**

- A `</span><span class="hljs-keyword">defer</span><span class="hljs-string">` block in `</span>Run()<span class="hljs-string">` catches any exit path (panic, early return,
  unexpected error)
- Uses `</span>atomic.Bool<span class="hljs-string">` to prevent double cleanup with the normal shutdown path
- All cleanup operations are idempotent (safe to run twice)

### 5. RPC Handlers

**Location:** `</span>internal/daemon/rpc/<span class="hljs-string">`

RPC method handlers implement daemon functionality. All handlers are registered
on both the Unix socket and WebSocket servers unless noted.

**Registered handlers:**

| Category         | Methods                                                                                                     | Notes                                              |
| ---------------- | ----------------------------------------------------------------------------------------------------------- | -------------------------------------------------- |
| **Health**       | `</span>health<span class="hljs-string">`                                                                                                    |                                                    |
| **Agent**        | `</span>agent.register<span class="hljs-string">`, `</span>agent.list<span class="hljs-string">`, `</span>agent.whoami<span class="hljs-string">`, `</span>agent.listContext<span class="hljs-string">`, `</span>agent.<span class="hljs-built_in">delete</span><span class="hljs-string">`, `</span>agent.cleanup<span class="hljs-string">`        | `</span><span class="hljs-built_in">delete</span><span class="hljs-string">` and `</span>cleanup<span class="hljs-string">` are Unix socket only        |
| **Session**      | `</span>session.start<span class="hljs-string">`, `</span>session.end<span class="hljs-string">`, `</span>session.list<span class="hljs-string">`, `</span>session.heartbeat<span class="hljs-string">`, `</span>session.setIntent<span class="hljs-string">`, `</span>session.setTask<span class="hljs-string">` |                                                    |
| **Message**      | `</span>message.send<span class="hljs-string">`, `</span>message.get<span class="hljs-string">`, `</span>message.list<span class="hljs-string">`, `</span>message.edit<span class="hljs-string">`, `</span>message.<span class="hljs-built_in">delete</span><span class="hljs-string">`, `</span>message.markRead<span class="hljs-string">`         |                                                    |
| **Subscription** | `</span>subscribe<span class="hljs-string">`, `</span>unsubscribe<span class="hljs-string">`, `</span>subscriptions.list<span class="hljs-string">`                                                            | Subscriptions auto-cleanup on session end (v0.4.3) |
| **Sync**         | `</span>sync.force<span class="hljs-string">`, `</span>sync.status<span class="hljs-string">`                                                                                 | Both Unix socket and WebSocket                     |
| **User**         | `</span>user.register<span class="hljs-string">`, `</span>user.identify<span class="hljs-string">`                                                                            | `</span>user.register<span class="hljs-string">` restricted to WebSocket transport  |

See [RPC API Reference](rpc-api.md) for full documentation.

**Health check response:**

`</span><span class="hljs-string">``</span>json
{
  <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;ok&quot;</span>,
  <span class="hljs-string">&quot;uptime_ms&quot;</span>: <span class="hljs-number">12345</span>,
  <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;1.0.0&quot;</span>,
  <span class="hljs-string">&quot;repo_id&quot;</span>: <span class="hljs-string">&quot;abc123&quot;</span>,
  <span class="hljs-string">&quot;sync_state&quot;</span>: <span class="hljs-string">&quot;synced&quot;</span>
}
<span class="hljs-string">``</span><span class="hljs-string">`text

### 6. WebSocket Server and Embedded SPA

**Location:** `</span>internal/websocket/<span class="hljs-string">`, `</span>internal/web/<span class="hljs-string">`

The WebSocket server provides real-time communication and serves the embedded
web UI on a single port.

**Key features:**

- Full JSON-RPC 2.0 support (same protocol as Unix socket)
- Real-time push notifications via subscriptions
- Client registry for tracking connections by session_id
- Default port: 9999 (configurable via `</span>THRUM_WS_PORT<span class="hljs-string">`)
- Embedded React SPA served from the same port

**Route layout (with UI):**

- `</span>/ws<span class="hljs-string">` - WebSocket upgrade handler
- `</span>/assets/<span class="hljs-string">` - Static file server (with immutable cache headers)
- `</span>/<span class="hljs-string">` - SPA fallback (serves `</span>index.html<span class="hljs-string">` for all other paths)

**Route layout (without UI):**

- `</span>/<span class="hljs-string">` - WebSocket handler (backward compatible)

**Embedded SPA (`</span>internal/web/embed.<span class="hljs-keyword">go</span><span class="hljs-string">`):**

- Uses `</span><span class="hljs-comment">//go:embed all:dist` to bundle the React UI into the Go binary</span>
- Build pipeline: <span class="hljs-string">`pnpm build`</span> -&gt; <span class="hljs-built_in">copy</span> to <span class="hljs-string">`internal/web/dist/`</span> -&gt; <span class="hljs-string">`go build`</span>
- Dev mode: set <span class="hljs-string">`THRUM_UI_DEV=./ui/packages/web-app/dist`</span> to serve from disk

**Browser auto-registration:**

- <span class="hljs-string">`user.identify`</span> RPC extracts git config <span class="hljs-string">`user.name`</span> and <span class="hljs-string">`user.email`</span> <span class="hljs-keyword">for</span> the
  repo
- <span class="hljs-string">`user.register`</span> RPC (WebSocket-only) registers browser users with
  <span class="hljs-string">`kind=&quot;user&quot;`</span>
- Idempotent: returns existing user info <span class="hljs-keyword">if</span> already registered

**Components:**

- <span class="hljs-string">`server.go`</span> - HTTP server with mux routing, WebSocket upgrade, SPA handler
- <span class="hljs-string">`connection.go`</span> - Per-connection read/write loops
- <span class="hljs-string">`handler.go`</span> - Handler registry <span class="hljs-keyword">interface</span>
- <span class="hljs-string">`client_registry.go`</span> - Tracks connected clients by session_id

### <span class="hljs-number">7.</span> Sync Loop Integration

**Location:** <span class="hljs-string">`internal/sync/loop.go`</span>, <span class="hljs-string">`internal/daemon/rpc/sync_rpc.go`</span>

The sync loop runs as a goroutine within the daemon, periodically synchronizing
JSONL data via Git.

**Key features:**

- Default interval: <span class="hljs-number">60</span> seconds (configurable via <span class="hljs-string">`--sync-interval`</span> flag)
- Sync worktree at <span class="hljs-string">`.git/thrum-sync/a-sync/`</span> (uses <span class="hljs-string">`git-common-dir`</span> <span class="hljs-keyword">for</span> nested
  worktree support)
- File lock (<span class="hljs-string">`sync.lock`</span>) prevents concurrent sync operations
- Manual sync via <span class="hljs-string">`sync.force`</span> RPC method

**Sync cycle:**

<span class="hljs-number">1.</span> Acquire sync lock (<span class="hljs-string">`.thrum/var/sync.lock`</span>)
<span class="hljs-number">2.</span> Fetch remote (<span class="hljs-string">`git fetch`</span> in sync worktree)
<span class="hljs-number">3.</span> Merge all JSONL files (<span class="hljs-string">`events.jsonl`</span> + <span class="hljs-string">`messages/*.jsonl`</span>) with dedup
<span class="hljs-number">4.</span> Apply <span class="hljs-built_in">new</span> events to SQLite projection
<span class="hljs-number">5.</span> Push merged changes back to remote
<span class="hljs-number">6.</span> Release lock

**RPC methods:**

- <span class="hljs-string">`sync.force`</span> - Trigger manual sync (non-blocking), returns current status
- <span class="hljs-string">`sync.status`</span> - Return current sync state (<span class="hljs-string">`stopped`</span>, <span class="hljs-string">`idle`</span>, <span class="hljs-string">`synced`</span>,
  <span class="hljs-string">`error`</span>)

### <span class="hljs-number">8.</span> Agent Work Context (Live Git State)

**Location:** <span class="hljs-string">`internal/gitctx/`</span>, <span class="hljs-string">`internal/daemon/cleanup/`</span>

Tracks what each agent is working on in <span class="hljs-built_in">real</span>-time by extracting Git state on
heartbeat.

**<span class="hljs-string">`internal/gitctx/`</span> <span class="hljs-keyword">package</span>:**

Extracts git-derived work context from a worktree path:

- <span class="hljs-string">`WorkContext`</span> <span class="hljs-keyword">struct</span>: branch, worktree path, unmerged commits, uncommitted
  files, changed files, extraction timestamp
- <span class="hljs-string">`CommitSummary`</span> <span class="hljs-keyword">struct</span>: SHA, message (first line), list of changed files
- <span class="hljs-string">`ExtractWorkContext(worktreePath)`</span> - Runs git commands to gather state (~<span class="hljs-number">80</span>ms)
  - <span class="hljs-string">`git branch --show-current`</span> - Current branch
  - <span class="hljs-string">`git log --oneline base..HEAD`</span> - Unmerged commits vs origin/main or
    origin/master
  - <span class="hljs-string">`git diff --name-only base...HEAD`</span> - Changed files vs base branch
  - <span class="hljs-string">`git status --porcelain`</span> - Uncommitted/staged files

**RPC methods:**

- <span class="hljs-string">`session.heartbeat`</span> - Extracts and stores git context automatically
- <span class="hljs-string">`session.setIntent`</span> - Agent sets work intent (free text)
- <span class="hljs-string">`session.setTask`</span> - Agent sets current task description
- <span class="hljs-string">`agent.listContext`</span> - Query all agent work contexts (filterable by agent_id)

**Cleanup logic (<span class="hljs-string">`internal/daemon/cleanup/`</span>):**

- <span class="hljs-string">`CleanupStaleContexts(db, now)`</span> - Removes stale work contexts from SQLite
  - Rule <span class="hljs-number">1</span>: Contexts &gt; <span class="hljs-number">24</span>h old with no unmerged commits
  - Rule <span class="hljs-number">2</span>: Contexts from sessions ended &gt; <span class="hljs-number">7</span> days ago
  - Rule <span class="hljs-number">3</span>: Contexts where git data was never collected
- <span class="hljs-string">`FilterStaleContexts(contexts, now)`</span> - In-memory filter (same rules, <span class="hljs-keyword">for</span> sync)
- Runs at daemon startup and before sync

## Local-Only Mode

When your repository is public, the daemon<span class="hljs-string">&#x27;s sync loop pushes the `a-sync`
branch to `origin`, which would expose private agent messages. Local-only mode
disables all remote git operations while keeping everything else working.

### Enable local-only mode

```bash
# Via CLI flag
thrum daemon start --local

# Via environment variable
THRUM_LOCAL=1 thrum daemon start
```text

The setting persists in `.thrum/config.json`:

```json
{ &quot;local_only&quot;: true }
```text

**Priority order:** CLI flag &gt; environment variable &gt; config file &gt; default
(`true` via `thrum init`).

### What changes in local-only mode

| Component                 | Normal mode | Local-only mode |
| ------------------------- | ----------- | --------------- |
| Messaging                 | Works       | Works           |
| Sessions                  | Works       | Works           |
| SQLite projection         | Works       | Works           |
| WebSocket / MCP           | Works       | Works           |
| `git push origin a-sync`  | Every 60s   | **Skipped**     |
| `git fetch origin a-sync` | Every 60s   | **Skipped**     |
| Remote branch setup       | Automatic   | **Skipped**     |

### Check if local-only mode is active

```bash
thrum sync status
# Shows &quot;Mode: local-only&quot; or &quot;Mode: normal&quot;

thrum sync force
# Shows &quot;local-only (remote sync disabled)&quot; when active
```go

### 9. State Management

**Location:** `internal/daemon/state/`

The `State` struct manages the daemon&#x27;</span>s persistent state: JSONL event logs and
SQLite projection.

**Constructor:** <span class="hljs-string">`NewState(thrumDir, syncDir, repoID)`</span> splits paths:

- <span class="hljs-string">`thrumDir`</span> (<span class="hljs-string">`/path/to/.thrum/`</span>) - Runtime files: <span class="hljs-string">`var/messages.db`</span>,
  <span class="hljs-string">`var/thrum.sock`</span>, etc.
- <span class="hljs-string">`syncDir`</span> (<span class="hljs-string">`/path/to/.git/thrum-sync/a-sync/`</span>) - JSONL data: <span class="hljs-string">`events.jsonl`</span>,
  <span class="hljs-string">`messages/*.jsonl`</span>

**Event routing (per-agent JSONL sharding):**

- <span class="hljs-string">`message.*`</span> events -&gt; <span class="hljs-string">`messages/{agent_name}.jsonl`</span> (per-agent file, keyed by
  message author)
- All other events -&gt; <span class="hljs-string">`events.jsonl`</span> (agent lifecycle, threads, sessions)
- <span class="hljs-string">`WriteEvent()`</span> auto-generates <span class="hljs-string">`event_id`</span> (ULID) and <span class="hljs-string">`v`</span> (version) fields

**On initialization:**

<span class="hljs-number">1.</span> Opens/migrates SQLite database
<span class="hljs-number">2.</span> Runs JSONL sharding migration (monolithic <span class="hljs-string">`messages.jsonl`</span> -&gt; per-agent
   files) <span class="hljs-keyword">if</span> needed
<span class="hljs-number">3.</span> Backfills <span class="hljs-string">`event_id`</span> <span class="hljs-keyword">for</span> events that lack it
<span class="hljs-number">4.</span> Creates writers <span class="hljs-keyword">for</span> <span class="hljs-string">`events.jsonl`</span> and lazy-creates per-agent message writers

**Exported methods:**

- <span class="hljs-string">`WriteEvent(event)`</span> - Write to JSONL + apply to SQLite projection
- <span class="hljs-string">`DB()`</span> - Returns SQLite connection <span class="hljs-keyword">for</span> queries
- <span class="hljs-string">`RepoID()`</span>, <span class="hljs-string">`RepoPath()`</span>, <span class="hljs-string">`SyncDir()`</span> - Path accessors
- <span class="hljs-string">`Lock()/Unlock()`</span>, <span class="hljs-string">`RLock()/RUnlock()`</span> - Read/write mutex <span class="hljs-keyword">for</span> agent/session
  operations
- <span class="hljs-string">`Projector()`</span> - Returns the projection engine
- <span class="hljs-string">`Close()`</span> - Closes all JSONL writers and SQLite connection

### <span class="hljs-number">10.</span> Timeout Enforcement (v0<span class="hljs-number">.4</span><span class="hljs-number">.3</span>)

All I/O paths enforce timeouts to prevent indefinite hangs:

| Path                | Timeout        | Implementation      |
| ------------------- | -------------- | ------------------- |
| CLI dial            | <span class="hljs-number">5</span>s             | net.DialTimeout     |
| RPC call            | <span class="hljs-number">10</span>s            | context.WithTimeout |
| Server per-request  | <span class="hljs-number">10</span>s            | http.TimeoutHandler |
| WebSocket handshake | <span class="hljs-number">10</span>s            | websocket.Upgrader  |
| Git commands        | <span class="hljs-number">5</span>s/<span class="hljs-number">10</span>s         | safecmd wrapper     |
| SQLite queries      | context-scoped | safedb wrapper      |

The <span class="hljs-string">`safedb`</span> and <span class="hljs-string">`safecmd`</span> packages wrap all database and command operations
with context-aware timeouts. All DB operations <span class="hljs-keyword">go</span> through <span class="hljs-string">`safedb`</span> wrappers and
all command executions <span class="hljs-keyword">go</span> through <span class="hljs-string">`safecmd`</span> wrappers <span class="hljs-keyword">for</span> context-aware timeout
enforcement.

Lock scope has been reduced in v0<span class="hljs-number">.4</span><span class="hljs-number">.3</span> — no mutex is held during I/O, git, or
WebSocket dispatch operations.

### <span class="hljs-number">11.</span> Client Library

**Location:** <span class="hljs-string">`internal/daemon/client.go`</span>

Client library <span class="hljs-keyword">for</span> connecting to the daemon.

**Key functions:**

- <span class="hljs-string">`NewClient(socketPath)`</span> - Connect to daemon
- <span class="hljs-string">`Call(method, params)`</span> - Make RPC call
- <span class="hljs-string">`EnsureDaemon(repoPath)`</span> - Auto-start daemon <span class="hljs-keyword">if</span> needed

**Auto-start logic:**

<span class="hljs-number">1.</span> Try to connect to existing daemon
<span class="hljs-number">2.</span> If not running, start daemon in background
<span class="hljs-number">3.</span> Wait <span class="hljs-keyword">for</span> socket to become available (<span class="hljs-number">10</span>s timeout)
<span class="hljs-number">4.</span> Return connected client

## Daemon Lifecycle

For setup instructions, see [Quickstart Guide](quickstart.md).

### Daemon States

<span class="hljs-string">``</span><span class="hljs-string">`text
 NOT RUNNING
     │
     ▼
 STARTING ────────┐
     │            │ (error)
     ▼            ▼
 RUNNING ──────▶ ERROR
     │
     ▼
 SHUTTING DOWN
     │
     ▼
 STOPPED
`</span><span class="hljs-string">``</span>text

### Checking Status

<span class="hljs-string">``</span><span class="hljs-string">`bash
# Check if daemon is running (shows repo path from JSON PID)
thrum daemon status

# Health check via RPC
thrum daemon health
`</span><span class="hljs-string">``</span>text

### Stopping the Daemon

<span class="hljs-string">``</span><span class="hljs-string">`bash
# Graceful stop
thrum daemon stop

# Force stop (if graceful fails)
kill &lt;pid&gt;
# flock auto-released by OS; PID file cleaned up on next start
`</span><span class="hljs-string">``</span>text

## Directory Structure

<span class="hljs-string">``</span><span class="hljs-string">`go
.git/thrum-sync/a-sync/          # Sync worktree on a-sync orphan branch
├── events.jsonl                # Agent lifecycle events (source of truth)
└── messages/                   # Per-agent message logs (source of truth)
    └── {agent_name}.jsonl

.thrum/                         # Gitignored entirely
├── var/                        # Runtime files
│   ├── thrum.sock              # Unix socket for CLI/RPC
│   ├── thrum.pid               # JSON PID file (PID, RepoPath, StartedAt, SocketPath)
│   ├── thrum.lock              # flock file for SIGKILL resilience
│   ├── ws.port                 # WebSocket port number
│   ├── sync.lock               # Sync loop file lock
│   └── messages.db             # SQLite projection (query cache)
├── identities/                 # Per-worktree agent identity files
│   └── {agent_name}.json
└── redirect                    # (feature worktrees only) points to main .thrum/
`</span><span class="hljs-string">``</span><span class="hljs-keyword">go</span>

**Key files:**

- <span class="hljs-string">`.git/thrum-sync/a-sync/events.jsonl`</span> and <span class="hljs-string">`messages/*.jsonl`</span>: Append-only
  JSONL event logs on the <span class="hljs-string">`a-sync`</span> branch, synced via the worktree. Per-agent
  sharding means each agent<span class="hljs-string">&#x27;s messages go to a separate JSONL file.
- `var/messages.db`: SQLite database rebuilt from JSONL, stores all queryable
  state including `agent_work_contexts` table
- `var/thrum.pid`: JSON format with PID, repo path, start time, and socket path.
  Enables repo-affinity checks to prevent conflicts.
- `var/thrum.lock`: Held via `flock()` for the daemon&#x27;</span>s lifetime. OS releases on
  process death (even SIGKILL).
- <span class="hljs-string">`var/ws.port`</span>: Contains the WebSocket port <span class="hljs-keyword">for</span> UI clients to discover
- <span class="hljs-string">`redirect`</span>: Present only in feature worktrees; points to the main worktree<span class="hljs-string">&#x27;s
  `.thrum/` so all worktrees share one daemon

## Development

### Running Tests

```bash
# All daemon tests
go test ./internal/daemon/...

# With coverage
go test -cover ./internal/daemon/...

# With race detector
go test -race ./internal/daemon/...
```go

### Adding New RPC Methods

1. Create handler in `internal/daemon/rpc/`
2. Implement `Handle(ctx, params)` method
3. Register in daemon startup (`cmd/thrum/main.go`)
4. Add tests in corresponding `_test.go` file

Example:

```go
// internal/daemon/rpc/mymethod.go
type MyMethodHandler struct {
    // dependencies
}

func (h *MyMethodHandler) Handle(ctx context.Context, params json.RawMessage) (any, error) {
    // implementation
    return response, nil
}

// Register in daemon (cmd/thrum/main.go)
server.RegisterHandler(&quot;mymethod&quot;, myMethodHandler.Handle)
```text

## Troubleshooting

### Daemon won&#x27;</span>t start

Check:

<span class="hljs-number">1.</span> Is <span class="hljs-string">`.thrum/var/`</span> directory writable?
<span class="hljs-number">2.</span> Is socket path too long? (Unix sockets have <span class="hljs-number">104</span>-char limit)
<span class="hljs-number">3.</span> Is another daemon already running?

<span class="hljs-string">``</span><span class="hljs-string">`bash
# Check JSON PID file
cat .thrum/var/thrum.pid

# Check if flock is held
# (if daemon died via SIGKILL, flock is released but PID file may remain)

# Check if process is running
ps aux | grep thrum

# Remove stale PID file (only if process is definitely not running)
rm .thrum/var/thrum.pid
`</span><span class="hljs-string">``</span><span class="hljs-keyword">go</span>

### Socket connection errors

Check:

<span class="hljs-number">1.</span> Is daemon running?
<span class="hljs-number">2.</span> Socket permissions correct (should be <span class="hljs-number">0600</span>)
<span class="hljs-number">3.</span> Socket file exists?

<span class="hljs-string">``</span><span class="hljs-string">`bash
# Check socket
ls -l .thrum/var/thrum.sock

# Test connection
echo &#x27;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;health&quot;,&quot;id&quot;:1}&#x27; | nc -U .thrum/var/thrum.sock
`</span><span class="hljs-string">``</span>text

### Graceful shutdown hangs

The daemon waits up to <span class="hljs-number">5</span> seconds <span class="hljs-keyword">for</span> in-flight requests to complete. If shutdown
hangs longer:

<span class="hljs-string">``</span><span class="hljs-string">`bash
# Send SIGKILL (flock auto-released by OS)
kill -9 &lt;pid&gt;

# Stale files are cleaned up automatically on next daemon start
# Manual cleanup if needed:
rm .thrum/var/thrum.sock
rm .thrum/var/thrum.pid
`</span><span class="hljs-string">``</span>text

## Implemented Features

| Epic            | Feature                                                     | Status   |
| --------------- | ----------------------------------------------------------- | -------- |
| Epic <span class="hljs-number">2</span>          | Daemon core (Unix socket, JSON-RPC)                         | Complete |
| Epic <span class="hljs-number">3</span>          | Agent &amp; session management                                  | Complete |
| Epic <span class="hljs-number">4</span>          | Message send/receive                                        | Complete |
| Epic <span class="hljs-number">5</span>          | Git sync protocol                                           | Complete |
| Epic <span class="hljs-number">6</span>          | Subscription &amp; notifications                                | Complete |
| Epic <span class="hljs-number">8</span>          | WebSocket server                                            | Complete |
| Epic F          | Embedded SPA (single port)                                  | Complete |
| Epic <span class="hljs-number">21</span>         | Agent Work Context (live git state)                         | Complete |
| DLH             | Daemon Lifecycle Hardening (flock, JSON PID, <span class="hljs-keyword">defer</span> cleanup) | Complete |
| MCP             | MCP Server (<span class="hljs-string">`thrum mcp serve`</span>)                              | Complete |
| JSONL Sharding  | Per-agent JSONL files, event_id, naming, cleanup            | Complete |
| Sync WT         | Sync worktree at <span class="hljs-string">`.git/thrum-sync/a-sync/`</span>                  | Complete |
| Agent Naming    | Human-readable agent names (<span class="hljs-string">`--name`</span>, <span class="hljs-string">`THRUM_NAME`</span>)         | Complete |
| Agent Cleanup   | <span class="hljs-string">`agent.delete`</span>, <span class="hljs-string">`agent.cleanup`</span> (orphan detection)          | Complete |
| Browser Auth    | Browser auto-registration via git config                    | Complete |
| Local-Only Mode | Disable remote sync <span class="hljs-keyword">for</span> public repos                        | Complete |

## References

- Design document: <span class="hljs-string">`dev-docs/2026-02-03-thrum-design.md`</span>
- RPC API reference: <span class="hljs-string">`docs/rpc-api.md`</span>
- Development guide: <span class="hljs-string">`docs/development.md`</span></code></pre>

    </div>
    <p style="margin-top:2rem"><a href="../docs.html#daemon.html">&larr; View in documentation</a></p>
  </main>
  <script>
    // Redirect browsers to the SPA for full navigation experience.
    // Crawlers (which don't execute JS) will index the static content above.
    if (window.location.search.indexOf('nospa') === -1) {
      window.location.replace('../docs.html#daemon.html');
    }
  </script>
</body>
</html>