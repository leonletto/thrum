<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Context Management — Thrum</title>
  <meta name="description" content="Per-agent context storage for persisting volatile project state across sessions and machines">
  <!-- Open Graph -->
  <meta property="og:type" content="article">
  <meta property="og:title" content="Agent Context Management — Thrum">
  <meta property="og:description" content="Per-agent context storage for persisting volatile project state across sessions and machines">
  <meta property="og:url" content="https://leonletto.github.io/thrum/docs/context.html">
  <meta property="og:site_name" content="Thrum">
  <meta property="og:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Agent Context Management — Thrum">
  <meta name="twitter:description" content="Per-agent context storage for persisting volatile project state across sessions and machines">
  <meta name="twitter:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <!-- Canonical: SPA is the primary URL -->
  <link rel="canonical" href="https://leonletto.github.io/thrum/docs.html#context.html">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x26A1;</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/theme.css">
  <link rel="stylesheet" href="../css/docs.css">
  <script>
    (function(){var t=localStorage.getItem('thrum-theme');if(t){document.documentElement.setAttribute('data-theme',t)}else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:light)').matches){document.documentElement.setAttribute('data-theme','light')}else{document.documentElement.setAttribute('data-theme','dark')}})();
  </script>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <nav class="header-nav">
        <a href="../index.html" class="logo">
          <span class="logo-glyph">&gt;_</span>
          <span class="logo-text">thrum</span>
        </a>
        <div class="nav-links">
          <a href="../index.html" class="nav-link">Home</a>
          <a href="../docs.html" class="nav-link nav-link-active">Docs</a>
          <a href="../about.html" class="nav-link">About</a>
          <a href="https://github.com/leonletto/thrum" class="nav-link nav-link-external" target="_blank" rel="noopener">GitHub</a>
        </div>
      </nav>
    </div>
  </header>
  <main class="docs-content" style="max-width:48rem;margin:2rem auto;padding:0 1.5rem">
    <div class="docs-content-inner">
<h2>Agent Context Management</h2>
<h2>Overview</h2>
<p>Agents lose state between sessions due to context window compaction, session<br>resets, or switching machines. The context system preserves volatile session<br>state so agents can pick up where they left off.</p>
<p><strong>Why this exists:</strong> When an agent session ends (context compacted, Claude Code<br>restarted, new worktree), the work-in-progress state vanishes. Context files<br>capture that state so the next session can continue seamlessly.</p>
<p><strong>Primary use case:</strong> The <code>/update-context</code> skill in Claude Code uses this<br>system to save session summaries before compaction or session end.</p>
<p><strong>Storage:</strong> Context files live in <code>.thrum/context/</code> (gitignored by default).<br>Each agent gets two files:</p>
<ul>
<li><code>.thrum/context/{name}.md</code> - Volatile session state (updated frequently)</li>
<li><code>.thrum/context/{name}_preamble.md</code> - Stable reference (rarely changes)</li>
</ul>
<h2>Context Files</h2>
<p>Context files hold volatile session state that doesn&#39;t belong in git commits but<br>needs to survive session boundaries.</p>
<p><strong>What to put in context:</strong></p>
<ul>
<li>Current task and progress</li>
<li>Architectural decisions under consideration</li>
<li>Partial investigation results</li>
<li>Discovered patterns or anti-patterns</li>
<li>TODOs or questions for the next session</li>
<li>Work-in-progress findings</li>
</ul>
<p><strong>What NOT to put in context:</strong></p>
<ul>
<li>Permanent documentation (use git-tracked docs)</li>
<li>Message-based coordination (use <code>thrum send</code>)</li>
<li>Code or configuration (use proper git-tracked files)</li>
</ul>
<p><strong>Location:</strong></p>
<pre><code class="language-text hljs">.thrum/
├── context/
│   ├── furiosa.md                  # Agent context (volatile)
│   ├── furiosa_preamble.md         # Agent preamble (stable)
│   ├── maximus.md
│   ├── maximus_preamble.md
│   └── coordinator_1B9K33T6RK.md   # Hash-based agent ID
```text

Context files are local by default. Use `thrum context sync` to manually share
across worktrees via the a-sync branch.

## Preamble

Each agent can have a preamble - a stable, user-editable header stored at
`.thrum/context/{agent}_preamble.md`. The preamble is automatically prepended
when showing context, providing a persistent reference that survives context
saves.

**Default preamble:** When you run `thrum quickstart`, a default preamble is
created automatically with thrum quick-reference commands.

**User-editable:** The preamble is just a markdown file. You can edit it
directly or replace it with `thrum context preamble --file custom.md`.

**Key properties:**

- Not touched by `thrum context save` - the preamble persists across saves
- Auto-created on first quickstart with default thrum quick-reference
- Not removed by `thrum context clear` - clear only removes session context
- Removed on agent delete - cleaned up alongside context

**Default content:**

```markdown
## Thrum Quick Reference

**Check messages:** `thrum inbox --unread` **Send message:**
`thrum send &quot;message&quot; --to @role` **Reply:** `thrum reply &lt;MSG_ID&gt; &quot;response&quot;`
**Status:** `thrum status` **Who&#x27;s online:** `thrum agent list --context` **Save
context:** `thrum context save` **Wait for messages:**
`thrum wait --after -30s --timeout 5m`
```text

**Customization examples:**

You can edit the preamble to add project conventions, role-specific
instructions, team rosters, or boot sequences:

```bash
# Edit the preamble directly
vim .thrum/context/furiosa_preamble.md

# Or replace it from a file
cat &gt; my-preamble.md &lt;&lt;&#x27;EOF&#x27;
## Project Conventions

**Architecture:** Hexagonal (ports/adapters)
**Testing:** Always run `make test` before committing
**Commits:** Follow Conventional Commits (feat:, fix:, docs:)

## Thrum Quick Reference
... (default commands) ...
EOF

thrum context preamble --file my-preamble.md
```text

## CLI Commands

### thrum context save

Save context content from a file or stdin.

```bash
thrum context save [flags]
```text

| Flag      | Description                                        | Default |
| --------- | -------------------------------------------------- | ------- |
| `--file`  | Path to markdown file to save as context           |         |
| `--agent` | Override agent name (defaults to current identity) |         |

**Examples:**

```bash
# Save from a file
thrum context save --file notes.md

# Save from stdin
echo &quot;Working on auth module&quot; | thrum context save

# Save for a different agent
thrum context save --agent coordinator --file notes.md
```text

---

### thrum context show

Display the saved context for the current agent.

```bash
thrum context show [flags]
```text

| Flag            | Description                                        | Default |
| --------------- | -------------------------------------------------- | ------- |
| `--agent`       | Override agent name (defaults to current identity) |         |
| `--raw`         | No header, file boundary markers for piping        | `false` |
| `--no-preamble` | Exclude preamble from output                       | `false` |

**Examples:**

```bash
# Show preamble + context (default)
thrum context show

# Show context for a different agent
thrum context show --agent furiosa

# Raw output with file boundary markers
thrum context show --raw

# Context only, no preamble
thrum context show --no-preamble
```text

**Output modes:**

Default (preamble + context with header):

```text
# Context for furiosa (1234 bytes, updated 2026-02-11T10:00:00Z)

## Thrum Quick Reference
...

# Current Work
- Implementing JWT token refresh
```text

Raw (`--raw`, shows file boundaries):

```text
&lt;!-- preamble: .thrum/context/furiosa_preamble.md --&gt;
## Thrum Quick Reference
...
&lt;!-- end preamble --&gt;

# Current Work
- Implementing JWT token refresh
```text

---

### thrum context clear

Remove the context file for the current agent.

```bash
thrum context clear [flags]
```text

| Flag      | Description                                        | Default |
| --------- | -------------------------------------------------- | ------- |
| `--agent` | Override agent name (defaults to current identity) |         |

**Examples:**

```bash
# Clear context for current agent
thrum context clear

# Clear context for a different agent
thrum context clear --agent furiosa
```text

Note: Idempotent - running clear when no context exists is a no-op.

---

### thrum context sync

Copy the context file to the a-sync branch for sharing across worktrees and
machines.

```bash
thrum context sync [flags]
```text

| Flag      | Description                                        | Default |
| --------- | -------------------------------------------------- | ------- |
| `--agent` | Override agent name (defaults to current identity) |         |

**Examples:**

```bash
# Sync context for current agent
thrum context sync

# Sync context for a different agent
thrum context sync --agent furiosa
```text

**What it does:**

1. Copies `.thrum/context/{agent}.md` to the sync worktree at
   `.git/thrum-sync/a-sync/context/{agent}.md`
2. Commits the change with message `&quot;context: update {agent}&quot;`
3. Pushes to the remote a-sync branch

**Notes:**

- No-op when no remote is configured (local-only mode)
- Respects the `--local` daemon flag
- Manual only - context is never synced automatically

---

### thrum context preamble

Show or manage the preamble for the current agent.

```bash
thrum context preamble [flags]
```text

| Flag      | Description                                        | Default |
| --------- | -------------------------------------------------- | ------- |
| `--agent` | Override agent name (defaults to current identity) |         |
| `--init`  | Create or reset to default preamble                |         |
| `--file`  | Set preamble from file                             |         |

**Examples:**

```bash
# Show current preamble
thrum context preamble

# Create/reset to default preamble
thrum context preamble --init

# Set preamble from a custom file
thrum context preamble --file my-preamble.md

# Show preamble for a different agent
thrum context preamble --agent furiosa
```text

---

### thrum context prime

Collect all context needed for agent session initialization or recovery. This is
a comprehensive context collection command that gathers identity, session info,
agent list, unread messages, git context, and daemon health into a single
output.

```bash
thrum context prime [flags]
```text

| Flag     | Description                          | Default |
| -------- | ------------------------------------ | ------- |
| `--json` | Structured JSON output for scripting | `false` |

**Examples:**

```bash
# Human-readable summary
thrum context prime

# Structured JSON output
thrum context prime --json
```text

**What it includes:**

- Agent identity (name, role, module)
- Active session information
- List of registered agents and their status
- Unread messages count
- Git context (branch, commits, files)
- Daemon health status

**Use cases:**

- Session initialization - quickly orient a new session
- Session recovery - restore context after crash or compaction
- Debugging - gather all relevant state in one command
- Agent onboarding - provide comprehensive context to new agents

**Note:** This command is an alias for `thrum prime`. The PreCompact hook
automatically saves context before compaction to `.thrum/context/{name}.md` and
`/tmp/thrum-pre-compact-{name}-{role}-{module}-{epoch}.md`, but the
agent-initiated `/update-context` skill captures richer context including
decisions and rationale.

---

### thrum context update

The `/update-context` skill is now integrated with the Thrum MCP server. Use the
MCP server for guided context updates:

```bash
thrum mcp serve
```text

**In Claude Code:**

Configure the MCP server in `.claude/settings.json` and use the
`wait_for_message` and `send_message` tools for context coordination.

---

## The /update-context Skill

The `/update-context` skill is now integrated into the Thrum MCP server. The MCP
server provides message-based context coordination through the `send_message`
and `wait_for_message` tools.

**Usage:**

Configure the MCP server in `.claude/settings.json` and agents can coordinate
context updates via messages.

**Workflow:**

1. Agent sends context via `send_message`
2. Other agents receive via `wait_for_message` or `check_messages`
3. Skill formats your input as markdown and saves it via
   `thrum context save --file /tmp/context.md`

**Example:**

```yaml
User: /update-context
Agent: What context should I preserve for the next session?
User: We&#x27;re refactoring the auth module. Decided to use JWT with
      refresh tokens. Need to add rate limiting tests.
Agent: [Saves formatted context]
      ✓ Context saved (248 bytes)
```text

The skill reduces the friction of updating context and ensures consistent
formatting.

---

## Use Cases and Patterns

### Single-Agent Session Continuity

```bash
# At the end of a work session
echo &quot;# Next Steps
- Finish JWT implementation
- Add rate limiting tests
- Review security considerations&quot; | thrum context save

# Next session
thrum context show
```text

### Multi-Agent Handoff

```bash
# Agent A saves context before handing off
thrum context save --file handoff-notes.md
thrum context sync  # Share across worktrees

# Agent B (in another worktree) pulls and reads
git fetch origin
thrum context show --agent furiosa
```text

### Context Updates at Decision Points

Save context when you make a significant decision, discover something important,
or reach a natural breakpoint:

```bash
# After architectural decision
echo &quot;# Decision: Using JWT with refresh tokens
- Token expiry: 15 min (access), 7 days (refresh)
- Storage: Redis for refresh tokens
- Rate limit: 100 req/min per IP&quot; | thrum context save
```text

### Integration with thrum status

The `thrum status` command shows context file size and age when context exists:

```bash
$ thrum status
Agent:    furiosa (@implementer)
Module:   auth
Session:  ses_01HXF2A9... (active 2h15m)
Intent:   Implementing JWT refresh
Context:  1.2 KB (updated 5m ago)    # ← Context indicator
Inbox:    3 unread (12 total)
```text

---

## RPC API

Context operations are available via the daemon&#x27;s RPC API:

### context.save

**Request:**

```json
{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;method&quot;: &quot;context.save&quot;,
  &quot;params&quot;: {
    &quot;agent_name&quot;: &quot;furiosa&quot;,
    &quot;content&quot;: &quot;base64-encoded-content&quot;
  }
}
```text

**Response:**

```json
{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;result&quot;: {
    &quot;agent_name&quot;: &quot;furiosa&quot;,
    &quot;message&quot;: &quot;Context saved for furiosa (248 bytes)&quot;
  }
}
```text

---

### context.show

**Request:**

```json
{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;method&quot;: &quot;context.show&quot;,
  &quot;params&quot;: {
    &quot;agent_name&quot;: &quot;furiosa&quot;,
    &quot;include_preamble&quot;: true
  }
}
```text

The `include_preamble` field is optional and defaults to `true` when omitted.

**Response:**

```json
{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;result&quot;: {
    &quot;agent_name&quot;: &quot;furiosa&quot;,
    &quot;preamble&quot;: &quot;base64-encoded-preamble&quot;,
    &quot;content&quot;: &quot;base64-encoded-content&quot;,
    &quot;has_context&quot;: true,
    &quot;has_preamble&quot;: true,
    &quot;preamble_size&quot;: 256,
    &quot;size&quot;: 1234,
    &quot;updated_at&quot;: &quot;2026-02-11T10:00:00Z&quot;
  }
}
```text

---

### context.preamble.show

**Request:**

```json
{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;method&quot;: &quot;context.preamble.show&quot;,
  &quot;params&quot;: {
    &quot;agent_name&quot;: &quot;furiosa&quot;
  }
}
```text

**Response:**

```json
{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;result&quot;: {
    &quot;agent_name&quot;: &quot;furiosa&quot;,
    &quot;content&quot;: &quot;base64-encoded-preamble&quot;,
    &quot;has_preamble&quot;: true
  }
}
```text

---

### context.preamble.save

**Request:**

```json
{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;method&quot;: &quot;context.preamble.save&quot;,
  &quot;params&quot;: {
    &quot;agent_name&quot;: &quot;furiosa&quot;,
    &quot;content&quot;: &quot;base64-encoded-content&quot;
  }
}
```text

**Response:**

```json
{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;result&quot;: {
    &quot;agent_name&quot;: &quot;furiosa&quot;,
    &quot;message&quot;: &quot;Preamble saved for furiosa (256 bytes)&quot;
  }
}
```text

---

### context.clear

**Request:**

```json
{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;method&quot;: &quot;context.clear&quot;,
  &quot;params&quot;: {
    &quot;agent_name&quot;: &quot;furiosa&quot;
  }
}
```text

**Response:**

```json
{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;result&quot;: {
    &quot;agent_name&quot;: &quot;furiosa&quot;,
    &quot;message&quot;: &quot;Context cleared for furiosa&quot;
  }
}
```text

---

## Implementation Notes

### Locking Strategy

Context RPC handlers follow the daemon&#x27;s standard locking patterns:

- `context.save` and `context.clear` acquire a write lock (`Lock()`)
- `context.show` acquires a read lock (`RLock()`)

This ensures thread-safe access when multiple clients interact with context
files.

### File Format

Context files are plain markdown (`.md`). No special format or structure is
enforced - agents are free to use any markdown convention that suits their
workflow.

**Common patterns:**

- Heading-based sections (`# Next Steps`, `# Decisions`, `# Questions`)
- Bulleted lists for TODOs
- Code blocks for snippets or commands
- Fenced blocks for structured data (JSON, YAML)

### Sync Workflow (Manual Only)

Context sync is manual-only to avoid noise and respect agent autonomy:

- The daemon never auto-syncs context files
- Agents must explicitly run `thrum context sync` to share
- Sync respects local-only mode (no-op when `--local` is set on the daemon)

**Rationale:** Context is volatile and session-specific. Auto-syncing would
create unnecessary churn. Manual sync gives agents control over when and what to
share.

---

## Best Practices

### Keep Context Concise

Context files should be high-signal summaries, not exhaustive logs. Prefer
bullet points over paragraphs.

**Good:**

```markdown
# Next Steps

- Finish JWT implementation (see src/auth/jwt.go)
- Add rate limiting (decided on 100 req/min per IP)
- Review security: check token expiry edge cases
```text

**Bad:**

```markdown
# What I Did Today

I started by looking at the auth module and then I realized that we need JWT so
I implemented a basic version but it&#x27;s not complete yet and I still need to add
rate limiting which I discussed with the team and we decided on 100 requests per
minute...
```text

### Update Context at Decision Points

Save context when you make a significant decision, discover something important,
or reach a natural breakpoint.

**When to update:**

- After choosing between architectural alternatives
- When discovering a bug or anti-pattern
- Before switching to a different task
- At the end of a work session

### Use the /update-context Skill

The skill provides a consistent, low-friction workflow for updating context.
Install it and use it regularly.

### Sync Selectively

Only sync context that is useful to other agents or future sessions on different
machines. Local notes and WIP context can stay local.

---

## See Also

- [Identity System](identity.md) - Agent identity and registration
- [CLI Reference](cli.md) - All CLI commands
- [RPC API Reference](rpc-api.md) - Complete RPC method documentation
- [Agent Coordination](agent-coordination.md) - Multi-agent workflows</code></pre>

    </div>
    <p style="margin-top:2rem"><a href="../docs.html#context.html">&larr; View in documentation</a></p>
  </main>
  <script>
    // Redirect browsers to the SPA for full navigation experience.
    // Crawlers (which don't execute JS) will index the static content above.
    if (window.location.search.indexOf('nospa') === -1) {
      window.location.replace('../docs.html#context.html');
    }
  </script>
</body>
</html>