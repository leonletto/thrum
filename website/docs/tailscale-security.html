<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tailscale Sync Security — Thrum</title>
  <meta name="description" content="Security model for Thrum's Tailscale peer sync — pairing, encryption, access control, and threat mitigations">
  <!-- Open Graph -->
  <meta property="og:type" content="article">
  <meta property="og:title" content="Tailscale Sync Security — Thrum">
  <meta property="og:description" content="Security model for Thrum's Tailscale peer sync — pairing, encryption, access control, and threat mitigations">
  <meta property="og:url" content="https://leonletto.github.io/thrum/docs/tailscale-security.html">
  <meta property="og:site_name" content="Thrum">
  <meta property="og:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Tailscale Sync Security — Thrum">
  <meta name="twitter:description" content="Security model for Thrum's Tailscale peer sync — pairing, encryption, access control, and threat mitigations">
  <meta name="twitter:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <!-- Canonical: SPA is the primary URL -->
  <link rel="canonical" href="https://leonletto.github.io/thrum/docs.html#tailscale-security.html">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x26A1;</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/theme.css">
  <link rel="stylesheet" href="../css/docs.css">
  <script>
    (function(){var t=localStorage.getItem('thrum-theme');if(t){document.documentElement.setAttribute('data-theme',t)}else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:light)').matches){document.documentElement.setAttribute('data-theme','light')}else{document.documentElement.setAttribute('data-theme','dark')}})();
  </script>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <nav class="header-nav">
        <a href="../index.html" class="logo">
          <span class="logo-glyph">&gt;_</span>
          <span class="logo-text">thrum</span>
        </a>
        <div class="nav-links">
          <a href="../index.html" class="nav-link">Home</a>
          <a href="../docs.html" class="nav-link nav-link-active">Docs</a>
          <a href="../about.html" class="nav-link">About</a>
          <a href="https://github.com/leonletto/thrum" class="nav-link nav-link-external" target="_blank" rel="noopener">GitHub</a>
        </div>
      </nav>
    </div>
  </header>
  <main class="docs-content" style="max-width:48rem;margin:2rem auto;padding:0 1.5rem">
    <div class="docs-content-inner">
<h2>Tailscale Sync Security</h2>
<blockquote>
<p>See also: <a href="tailscale-sync.html">Tailscale Sync</a> for setup, architecture, and CLI<br>commands.</p>
</blockquote>
<p>Security model for the Tailscale-based sync protocol.</p>
<h2>Overview</h2>
<p>The sync protocol uses three layers of defense:</p>
<ol>
<li><strong>Tailscale Encryption</strong> -- WireGuard tunnels encrypt all traffic</li>
<li><strong>Pairing Code</strong> -- Human-mediated 4-digit code establishes trust</li>
<li><strong>Token Authentication</strong> -- 32-byte token authenticates every request</li>
</ol>
<p>This replaces the previous overengineered security stack (Ed25519 signing,<br>validation pipeline, WhoIs authorization, rate limiting, quarantine system) with<br>a simpler model that provides equivalent practical security.</p>
<h2>Layer 1: Tailscale Encryption</h2>
<p>All sync traffic flows over Tailscale&#39;s WireGuard mesh network. This provides:</p>
<ul>
<li><strong>End-to-end encryption</strong> between peers</li>
<li><strong>Identity verification</strong> via Tailscale&#39;s control plane</li>
<li><strong>NAT traversal</strong> with no port forwarding or firewall configuration</li>
<li><strong>Network-level access control</strong> via Tailscale ACLs</li>
</ul>
<p>Tailscale handles the hard parts of secure networking. Thrum doesn&#39;t need to<br>implement its own transport encryption.</p>
<h3>Recommended ACL Configuration</h3>
<h4>Tailscale ACLs</h4>
<pre><code class="language-json hljs"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;tagOwners&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;tag:thrum-daemon&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;group:devops&quot;</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;acls&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;action&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;accept&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;src&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;tag:thrum-daemon&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dst&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;tag:thrum-daemon:9100&quot;</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
```text

#### Headscale ACLs

```yaml
groups<span class="hljs-punctuation">:</span>
  - name<span class="hljs-punctuation">:</span> thrum-daemons
    members<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;user1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;user2&quot;</span><span class="hljs-punctuation">]</span>

acls<span class="hljs-punctuation">:</span>
  - action<span class="hljs-punctuation">:</span> accept
    src<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;group:thrum-daemons&quot;</span><span class="hljs-punctuation">]</span>
    dst<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;group:thrum-daemons:9100&quot;</span><span class="hljs-punctuation">]</span>
```text

## Layer <span class="hljs-number">2</span><span class="hljs-punctuation">:</span> Pairing Code

Trust between two machines is established through a human-mediated pairing flow.

### How It Works

<span class="hljs-number">1.</span> Machine A generates a random <span class="hljs-number">4</span>-digit code and displays it to the user
<span class="hljs-number">2.</span> The user communicates the code to Machine B&#x27;s operator (verbally<span class="hljs-punctuation">,</span> chat<span class="hljs-punctuation">,</span> etc.)
<span class="hljs-number">3.</span> Machine B sends the code to Machine A over Tailscale
<span class="hljs-number">4.</span> Machine A verifies the code and establishes the peer relationship

### Security Properties

- **Human-in-the-loop**<span class="hljs-punctuation">:</span> A person must deliberately share the code<span class="hljs-punctuation">,</span> preventing
  automated or accidental pairing
- **Time-limited**<span class="hljs-punctuation">:</span> Pairing sessions expire after <span class="hljs-number">5</span> minutes
- **Attempt-limited**<span class="hljs-punctuation">:</span> Only <span class="hljs-number">3</span> attempts per session before lockout
- **One-time use**<span class="hljs-punctuation">:</span> Each code can only be used once

### Threat Model

The pairing code provides protection against<span class="hljs-punctuation">:</span>

- **Unauthorized peers** -- Only someone with the code can pair
- **Replay attacks** -- Codes expire and are single-use
- **Brute force** -- <span class="hljs-number">3</span>-attempt limit makes guessing impractical within the
  <span class="hljs-number">5</span>-minute window

The code does NOT protect against an attacker who can both observe the code
being shared AND intercept the Tailscale connection. In practice<span class="hljs-punctuation">,</span> Tailscale&#x27;s
network security makes this extremely unlikely.

## Layer <span class="hljs-number">3</span><span class="hljs-punctuation">:</span> Token Authentication

After pairing<span class="hljs-punctuation">,</span> a <span class="hljs-number">32</span>-byte hex token (<span class="hljs-number">256</span> bits of entropy) is shared between the
two peers. Every sync request includes this token.

### Token Lifecycle

<span class="hljs-number">1.</span> **Generation**<span class="hljs-punctuation">:</span> A random <span class="hljs-number">32</span>-byte token is generated during pairing
<span class="hljs-number">2.</span> **Distribution**<span class="hljs-punctuation">:</span> The token is sent to the joining peer in the pairing
   response
<span class="hljs-number">3.</span> **Storage**<span class="hljs-punctuation">:</span> Both peers store the token in their `peers.json` file
<span class="hljs-number">4.</span> **Validation**<span class="hljs-punctuation">:</span> Every sync request is validated against the token before
   processing

### Validation Flow

```text
Incoming sync request
   │
   ├─ Is method <span class="hljs-string">&quot;pair.request&quot;</span>?  ──► Yes<span class="hljs-punctuation">:</span> Skip auth (pairing flow)
   │
   ├─ Extract token from params
   │
   ├─ Look up token in peer registry
   │   ├─ Not found  ──► Reject (unauthorized)
   │   └─ Found      ──► Allow + update last_sync
   │
   └─ Dispatch to handler
```text

### Security Properties

- **<span class="hljs-number">256</span> bits of entropy** -- Computationally infeasible to guess
- **Per-peer tokens** -- Each peer relationship has its own token
- **Central validation** -- All RPCs are authenticated in the sync server before
  handler dispatch
- **Exempt only pair.request** -- The pairing RPC is the only unauthenticated
  method (protected by the pairing code instead)

## Configuration

No security-specific configuration is needed. The security model is built into
the pairing and sync flow.

| Aspect           | Configuration                        |
| ---------------- | ------------------------------------ |
| Encryption       | Automatic (Tailscale)                |
| Pairing timeout  | <span class="hljs-number">5</span> minutes (hardcoded)                |
| Pairing attempts | <span class="hljs-number">3</span> per session (hardcoded)            |
| Token length     | <span class="hljs-number">32</span> bytes / <span class="hljs-number">256</span> bits (hardcoded)      |
| Network ACLs     | Configure in Tailscale admin console |

## Comparison with Previous Model

| Previous (Removed)            | Current (Simplified)                                 |
| ----------------------------- | ---------------------------------------------------- |
| Ed25519 event signing         | Not needed -- Tailscale provides transport integrity |
| <span class="hljs-number">3</span>-stage validation pipeline   | Not needed -- token auth is sufficient               |
| WhoIs authorization           | Not needed -- pairing code + Tailscale ACLs          |
| Per-peer rate limiting        | Not needed -- Tailscale rate limits at network level |
| Quarantine system             | Not needed -- invalid tokens are simply rejected     |
| TOFU key pinning              | Replaced by explicit human-mediated pairing          |
| ~<span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">074</span> lines of security code | ~<span class="hljs-number">40</span> lines of token validation                        |

## Troubleshooting

### Peer rejected with <span class="hljs-string">&quot;unauthorized&quot;</span>

The peer&#x27;s token doesn&#x27;t match. This can happen if<span class="hljs-punctuation">:</span>

<span class="hljs-number">1.</span> The peer was removed and re-paired (old token is invalid)
<span class="hljs-number">2.</span> The `peers.json` file was manually edited or corrupted
<span class="hljs-number">3.</span> The peer registry was reset on one side

**Fix**<span class="hljs-punctuation">:</span> Remove the peer on both machines and re-pair<span class="hljs-punctuation">:</span>

```bash
# On both machines<span class="hljs-punctuation">:</span>
thrum peer remove &lt;name&gt;

# Then pair again<span class="hljs-punctuation">:</span>
# Machine A<span class="hljs-punctuation">:</span> thrum peer add
# Machine B<span class="hljs-punctuation">:</span> thrum peer join &lt;address&gt;
```text

### Pairing fails with <span class="hljs-string">&quot;no active pairing session&quot;</span>

The pairing session on Machine A expired or was never started.

**Fix**<span class="hljs-punctuation">:</span> Run `thrum peer add` on Machine A first<span class="hljs-punctuation">,</span> then `thrum peer join` on
Machine B within <span class="hljs-number">5</span> minutes.

### Pairing fails with <span class="hljs-string">&quot;too many failed attempts&quot;</span>

Three incorrect codes were entered.

**Fix**<span class="hljs-punctuation">:</span> Run `thrum peer add` again on Machine A to start a fresh session with a
new code.</code></pre>

    </div>
    <p style="margin-top:2rem"><a href="../docs.html#tailscale-security.html">&larr; View in documentation</a></p>
  </main>
  <script>
    // Redirect browsers to the SPA for full navigation experience.
    // Crawlers (which don't execute JS) will index the static content above.
    if (window.location.search.indexOf('nospa') === -1) {
      window.location.replace('../docs.html#tailscale-security.html');
    }
  </script>
</body>
</html>