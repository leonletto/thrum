<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Reference — Thrum</title>
  <meta name="description" content="All events emitted by the Thrum daemon over WebSocket — message, agent, session, sync, and subscription events">
  <!-- Open Graph -->
  <meta property="og:type" content="article">
  <meta property="og:title" content="Event Reference — Thrum">
  <meta property="og:description" content="All events emitted by the Thrum daemon over WebSocket — message, agent, session, sync, and subscription events">
  <meta property="og:url" content="https://leonletto.github.io/thrum/docs/api/events.html">
  <meta property="og:site_name" content="Thrum">
  <meta property="og:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Event Reference — Thrum">
  <meta name="twitter:description" content="All events emitted by the Thrum daemon over WebSocket — message, agent, session, sync, and subscription events">
  <meta name="twitter:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <!-- Canonical: SPA is the primary URL -->
  <link rel="canonical" href="https://leonletto.github.io/thrum/docs.html#api/events.html">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x26A1;</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/theme.css">
  <link rel="stylesheet" href="../css/docs.css">
  <script>
    (function(){var t=localStorage.getItem('thrum-theme');if(t){document.documentElement.setAttribute('data-theme',t)}else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:light)').matches){document.documentElement.setAttribute('data-theme','light')}else{document.documentElement.setAttribute('data-theme','dark')}})();
  </script>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <nav class="header-nav">
        <a href="../index.html" class="logo">
          <span class="logo-glyph">&gt;_</span>
          <span class="logo-text">thrum</span>
        </a>
        <div class="nav-links">
          <a href="../index.html" class="nav-link">Home</a>
          <a href="../docs.html" class="nav-link nav-link-active">Docs</a>
          <a href="../about.html" class="nav-link">About</a>
          <a href="https://github.com/leonletto/thrum" class="nav-link nav-link-external" target="_blank" rel="noopener">GitHub</a>
        </div>
      </nav>
    </div>
  </header>
  <main class="docs-content" style="max-width:48rem;margin:2rem auto;padding:0 1.5rem">
    <div class="docs-content-inner">
<h2>Event Reference</h2>
<p>This document provides detailed documentation for all events emitted by the<br>Thrum daemon over WebSocket connections.</p>
<h2>Event Format</h2>
<p>Events are sent as JSON-RPC 2.0 notifications (without an <code>id</code> field):</p>
<pre><code class="language-json hljs"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;event.type&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// event-specific payload</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
```go

**Key characteristics**<span class="hljs-punctuation">:</span>

- No `id` field (notifications don&#x27;t expect responses)
- `method` field contains the event type
- `params` contains the event payload
- Events are one-way<span class="hljs-punctuation">:</span> server → client

## Event Delivery

### Subscription-Based

Events are only delivered to clients that have active subscriptions matching the
event.

**Subscription types**<span class="hljs-punctuation">:</span>

<span class="hljs-number">1.</span> **Scope-based**<span class="hljs-punctuation">:</span> Receive events for messages with specific scopes
<span class="hljs-number">2.</span> **Mention-based**<span class="hljs-punctuation">:</span> Receive events for messages mentioning a specific role
<span class="hljs-number">3.</span> **All**<span class="hljs-punctuation">:</span> Receive all events (use sparingly)

### Delivery Guarantees

- **At-least-once**<span class="hljs-punctuation">:</span> Events may be delivered multiple times
- **Ordering**<span class="hljs-punctuation">:</span> Events for the same message are ordered<span class="hljs-punctuation">,</span> but events across
  messages may be out of order
- **Buffer limit**<span class="hljs-punctuation">:</span> Client buffers have a limit (default <span class="hljs-number">100</span>); slow clients may
  miss events

## Common Fields

All persisted events share a common base structure<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;event.type&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T12:00:00Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;event_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;01HQXYZ...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;v&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
```text

| Field       | Type   | Description                                    |
| ----------- | ------ | ---------------------------------------------- |
| `type`      | string | Event type identifier (e.g.<span class="hljs-punctuation">,</span> `message.create`) |
| `timestamp` | string | ISO <span class="hljs-number">8601</span> timestamp                             |
| `event_id`  | string | Globally unique ULID<span class="hljs-punctuation">,</span> used for deduplication   |
| `v`         | int    | Event schema version (currently `<span class="hljs-number">1</span>`)           |

## JSONL Storage

Events are persisted as sharded JSONL files in the sync worktree at
`.git/thrum-sync/a-sync/`<span class="hljs-punctuation">:</span>

```text
.git/thrum-sync/a-sync/
├── events.jsonl              Agent lifecycle events
└── messages/
    └── <span class="hljs-punctuation">{</span>agent_name<span class="hljs-punctuation">}</span>.jsonl    Per-agent message events
```go

**Storage assignment**<span class="hljs-punctuation">:</span>

| File                     | Event Types                                                                         |
| ------------------------ | ----------------------------------------------------------------------------------- |
| `events.jsonl`           | `agent.register`<span class="hljs-punctuation">,</span> `agent.session.start`<span class="hljs-punctuation">,</span> `agent.session.end`<span class="hljs-punctuation">,</span> `agent.cleanup`       |
| `messages/<span class="hljs-punctuation">{</span>agent<span class="hljs-punctuation">}</span>.jsonl` | `message.create`<span class="hljs-punctuation">,</span> `message.edit`<span class="hljs-punctuation">,</span> `message.delete`<span class="hljs-punctuation">,</span> `thread.create`<span class="hljs-punctuation">,</span> `agent.update` |

Events are append-only and immutable. The JSONL files are the source of truth;
the SQLite database (`.thrum/var/messages.db`) is a derived read projection that
can be rebuilt from the JSONL at any time.

## Event Types

### Message Events

#### message.create

Emitted when a new message is created in the system.

**When emitted**<span class="hljs-punctuation">:</span>

- After `message.send` RPC call succeeds
- When message is synced from remote
- For both agent and user messages

**Stored in**<span class="hljs-punctuation">:</span> `messages/<span class="hljs-punctuation">{</span>agent_name<span class="hljs-punctuation">}</span>.jsonl`

**Payload** (MessageCreateEvent)<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;message.create&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T12:00:00Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;event_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;01HQXYZ...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;v&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;message_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;msg_xyz789&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;thread_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;thread_abc123&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;agent_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;furiosa&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;session_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;s_abc123&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;body&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;format&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;markdown&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Hello, world!&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;structured&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;{\&quot;key\&quot;:\&quot;value\&quot;}&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;scopes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;task&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;PROJ-123&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;refs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mention&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;reviewer&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;authored_by&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;disclosed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
```text

**Fields**<span class="hljs-punctuation">:</span>

- `event_id`<span class="hljs-punctuation">:</span> Globally unique ULID for deduplication
- `v`<span class="hljs-punctuation">:</span> Event schema version
- `message_id`<span class="hljs-punctuation">:</span> Unique message identifier
- `thread_id`<span class="hljs-punctuation">:</span> Parent thread (empty if standalone message)
- `agent_id`<span class="hljs-punctuation">:</span> Message author&#x27;s agent name or legacy ID
- `session_id`<span class="hljs-punctuation">:</span> Session that created the message
- `timestamp`<span class="hljs-punctuation">:</span> Message creation time (ISO <span class="hljs-number">8601</span>)
- `body.format`<span class="hljs-punctuation">:</span> Content format (`markdown`<span class="hljs-punctuation">,</span> `plain`<span class="hljs-punctuation">,</span> `json`)
- `body.content`<span class="hljs-punctuation">:</span> Message text content
- `body.structured`<span class="hljs-punctuation">:</span> Optional structured data (JSON string)
- `scopes`<span class="hljs-punctuation">:</span> List of scope tags (context)
- `refs`<span class="hljs-punctuation">:</span> List of references (mentions<span class="hljs-punctuation">,</span> links<span class="hljs-punctuation">,</span> etc.)
- `authored_by`<span class="hljs-punctuation">:</span> Original author if impersonated (empty otherwise)
- `disclosed`<span class="hljs-punctuation">:</span> Whether impersonation is disclosed

**Related methods**<span class="hljs-punctuation">:</span> `message.send`<span class="hljs-punctuation">,</span> `message.list`

**Example usage**<span class="hljs-punctuation">:</span>

```javascript
ws.onmessage = (event) =&gt; <span class="hljs-punctuation">{</span>
  const msg = JSON.parse(event.data);
  if (msg.method === <span class="hljs-string">&quot;message.create&quot;</span>) <span class="hljs-punctuation">{</span>
    const message = msg.params;
    console.log(
      `New message from $<span class="hljs-punctuation">{</span>message.agent_id<span class="hljs-punctuation">}</span><span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>message.body.content<span class="hljs-punctuation">}</span>`<span class="hljs-punctuation">,</span>
    );
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>;
```go

#### message.edit

Emitted when a message is edited.

**When emitted**<span class="hljs-punctuation">:</span>

- After `message.edit` RPC call succeeds
- When message edit is synced from remote
- Only the message author can edit messages

**Stored in**<span class="hljs-punctuation">:</span> `messages/<span class="hljs-punctuation">{</span>agent_name<span class="hljs-punctuation">}</span>.jsonl`

**Payload** (MessageEditEvent)<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;message.edit&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T13:00:00Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;event_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;01HQXYZ...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;v&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;message_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;msg_xyz789&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;body&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;format&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;markdown&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Updated content&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;structured&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;{\&quot;updated\&quot;:true}&quot;</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
```text

**Fields**<span class="hljs-punctuation">:</span>

- `event_id`<span class="hljs-punctuation">:</span> Globally unique ULID for deduplication
- `message_id`<span class="hljs-punctuation">:</span> ID of edited message
- `timestamp`<span class="hljs-punctuation">:</span> Edit time (ISO <span class="hljs-number">8601</span>)
- `body`<span class="hljs-punctuation">:</span> Updated message body

**Edit history**<span class="hljs-punctuation">:</span> Full edit history is stored in the database (`message_edits`
table) and includes<span class="hljs-punctuation">:</span>

- Old content
- New content
- Timestamp
- Editor session ID

**Related methods**<span class="hljs-punctuation">:</span> `message.edit`<span class="hljs-punctuation">,</span> `message.get`

**Example usage**<span class="hljs-punctuation">:</span>

```javascript
ws.onmessage = (event) =&gt; <span class="hljs-punctuation">{</span>
  const msg = JSON.parse(event.data);
  if (msg.method === <span class="hljs-string">&quot;message.edit&quot;</span>) <span class="hljs-punctuation">{</span>
    const edit = msg.params;
    updateMessageInUI(edit.message_id<span class="hljs-punctuation">,</span> edit.body.content);
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>;
```go

#### message.delete

Emitted when a message is soft-deleted.

**When emitted**<span class="hljs-punctuation">:</span>

- After `message.delete` RPC call succeeds
- When message deletion is synced from remote
- Only the message author can delete messages

**Stored in**<span class="hljs-punctuation">:</span> `messages/<span class="hljs-punctuation">{</span>agent_name<span class="hljs-punctuation">}</span>.jsonl`

**Payload** (MessageDeleteEvent)<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;message.delete&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T14:00:00Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;event_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;01HQXYZ...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;v&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;message_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;msg_xyz789&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;spam&quot;</span>
<span class="hljs-punctuation">}</span>
```text

**Fields**<span class="hljs-punctuation">:</span>

- `event_id`<span class="hljs-punctuation">:</span> Globally unique ULID for deduplication
- `message_id`<span class="hljs-punctuation">:</span> ID of deleted message
- `timestamp`<span class="hljs-punctuation">:</span> Deletion time (ISO <span class="hljs-number">8601</span>)
- `reason`<span class="hljs-punctuation">:</span> Optional deletion reason

**Soft deletion**<span class="hljs-punctuation">:</span> Messages are marked as deleted but not removed from the
database. The message content is preserved for audit purposes.

**Related methods**<span class="hljs-punctuation">:</span> `message.delete`<span class="hljs-punctuation">,</span> `message.list` (with `include_deleted`
param)

**Example usage**<span class="hljs-punctuation">:</span>

```javascript
ws.onmessage = (event) =&gt; <span class="hljs-punctuation">{</span>
  const msg = JSON.parse(event.data);
  if (msg.method === <span class="hljs-string">&quot;message.delete&quot;</span>) <span class="hljs-punctuation">{</span>
    const deletion = msg.params;
    removeMessageFromUI(deletion.message_id);
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>;
```go

### Thread Events

#### thread.create

Emitted when a new thread is created.

**When emitted**<span class="hljs-punctuation">:</span>

- After `thread.create` RPC call succeeds
- When thread is synced from remote

**Stored in**<span class="hljs-punctuation">:</span> `messages/<span class="hljs-punctuation">{</span>agent_name<span class="hljs-punctuation">}</span>.jsonl`

**Payload** (ThreadCreateEvent)<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;thread.create&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T12:00:00Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;event_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;01HQXYZ...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;v&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;thread_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;thread_abc123&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Discussion about feature X&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;created_by&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;furiosa&quot;</span>
<span class="hljs-punctuation">}</span>
```go

**Fields**<span class="hljs-punctuation">:</span>

- `event_id`<span class="hljs-punctuation">:</span> Globally unique ULID for deduplication
- `thread_id`<span class="hljs-punctuation">:</span> Unique thread identifier
- `title`<span class="hljs-punctuation">:</span> Thread title
- `timestamp`<span class="hljs-punctuation">:</span> Creation time (ISO <span class="hljs-number">8601</span>)
- `created_by`<span class="hljs-punctuation">:</span> Agent/user that created the thread

**Related methods**<span class="hljs-punctuation">:</span> `thread.create`<span class="hljs-punctuation">,</span> `thread.list`<span class="hljs-punctuation">,</span> `thread.get`

#### thread.updated

Real-time notification emitted when a thread is updated with new messages. This
event is a WebSocket notification only and is **not persisted** to JSONL.

**When emitted**<span class="hljs-punctuation">:</span>

- After a new message is added to a thread
- Sent to clients with matching subscriptions

**Payload** (ThreadUpdatedEvent)<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;thread.updated&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T13:00:00Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;event_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;01HQXYZ...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;v&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;thread_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;thread_abc123&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;message_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;unread_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;last_activity&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T13:00:00Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;last_sender&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;furiosa&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;preview&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Latest message text...&quot;</span>
<span class="hljs-punctuation">}</span>
```go

**Fields**<span class="hljs-punctuation">:</span>

- `thread_id`<span class="hljs-punctuation">:</span> Thread that was updated
- `message_count`<span class="hljs-punctuation">:</span> Total messages in thread
- `unread_count`<span class="hljs-punctuation">:</span> Unread messages for the subscribing agent
- `last_activity`<span class="hljs-punctuation">:</span> Timestamp of latest activity
- `last_sender`<span class="hljs-punctuation">:</span> Agent who sent the latest message
- `preview`<span class="hljs-punctuation">:</span> Optional preview of latest message content

### Agent Events

#### agent.register

Emitted when an agent registers with the daemon.

**When emitted**<span class="hljs-punctuation">:</span>

- After `agent.register` RPC call succeeds (first registration)
- Not emitted for re-registrations of existing agents

**Stored in**<span class="hljs-punctuation">:</span> `events.jsonl`

**Payload** (AgentRegisterEvent)<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;agent.register&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T12:00:00Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;event_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;01HQXYZ...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;v&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;agent_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;furiosa&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;kind&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;agent&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;furiosa&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;role&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;implementer&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;module&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;worktree&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;main&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;display&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Auth Implementer&quot;</span>
<span class="hljs-punctuation">}</span>
```go

**Fields**<span class="hljs-punctuation">:</span>

- `event_id`<span class="hljs-punctuation">:</span> Globally unique ULID for deduplication
- `agent_id`<span class="hljs-punctuation">:</span> Agent identifier (name-based for named agents<span class="hljs-punctuation">,</span> legacy hash for
  unnamed)
- `kind`<span class="hljs-punctuation">:</span> Agent kind (`<span class="hljs-string">&quot;agent&quot;</span>` or `<span class="hljs-string">&quot;user&quot;</span>`)
- `name`<span class="hljs-punctuation">:</span> Human-readable agent name (lowercase alphanumeric + underscores<span class="hljs-punctuation">,</span> e.g.<span class="hljs-punctuation">,</span>
  `furiosa`). Empty for legacy unnamed agents.
- `role`<span class="hljs-punctuation">:</span> Agent role (e.g.<span class="hljs-punctuation">,</span> `implementer`<span class="hljs-punctuation">,</span> `reviewer`<span class="hljs-punctuation">,</span> `coordinator`)
- `module`<span class="hljs-punctuation">:</span> Agent module (area of work)
- `worktree`<span class="hljs-punctuation">:</span> Git worktree name the agent is operating in
- `display`<span class="hljs-punctuation">:</span> Optional display name
- `timestamp`<span class="hljs-punctuation">:</span> Registration time (ISO <span class="hljs-number">8601</span>)

**Agent naming**<span class="hljs-punctuation">:</span> Agents support human-readable names set via `--name` flag<span class="hljs-punctuation">,</span>
`THRUM_NAME` env var<span class="hljs-punctuation">,</span> or identity files at `.thrum/identities/<span class="hljs-punctuation">{</span>name<span class="hljs-punctuation">}</span>.json`.
Names must match `<span class="hljs-punctuation">[</span>a-z0<span class="hljs-number">-9</span>_<span class="hljs-punctuation">]</span>+` and cannot use reserved words (`daemon`<span class="hljs-punctuation">,</span> `system`<span class="hljs-punctuation">,</span>
`thrum`<span class="hljs-punctuation">,</span> `all`<span class="hljs-punctuation">,</span> `broadcast`).

**Related methods**<span class="hljs-punctuation">:</span> `agent.register`<span class="hljs-punctuation">,</span> `agent.list`

#### agent.cleanup

Emitted when an agent is deleted or cleaned up.

**When emitted**<span class="hljs-punctuation">:</span>

- After `thrum agent delete NAME` CLI command
- After `thrum agent cleanup --force` removes orphaned agents
- When cleanup is triggered from the UI

**Stored in**<span class="hljs-punctuation">:</span> `events.jsonl`

**Payload** (AgentCleanupEvent)<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;agent.cleanup&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T15:00:00Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;event_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;01HQXYZ...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;v&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;agent_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;furiosa&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;manual deletion&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;manual&quot;</span>
<span class="hljs-punctuation">}</span>
```go

**Fields**<span class="hljs-punctuation">:</span>

- `event_id`<span class="hljs-punctuation">:</span> Globally unique ULID for deduplication
- `agent_id`<span class="hljs-punctuation">:</span> Name of the deleted agent
- `timestamp`<span class="hljs-punctuation">:</span> Cleanup time (ISO <span class="hljs-number">8601</span>)
- `reason`<span class="hljs-punctuation">:</span> Optional reason for cleanup
- `method`<span class="hljs-punctuation">:</span> How cleanup was triggered (`<span class="hljs-string">&quot;manual&quot;</span>`<span class="hljs-punctuation">,</span> `<span class="hljs-string">&quot;automated&quot;</span>`<span class="hljs-punctuation">,</span> `<span class="hljs-string">&quot;ui&quot;</span>`)

**Related methods**<span class="hljs-punctuation">:</span> `agent.delete`<span class="hljs-punctuation">,</span> `agent.cleanup`

#### agent.update

Emitted when an agent&#x27;s work context changes (git state<span class="hljs-punctuation">,</span> intent<span class="hljs-punctuation">,</span> task).

**When emitted**<span class="hljs-punctuation">:</span>

- After a heartbeat detects git state changes
- After `set-intent` or `set-task` RPC calls

**Stored in**<span class="hljs-punctuation">:</span> `messages/<span class="hljs-punctuation">{</span>agent_name<span class="hljs-punctuation">}</span>.jsonl`

**Payload** (AgentUpdateEvent)<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;agent.update&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T12:30:00Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;event_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;01HQXYZ...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;v&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;agent_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;furiosa&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;work_contexts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;session_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;s_abc123&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;branch&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;feature/auth&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;worktree_path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/path/to/repo&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;unmerged_commits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">&quot;sha&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;abc1234&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Add login form&quot;</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;uncommitted_files&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;auth.go&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;changed_files&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;auth.go&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;auth_test.go&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;git_updated_at&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T12:30:00Z&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;current_task&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Implement login flow&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;task_updated_at&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T12:00:00Z&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;intent&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Building auth module&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;intent_updated_at&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T12:00:00Z&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
```go

**Fields**<span class="hljs-punctuation">:</span>

- `event_id`<span class="hljs-punctuation">:</span> Globally unique ULID for deduplication
- `agent_id`<span class="hljs-punctuation">:</span> Agent whose context changed
- `work_contexts`<span class="hljs-punctuation">:</span> Array of per-session work context snapshots
- `work_contexts<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>.session_id`<span class="hljs-punctuation">:</span> Session this context belongs to
- `work_contexts<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>.branch`<span class="hljs-punctuation">:</span> Current git branch
- `work_contexts<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>.worktree_path`<span class="hljs-punctuation">:</span> Filesystem path to worktree
- `work_contexts<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>.unmerged_commits`<span class="hljs-punctuation">:</span> Commits not yet on the base branch
- `work_contexts<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>.uncommitted_files`<span class="hljs-punctuation">:</span> Files with uncommitted changes
- `work_contexts<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>.changed_files`<span class="hljs-punctuation">:</span> All modified files
- `work_contexts<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>.git_updated_at`<span class="hljs-punctuation">:</span> When git state was last checked
- `work_contexts<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>.current_task`<span class="hljs-punctuation">:</span> Current task description
- `work_contexts<span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>.intent`<span class="hljs-punctuation">:</span> Agent&#x27;s stated intent

**Projection**<span class="hljs-punctuation">:</span> Work contexts are merged by `session_id` -- for contexts with
the same session<span class="hljs-punctuation">,</span> the one with the newer `git_updated_at` wins.

### Session Events

#### agent.session.start

Emitted when a session starts.

**When emitted**<span class="hljs-punctuation">:</span>

- After `session.start` RPC call succeeds
- When session start event is synced from remote

**Stored in**<span class="hljs-punctuation">:</span> `events.jsonl`

**Payload** (AgentSessionStartEvent)<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;agent.session.start&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T12:00:00Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;event_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;01HQXYZ...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;v&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;session_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;s_abc123&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;agent_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;furiosa&quot;</span>
<span class="hljs-punctuation">}</span>
```go

**Fields**<span class="hljs-punctuation">:</span>

- `event_id`<span class="hljs-punctuation">:</span> Globally unique ULID for deduplication
- `session_id`<span class="hljs-punctuation">:</span> Unique session identifier
- `agent_id`<span class="hljs-punctuation">:</span> Agent that owns this session
- `timestamp`<span class="hljs-punctuation">:</span> Session start time (ISO <span class="hljs-number">8601</span>)

**Session lifecycle**<span class="hljs-punctuation">:</span>

<span class="hljs-number">1.</span> Agent registers
<span class="hljs-number">2.</span> Session starts
<span class="hljs-number">3.</span> Agent sends/receives messages
<span class="hljs-number">4.</span> Session ends (gracefully or crash)
<span class="hljs-number">5.</span> Orphan recovery on next session start

**Related methods**<span class="hljs-punctuation">:</span> `session.start`<span class="hljs-punctuation">,</span> `session.end`

#### agent.session.end

Emitted when a session ends.

**When emitted**<span class="hljs-punctuation">:</span>

- After `session.end` RPC call succeeds
- When session end event is synced from remote
- When daemon detects a crashed session

**Stored in**<span class="hljs-punctuation">:</span> `events.jsonl`

**Payload** (AgentSessionEndEvent)<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;agent.session.end&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-01-01T13:00:00Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;event_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;01HQXYZ...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;v&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;session_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;s_abc123&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;normal&quot;</span>
<span class="hljs-punctuation">}</span>
```go

**Fields**<span class="hljs-punctuation">:</span>

- `event_id`<span class="hljs-punctuation">:</span> Globally unique ULID for deduplication
- `session_id`<span class="hljs-punctuation">:</span> Session that ended
- `timestamp`<span class="hljs-punctuation">:</span> Session end time (ISO <span class="hljs-number">8601</span>)
- `reason`<span class="hljs-punctuation">:</span> End reason (`normal`<span class="hljs-punctuation">,</span> `crash`)

**End reasons**<span class="hljs-punctuation">:</span>

- `normal`<span class="hljs-punctuation">:</span> Graceful shutdown
- `crash`<span class="hljs-punctuation">:</span> Unexpected termination or timeout

**Related methods**<span class="hljs-punctuation">:</span> `session.end`<span class="hljs-punctuation">,</span> `session.start`

## Subscription Filtering

Events are filtered based on active subscriptions<span class="hljs-punctuation">:</span>

### Scope-Based Subscriptions

Only receive events for messages that match the subscribed scope.

**Example**<span class="hljs-punctuation">:</span> Subscribe to all messages in task <span class="hljs-string">&quot;PROJ-123&quot;</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;subscribe.create&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;filter_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;scope&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;scope&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;task&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;PROJ-123&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
```go

**Matching logic**<span class="hljs-punctuation">:</span>

- Event&#x27;s `scopes` array contains an exact match for the subscribed scope
- Scope type and value must both match

### Mention-Based Subscriptions

Only receive events for messages that mention a specific role.

**Example**<span class="hljs-punctuation">:</span> Subscribe to messages mentioning <span class="hljs-string">&quot;@reviewer&quot;</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;subscribe.create&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;filter_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mention&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;mention&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;reviewer&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
```go

**Matching logic**<span class="hljs-punctuation">:</span>

- Event&#x27;s `refs` array contains a reference with `type<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mention&quot;</span>` and
  `value<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;reviewer&quot;</span>`

### All-Events Subscriptions

Receive all events (use with caution<span class="hljs-punctuation">,</span> high volume).

**Example**<span class="hljs-punctuation">:</span> Subscribe to all events

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;subscribe.create&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;filter_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;all&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
```go

**Use cases**<span class="hljs-punctuation">:</span>

- Admin dashboards
- Audit logging
- System monitoring

**Warning**<span class="hljs-punctuation">:</span> High traffic<span class="hljs-punctuation">,</span> may overwhelm slow clients

## Event Ordering

### Guarantees

- **Per-message ordering**<span class="hljs-punctuation">:</span> Events for the same message (create → edit → delete)
  are always in order
- **Cross-message ordering**<span class="hljs-punctuation">:</span> No guarantee; events may arrive out of order

### Timestamps

All events include ISO <span class="hljs-number">8601</span> timestamps. Use these for<span class="hljs-punctuation">:</span>

- Sorting events client-side
- Detecting out-of-order delivery
- Time-based filtering

### Sequence Numbers

Future enhancement<span class="hljs-punctuation">:</span> Add sequence numbers for detecting gaps.

## Client Buffer Management

### Buffer Limits

- Default buffer size<span class="hljs-punctuation">:</span> **<span class="hljs-number">100</span> events**
- Buffer is per-client (per WebSocket connection)
- When buffer is full<span class="hljs-punctuation">,</span> oldest events are dropped

### Buffer Full Behavior

<span class="hljs-number">1.</span> Client&#x27;s buffer fills up (slow consumer)
<span class="hljs-number">2.</span> New events are dropped (not queued)
<span class="hljs-number">3.</span> Client connection may be closed if buffer remains full

### Best Practices

<span class="hljs-number">1.</span> **Process events quickly**<span class="hljs-punctuation">:</span> Don&#x27;t block the event handler
<span class="hljs-number">2.</span> **Use background workers**<span class="hljs-punctuation">:</span> Offload heavy processing
<span class="hljs-number">3.</span> **Monitor buffer**<span class="hljs-punctuation">:</span> Watch for dropped events
<span class="hljs-number">4.</span> **Adjust subscriptions**<span class="hljs-punctuation">:</span> Subscribe only to necessary events

## Error Scenarios

### Missed Events

**Causes**<span class="hljs-punctuation">:</span>

- Client buffer full (slow consumer)
- WebSocket connection interruption
- Client disconnected during event delivery

**Detection**<span class="hljs-punctuation">:</span>

- Monitor timestamp gaps
- Track expected vs actual event counts

**Recovery**<span class="hljs-punctuation">:</span>

- Poll with `message.list` to catch up
- Re-subscribe after reconnection
- Use pagination to fetch missed messages

### Duplicate Events

**Causes**<span class="hljs-punctuation">:</span>

- Retry logic on server
- Network-level retransmission
- Multiple subscriptions matching same event

**Handling**<span class="hljs-punctuation">:</span>

- Use `event_id` (ULID) for deduplication -- this is the universal dedup key
  across all event types
- Maintain a set of processed event IDs
- Clear processed IDs periodically (TTL)

Note<span class="hljs-punctuation">:</span> Do not use `message_id` for deduplication<span class="hljs-punctuation">,</span> as multiple events can share
the same `message_id` (e.g.<span class="hljs-punctuation">,</span> a `message.create` and subsequent `message.edit`
for the same message).

## Best Practices

### Subscription Management

<span class="hljs-number">1.</span> **Specific filters**<span class="hljs-punctuation">:</span> Use scope/mention filters instead of <span class="hljs-string">&quot;all&quot;</span>
<span class="hljs-number">2.</span> **Cleanup**<span class="hljs-punctuation">:</span> Unsubscribe when no longer needed
<span class="hljs-number">3.</span> **Session-bound**<span class="hljs-punctuation">:</span> Subscriptions auto-expire when session ends

### Event Processing

<span class="hljs-number">1.</span> **Idempotent handlers**<span class="hljs-punctuation">:</span> Handle duplicate events gracefully
<span class="hljs-number">2.</span> **Error handling**<span class="hljs-punctuation">:</span> Don&#x27;t crash on malformed events
<span class="hljs-number">3.</span> **Async processing**<span class="hljs-punctuation">:</span> Don&#x27;t block WebSocket thread

### Performance

<span class="hljs-number">1.</span> **Batch updates**<span class="hljs-punctuation">:</span> Buffer UI updates<span class="hljs-punctuation">,</span> render in batches
<span class="hljs-number">2.</span> **Debounce**<span class="hljs-punctuation">:</span> Delay rapid successive events
<span class="hljs-number">3.</span> **Throttle**<span class="hljs-punctuation">:</span> Limit event processing rate

### Debugging

<span class="hljs-number">1.</span> **Log all events**<span class="hljs-punctuation">:</span> For development/debugging
<span class="hljs-number">2.</span> **Event counters**<span class="hljs-punctuation">:</span> Track received vs processed
<span class="hljs-number">3.</span> **Timestamp monitoring**<span class="hljs-punctuation">:</span> Detect delivery delays

## Example Event Handlers

### JavaScript/TypeScript

```typescript
const eventHandlers = <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;message.create&quot;</span><span class="hljs-punctuation">:</span> (params<span class="hljs-punctuation">:</span> MessageCreateEvent) =&gt; <span class="hljs-punctuation">{</span>
    console.log(`New message<span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>params.message_id<span class="hljs-punctuation">}</span>`);
    addMessageToUI(params);
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

  <span class="hljs-attr">&quot;message.edit&quot;</span><span class="hljs-punctuation">:</span> (params<span class="hljs-punctuation">:</span> MessageEditEvent) =&gt; <span class="hljs-punctuation">{</span>
    console.log(`Message edited<span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>params.message_id<span class="hljs-punctuation">}</span>`);
    updateMessageInUI(params);
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

  <span class="hljs-attr">&quot;message.delete&quot;</span><span class="hljs-punctuation">:</span> (params<span class="hljs-punctuation">:</span> MessageDeleteEvent) =&gt; <span class="hljs-punctuation">{</span>
    console.log(`Message deleted<span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>params.message_id<span class="hljs-punctuation">}</span>`);
    removeMessageFromUI(params);
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>;

ws.onmessage = (event) =&gt; <span class="hljs-punctuation">{</span>
  const msg = JSON.parse(event.data);

  <span class="hljs-comment">// Handle events (no id field)</span>
  if (!msg.id &amp;&amp; msg.method) <span class="hljs-punctuation">{</span>
    const handler = eventHandlers<span class="hljs-punctuation">[</span>msg.method<span class="hljs-punctuation">]</span>;
    if (handler) <span class="hljs-punctuation">{</span>
      handler(msg.params);
    <span class="hljs-punctuation">}</span> else <span class="hljs-punctuation">{</span>
      console.warn(`Unknown event type<span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>msg.method<span class="hljs-punctuation">}</span>`);
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>

  <span class="hljs-comment">// Handle RPC responses (has id field)</span>
  else if (msg.id) <span class="hljs-punctuation">{</span>
    handleRPCResponse(msg);
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>;
```go

### Go

```go
type EventHandler func(json.RawMessage) error

handlers <span class="hljs-punctuation">:</span>= map<span class="hljs-punctuation">[</span>string<span class="hljs-punctuation">]</span>EventHandler<span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;message.create&quot;</span><span class="hljs-punctuation">:</span> func(params json.RawMessage) error <span class="hljs-punctuation">{</span>
        var event types.MessageCreateEvent
        if err <span class="hljs-punctuation">:</span>= json.Unmarshal(params<span class="hljs-punctuation">,</span> &amp;event); err != nil <span class="hljs-punctuation">{</span>
            return err
        <span class="hljs-punctuation">}</span>
        log.Printf(<span class="hljs-string">&quot;New message: %s&quot;</span><span class="hljs-punctuation">,</span> event.MessageID)
        return addMessageToUI(event)
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

    <span class="hljs-attr">&quot;message.edit&quot;</span><span class="hljs-punctuation">:</span> func(params json.RawMessage) error <span class="hljs-punctuation">{</span>
        var event types.MessageEditEvent
        if err <span class="hljs-punctuation">:</span>= json.Unmarshal(params<span class="hljs-punctuation">,</span> &amp;event); err != nil <span class="hljs-punctuation">{</span>
            return err
        <span class="hljs-punctuation">}</span>
        log.Printf(<span class="hljs-string">&quot;Message edited: %s&quot;</span><span class="hljs-punctuation">,</span> event.MessageID)
        return updateMessageInUI(event)
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>

func handleMessage(data <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>byte) error <span class="hljs-punctuation">{</span>
    var msg struct <span class="hljs-punctuation">{</span>
        JSONRPC string          `json<span class="hljs-punctuation">:</span><span class="hljs-string">&quot;jsonrpc&quot;</span>`
        Method  string          `json<span class="hljs-punctuation">:</span><span class="hljs-string">&quot;method,omitempty&quot;</span>`
        Params  json.RawMessage `json<span class="hljs-punctuation">:</span><span class="hljs-string">&quot;params,omitempty&quot;</span>`
        ID      *int            `json<span class="hljs-punctuation">:</span><span class="hljs-string">&quot;id,omitempty&quot;</span>`
    <span class="hljs-punctuation">}</span>

    if err <span class="hljs-punctuation">:</span>= json.Unmarshal(data<span class="hljs-punctuation">,</span> &amp;msg); err != nil <span class="hljs-punctuation">{</span>
        return err
    <span class="hljs-punctuation">}</span>

    <span class="hljs-comment">// Event (no ID field)</span>
    if msg.ID == nil &amp;&amp; msg.Method != <span class="hljs-string">&quot;&quot;</span> <span class="hljs-punctuation">{</span>
        handler<span class="hljs-punctuation">,</span> ok <span class="hljs-punctuation">:</span>= handlers<span class="hljs-punctuation">[</span>msg.Method<span class="hljs-punctuation">]</span>
        if !ok <span class="hljs-punctuation">{</span>
            log.Printf(<span class="hljs-string">&quot;Unknown event: %s&quot;</span><span class="hljs-punctuation">,</span> msg.Method)
            return nil
        <span class="hljs-punctuation">}</span>
        return handler(msg.Params)
    <span class="hljs-punctuation">}</span>

    <span class="hljs-comment">// RPC response (has ID)</span>
    return handleRPCResponse(&amp;msg)
<span class="hljs-punctuation">}</span>
```text

## See Also

- <span class="hljs-punctuation">[</span>WebSocket API<span class="hljs-punctuation">]</span>(./websocket.md) - Main API documentation
- <span class="hljs-punctuation">[</span>Authentication Guide<span class="hljs-punctuation">]</span>(./authentication.md) - User and agent authentication</code></pre>

    </div>
    <p style="margin-top:2rem"><a href="../docs.html#api/events.html">&larr; View in documentation</a></p>
  </main>
  <script>
    // Redirect browsers to the SPA for full navigation experience.
    // Crawlers (which don't execute JS) will index the static content above.
    if (window.location.search.indexOf('nospa') === -1) {
      window.location.replace('../docs.html#api/events.html');
    }
  </script>
</body>
</html>