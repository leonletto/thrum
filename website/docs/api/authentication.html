<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authentication — Thrum</title>
  <meta name="description" content="Authentication and authorization in the Thrum API — agent identity, session tokens, and security model">
  <!-- Open Graph -->
  <meta property="og:type" content="article">
  <meta property="og:title" content="Authentication — Thrum">
  <meta property="og:description" content="Authentication and authorization in the Thrum API — agent identity, session tokens, and security model">
  <meta property="og:url" content="https://leonletto.github.io/thrum/docs/api/authentication.html">
  <meta property="og:site_name" content="Thrum">
  <meta property="og:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Authentication — Thrum">
  <meta name="twitter:description" content="Authentication and authorization in the Thrum API — agent identity, session tokens, and security model">
  <meta name="twitter:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <!-- Canonical: SPA is the primary URL -->
  <link rel="canonical" href="https://leonletto.github.io/thrum/docs.html#api/authentication.html">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x26A1;</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/theme.css">
  <link rel="stylesheet" href="../css/docs.css">
  <script>
    (function(){var t=localStorage.getItem('thrum-theme');if(t){document.documentElement.setAttribute('data-theme',t)}else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:light)').matches){document.documentElement.setAttribute('data-theme','light')}else{document.documentElement.setAttribute('data-theme','dark')}})();
  </script>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <nav class="header-nav">
        <a href="../index.html" class="logo">
          <span class="logo-glyph">&gt;_</span>
          <span class="logo-text">thrum</span>
        </a>
        <div class="nav-links">
          <a href="../index.html" class="nav-link">Home</a>
          <a href="../docs.html" class="nav-link nav-link-active">Docs</a>
          <a href="../about.html" class="nav-link">About</a>
          <a href="https://github.com/leonletto/thrum" class="nav-link nav-link-external" target="_blank" rel="noopener">GitHub</a>
        </div>
      </nav>
    </div>
  </header>
  <main class="docs-content" style="max-width:48rem;margin:2rem auto;padding:0 1.5rem">
    <div class="docs-content-inner">
<h2>Authentication Guide</h2>
<p>This document explains authentication and authorization in the Thrum API.</p>
<h2>Overview</h2>
<p>Thrum supports two types of identity:</p>
<ol>
<li><strong>Agents</strong>: Autonomous processes (bots, AI agents, services) that send and<br>receive messages</li>
<li><strong>Users</strong>: Human users accessing the system via WebSocket (typically through<br>the embedded web UI)</li>
</ol>
<p>Both agents and users are registered with the daemon and stored in the same<br><code>agents</code> table in SQLite (distinguished by the <code>kind</code> field: <code>&quot;agent&quot;</code> or<br><code>&quot;user&quot;</code>).</p>
<h2>Agent Authentication</h2>
<h3>Registration</h3>
<p>Agents register using the <code>agent.register</code> RPC method, available over both Unix<br>socket and WebSocket.</p>
<p><strong>Identity Components</strong>:</p>
<ul>
<li><code>name</code>: Human-readable agent name (optional; e.g., <code>&quot;furiosa&quot;</code>, <code>&quot;nux&quot;</code>)</li>
<li><code>role</code>: The agent&#39;s function (e.g., <code>&quot;implementer&quot;</code>, <code>&quot;reviewer&quot;</code>,<br><code>&quot;coordinator&quot;</code>)</li>
<li><code>module</code>: The area of responsibility (e.g., <code>&quot;auth&quot;</code>, <code>&quot;sync&quot;</code>, <code>&quot;ui&quot;</code>)</li>
<li><code>repo_id</code>: Automatically determined from the repository&#39;s git origin URL</li>
</ul>
<p><strong>Agent ID Format</strong>:</p>
<ul>
<li><strong>Named</strong>: <code>{name}</code> (e.g., <code>furiosa</code>)</li>
<li><strong>Unnamed</strong>: <code>{role}_{hash10}</code> (e.g., <code>implementer_35HV62T9B9</code>)</li>
<li><strong>Legacy</strong> (backward compatible): <code>agent:{role}:{hash}</code> -- no longer generated<br>but still recognized</li>
</ul>
<p>The hash is computed as<br><code>crockford_base32(sha256(repo_id + &quot;|&quot; + role + &quot;|&quot; + module))[:10]</code>.</p>
<p><strong>Example</strong> (named agent):</p>
<pre><code class="language-json hljs"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;agent.register&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;furiosa&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;role&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;implementer&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;module&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;display&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Auth Implementer&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
```text

**Response**<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;agent_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;furiosa&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;registered&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
```text

**Example** (unnamed agent)<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;agent.register&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;role&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;implementer&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;module&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
```text

**Response**<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;agent_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;implementer_35HV62T9B9&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;registered&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
```text

### Re-Registration

Agents can re-register with the same role/module/name. The same agent ID is
returned without writing a new event (idempotent). To force an update event<span class="hljs-punctuation">,</span> use
the `re_register` flag.

**Use cases**<span class="hljs-punctuation">:</span>

- Agent restart
- Daemon restart
- Network reconnection
- Updating display name

### Quickstart (CLI Shortcut)

The `quickstart` command combines registration<span class="hljs-punctuation">,</span> session start<span class="hljs-punctuation">,</span> and optional
intent setting<span class="hljs-punctuation">:</span>

```bash
thrum quickstart --name furiosa --role implementer --module auth --intent <span class="hljs-string">&quot;Working on auth&quot;</span>
```go

### Session Management

After registration<span class="hljs-punctuation">,</span> agents must start a session to send messages<span class="hljs-punctuation">:</span>

<span class="hljs-number">1.</span> **Register**<span class="hljs-punctuation">:</span> `agent.register` -&gt; get `agent_id`
<span class="hljs-number">2.</span> **Start session**<span class="hljs-punctuation">:</span> `session.start` with `agent_id` -&gt; get `session_id`
<span class="hljs-number">3.</span> **Heartbeat**<span class="hljs-punctuation">:</span> `session.heartbeat` to update last-seen time and extract git
   work context
<span class="hljs-number">4.</span> **Send messages**<span class="hljs-punctuation">:</span> Use `agent_id` in requests
<span class="hljs-number">5.</span> **End session**<span class="hljs-punctuation">:</span> `session.end` with `session_id`

**Why sessions?**

- Track agent activity periods
- Detect crashes (orphaned sessions)
- Attribute messages to specific runs
- Track git work context (branch<span class="hljs-punctuation">,</span> changed files<span class="hljs-punctuation">,</span> uncommitted work)

**Session IDs** use ULID format<span class="hljs-punctuation">:</span> `ses_` + ULID (e.g.<span class="hljs-punctuation">,</span>
`ses_01HXE8Z7R9K3Q6M2W8F4VY`).

### Identity Resolution for CLI

The CLI resolves agent identity using a priority chain (see `docs/identity.md`
for full details)<span class="hljs-punctuation">:</span>

<span class="hljs-number">1.</span> `THRUM_NAME` env var (selects identity file; highest priority)
<span class="hljs-number">2.</span> CLI flags (`--name`<span class="hljs-punctuation">,</span> `--role`<span class="hljs-punctuation">,</span> `--module`)
<span class="hljs-number">3.</span> Environment variables (`THRUM_ROLE`<span class="hljs-punctuation">,</span> `THRUM_MODULE`<span class="hljs-punctuation">,</span> `THRUM_DISPLAY`)
<span class="hljs-number">4.</span> Identity file in `.thrum/identities/` directory
<span class="hljs-number">5.</span> Error if required fields missing

### MCP Server Identity

The MCP server (`thrum mcp serve`) loads agent identity at startup from
`.thrum/identities/<span class="hljs-punctuation">{</span>name<span class="hljs-punctuation">}</span>.json`. It requires a named agent. Use `--agent-id`
flag or `THRUM_NAME` env var for multi-agent worktrees<span class="hljs-punctuation">:</span>

```bash
THRUM_NAME=furiosa thrum mcp serve
thrum mcp serve --agent-id furiosa
```text

## User Authentication

### WebSocket-Only

Users can **only** register via WebSocket (not Unix socket). This is enforced by
the daemon<span class="hljs-punctuation">:</span>

- Unix socket is for local agents (same machine<span class="hljs-punctuation">,</span> no UI)
- WebSocket is for browser connections (UI at `http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:9999`)</span>

Attempting `user.register` over Unix socket returns error code `<span class="hljs-number">-32001</span>`.

### Browser Auto-Registration

When a user opens the web UI at `http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:9999`, the browser</span>
automatically registers<span class="hljs-punctuation">:</span>

<span class="hljs-number">1.</span> **Connect**<span class="hljs-punctuation">:</span> WebSocket connects to `ws<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:9999/ws`</span>
<span class="hljs-number">2.</span> **Identify**<span class="hljs-punctuation">:</span> Call `user.identify` RPC to get git user info from the
   repository&#x27;s `git config`
<span class="hljs-number">3.</span> **Register**<span class="hljs-punctuation">:</span> Call `user.register` with the sanitized username
<span class="hljs-number">4.</span> **Persist**<span class="hljs-punctuation">:</span> Store user info and token in `localStorage` for reconnection

This flow is handled by the `AuthProvider` React component. No manual login is
required.

**Fallback**<span class="hljs-punctuation">:</span> If `git config user.name` is not set<span class="hljs-punctuation">,</span> the UI checks `localStorage`
for a previously stored username. If neither source is available<span class="hljs-punctuation">,</span> an error is
displayed.

### user.identify RPC

Returns git user info from the repository&#x27;s git config. No authentication needed
-- this is a read-only query. Available over both Unix socket and WebSocket.

**Response**<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;leon-letto&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;leon@example.com&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;display&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Leon Letto&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
```text

The `username` field is sanitized from `git config user.name`<span class="hljs-punctuation">:</span> lowercased<span class="hljs-punctuation">,</span>
spaces/hyphens/underscores normalized to hyphens<span class="hljs-punctuation">,</span> non-alphanumeric characters
stripped<span class="hljs-punctuation">,</span> truncated to <span class="hljs-number">32</span> characters.

### user.register RPC

Registers a user with the daemon. **Idempotent**<span class="hljs-punctuation">:</span> if the user already exists<span class="hljs-punctuation">,</span>
returns existing info with a fresh session token.

**Username Rules**<span class="hljs-punctuation">:</span>

- Alphanumeric characters<span class="hljs-punctuation">,</span> underscores<span class="hljs-punctuation">,</span> and hyphens
- Length <span class="hljs-number">1</span><span class="hljs-number">-32</span> characters
- Must not start with `agent<span class="hljs-punctuation">:</span>` prefix
- Regex<span class="hljs-punctuation">:</span> `^<span class="hljs-punctuation">[</span>a-zA-Z0<span class="hljs-number">-9</span>_-<span class="hljs-punctuation">]</span><span class="hljs-punctuation">{</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">32</span><span class="hljs-punctuation">}</span>$`

**User ID Format**<span class="hljs-punctuation">:</span> `user<span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span>username<span class="hljs-punctuation">}</span>` (e.g.<span class="hljs-punctuation">,</span> `user<span class="hljs-punctuation">:</span>leon`)

**Example**<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user.register&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;leon&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;display&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Leon Letto&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
```text

**Response**<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;user_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user:leon&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;leon&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;display_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Leon Letto&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;tok_01HXE8Z7R9K3Q6M2W8F4VY&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;registered&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
```text

When re-registering an existing user<span class="hljs-punctuation">,</span> the response has `<span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;existing&quot;</span>`
and a fresh token.

**Storage**<span class="hljs-punctuation">:</span> Users are stored internally as `agent.register` events with
`kind<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user&quot;</span>`<span class="hljs-punctuation">,</span> `role<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>username<span class="hljs-punctuation">}</span>`<span class="hljs-punctuation">,</span> and `module<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ui&quot;</span>`.

### localStorage Persistence

The browser stores user identity in `localStorage` under the `thrum_user` key<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;user_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user:leon&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;tok_...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;leon&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;display_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Leon Letto&quot;</span>
<span class="hljs-punctuation">}</span>
```text

On subsequent page loads<span class="hljs-punctuation">,</span> the stored username is used as a fallback if
`user.identify` fails.

## Authorization

### Impersonation

Users can impersonate agents to send messages <span class="hljs-string">&quot;as&quot;</span> an agent.

**Use case**<span class="hljs-punctuation">:</span> UI allowing users to send messages from an agent&#x27;s perspective.

**Restrictions**<span class="hljs-punctuation">:</span>

<span class="hljs-number">1.</span> **Only users can impersonate**<span class="hljs-punctuation">:</span> Agents cannot impersonate other agents or
   users
<span class="hljs-number">2.</span> **Only agents can be impersonated**<span class="hljs-punctuation">:</span> Users cannot impersonate other users
<span class="hljs-number">3.</span> **Target must exist**<span class="hljs-punctuation">:</span> The impersonated agent must be registered

**Example**<span class="hljs-punctuation">:</span>

```json
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;message.send&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Hello from Claude!&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;acting_as&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;furiosa&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
```text

**Audit Trail**<span class="hljs-punctuation">:</span>

- `authored_by`<span class="hljs-punctuation">:</span> Original user ID (e.g.<span class="hljs-punctuation">,</span> `<span class="hljs-string">&quot;user:leon&quot;</span>`)
- `disclosed`<span class="hljs-punctuation">:</span> Whether impersonation is revealed in UI (default<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>)
- `agent_id`<span class="hljs-punctuation">:</span> Impersonated agent ID (appears as message author)

**Validation**<span class="hljs-punctuation">:</span>

- Caller must be `user<span class="hljs-punctuation">:</span>*`
- `acting_as` must reference an existing agent
- `acting_as` cannot be a `user<span class="hljs-punctuation">:</span>*` ID

**Errors**<span class="hljs-punctuation">:</span>

- <span class="hljs-string">&quot;only users can impersonate agents&quot;</span> - Non-user caller attempted impersonation
- <span class="hljs-string">&quot;users can only impersonate agents, not other users&quot;</span> - User tried to
  impersonate another user
- <span class="hljs-string">&quot;agent not found&quot;</span> - Target agent does not exist

### Message Ownership

**Editing**<span class="hljs-punctuation">:</span> Only the message author can edit their own messages.

**Deletion**<span class="hljs-punctuation">:</span> Only the message author can delete their own messages.

**Author determination**<span class="hljs-punctuation">:</span>

- If `authored_by` is set (impersonation)<span class="hljs-punctuation">:</span> `authored_by` is the owner
- Otherwise<span class="hljs-punctuation">:</span> `agent_id` is the owner

**Example**<span class="hljs-punctuation">:</span> User <span class="hljs-string">&quot;leon&quot;</span> impersonates agent <span class="hljs-string">&quot;furiosa&quot;</span> to send a message<span class="hljs-punctuation">:</span>

- `agent_id`<span class="hljs-punctuation">:</span> `<span class="hljs-string">&quot;furiosa&quot;</span>` (appears as author)
- `authored_by`<span class="hljs-punctuation">:</span> `<span class="hljs-string">&quot;user:leon&quot;</span>` (actual owner)
- Only `<span class="hljs-string">&quot;user:leon&quot;</span>` can edit/delete this message

### Session-Based Authorization

All RPC requests include transport context with the caller&#x27;s identity.

**Transport context**<span class="hljs-punctuation">:</span>

- Unix socket<span class="hljs-punctuation">:</span> Agent identity (from environment or registration)
- WebSocket<span class="hljs-punctuation">:</span> User/agent identity (from registration)

**Implicit authorization**<span class="hljs-punctuation">:</span> The daemon knows which connection is making the
request.

**Use cases**<span class="hljs-punctuation">:</span>

- Prevent cross-session operations
- Attribute actions to sessions
- Audit trail

## Security Considerations

### Local Access (Unix Domain Socket)

Unix domain sockets (`$REPO/.thrum/daemon.sock`) provide inherent security<span class="hljs-punctuation">:</span>

<span class="hljs-number">1.</span> **No network exposure**<span class="hljs-punctuation">:</span> Socket files are not accessible over the network
<span class="hljs-number">2.</span> **Filesystem permissions**<span class="hljs-punctuation">:</span> Access controlled via file permissions
   (mode <span class="hljs-number">0600</span>)
<span class="hljs-number">3.</span> **Local-only**<span class="hljs-punctuation">:</span> Only processes on the same machine with appropriate
   permissions can connect

**Use cases**<span class="hljs-punctuation">:</span>

- CLI tools (`thrum` command)
- MCP server (`thrum mcp serve`)
- Local agents and automation scripts
- Development workflows

### Remote Access (Tailscale WireGuard)

For remote or multi-machine deployments<span class="hljs-punctuation">,</span> Thrum uses Tailscale&#x27;s WireGuard mesh
network<span class="hljs-punctuation">:</span>

<span class="hljs-number">1.</span> **End-to-end encryption**<span class="hljs-punctuation">:</span> All WebSocket traffic encrypted via WireGuard
   tunnel
<span class="hljs-number">2.</span> **Zero-trust networking**<span class="hljs-punctuation">:</span> Each peer authenticates via Tailscale identity
<span class="hljs-number">3.</span> **Automatic key rotation**<span class="hljs-punctuation">:</span> WireGuard keys managed by Tailscale
<span class="hljs-number">4.</span> **Pairing codes**<span class="hljs-punctuation">:</span> Initial connection uses time-limited pairing codes
<span class="hljs-number">5.</span> **Per-peer tokens**<span class="hljs-punctuation">:</span> Ongoing authentication via per-peer tokens after pairing

**Security properties**<span class="hljs-punctuation">:</span>

- WebSocket connections run over Tailscale&#x27;s encrypted tunnel (`ws<span class="hljs-punctuation">:</span><span class="hljs-comment">//` over</span>
  WireGuard)
- No separate TLS/SSL layer needed
- Network isolation via Tailscale ACLs
- Authentication handled by Tailscale identity + Thrum pairing

**Reference**<span class="hljs-punctuation">:</span> See `docs/tailscale-security.md` for detailed security model and
threat analysis.

### Authentication Layers

<span class="hljs-number">1.</span> **Transport layer**<span class="hljs-punctuation">:</span> Tailscale WireGuard encryption and peer authentication
<span class="hljs-number">2.</span> **Application layer**<span class="hljs-punctuation">:</span> Thrum pairing codes and per-peer tokens
<span class="hljs-number">3.</span> **Session layer**<span class="hljs-punctuation">:</span> Session management and heartbeat tracking
<span class="hljs-number">4.</span> **Message layer**<span class="hljs-punctuation">:</span> Author attribution and ownership verification

## Session Lifecycle

### Agent Sessions

```text
<span class="hljs-number">1.</span> Agent starts
   |
<span class="hljs-number">2.</span> Connect to daemon (Unix socket or WebSocket)
   |
<span class="hljs-number">3.</span> Register<span class="hljs-punctuation">:</span> agent.register (with optional name)
   |
<span class="hljs-number">4.</span> Start session<span class="hljs-punctuation">:</span> session.start
   |
<span class="hljs-number">5.</span> Send/receive messages<span class="hljs-punctuation">,</span> heartbeat periodically
   |
<span class="hljs-number">6.</span> End session<span class="hljs-punctuation">:</span> session.end (or crash)
   |
<span class="hljs-number">7.</span> Disconnect
```text

Or use `quickstart` to combine steps <span class="hljs-number">3</span><span class="hljs-number">-4</span> (and optionally set intent)<span class="hljs-punctuation">:</span>

```text
<span class="hljs-number">1.</span> Agent starts
   |
<span class="hljs-number">2.</span> Connect to daemon
   |
<span class="hljs-number">3.</span> Quickstart<span class="hljs-punctuation">:</span> agent.register + session.start + set-intent
   |
<span class="hljs-number">4.</span> Send/receive messages<span class="hljs-punctuation">,</span> heartbeat periodically
   |
<span class="hljs-number">5.</span> End session<span class="hljs-punctuation">:</span> session.end (or crash)
   |
<span class="hljs-number">6.</span> Disconnect
```text

### User Sessions

```text
<span class="hljs-number">1.</span> User opens UI at http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:9999</span>
   |
<span class="hljs-number">2.</span> WebSocket connects to ws<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:9999/ws</span>
   |
<span class="hljs-number">3.</span> Auto-identify<span class="hljs-punctuation">:</span> user.identify (reads git config)
   |
<span class="hljs-number">4.</span> Auto-register<span class="hljs-punctuation">:</span> user.register (idempotent<span class="hljs-punctuation">,</span> returns token)
   |
<span class="hljs-number">5.</span> Send/receive messages<span class="hljs-punctuation">,</span> subscribe to events
   |
<span class="hljs-number">6.</span> Disconnect (session persists for reconnection)
```text

### Orphaned Sessions

**Problem**<span class="hljs-punctuation">:</span> Agent crashes without calling `session.end`.

**Detection**<span class="hljs-punctuation">:</span> When agent re-registers and starts a new session<span class="hljs-punctuation">,</span> the daemon
detects existing open sessions for that agent.

**Recovery**<span class="hljs-punctuation">:</span> Orphaned sessions are automatically ended with `reason<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;crash&quot;</span>`
during the next `session.start` call.

### Daemon Lifecycle Hardening

The daemon has several safety mechanisms for robust session management<span class="hljs-punctuation">:</span>

- **Defer cleanup**<span class="hljs-punctuation">:</span> Safety net catches panics/early returns<span class="hljs-punctuation">,</span> cleans up PID
  file<span class="hljs-punctuation">,</span> socket<span class="hljs-punctuation">,</span> and port files on any exit
- **JSON PID file**<span class="hljs-punctuation">:</span> Contains `<span class="hljs-punctuation">{</span>PID<span class="hljs-punctuation">,</span> RepoPath<span class="hljs-punctuation">,</span> StartedAt<span class="hljs-punctuation">,</span> SocketPath<span class="hljs-punctuation">}</span>` for
  repo-affinity validation
- **Socket flock**<span class="hljs-punctuation">:</span> OS-level file lock (`flock`) on the socket file<span class="hljs-punctuation">,</span>
  auto-released on process death (even SIGKILL)
- **Pre-startup validation**<span class="hljs-punctuation">:</span> Detects duplicate daemons serving the same
  repository before starting

## Connection Security

### Unix Socket

**Path**<span class="hljs-punctuation">:</span> `$REPO/.thrum/daemon.sock` (follows `.thrum/redirect` in worktrees)

**Access control**<span class="hljs-punctuation">:</span> File system permissions (<span class="hljs-number">0600</span>)

**Security**<span class="hljs-punctuation">:</span> Only processes with read/write access to the socket file can
connect.

**Use cases**<span class="hljs-punctuation">:</span>

- Local agents (same machine as daemon)
- CLI tools
- MCP server (`thrum mcp serve`)
- Trusted local services

### WebSocket

**Endpoint**<span class="hljs-punctuation">:</span> `ws<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:9999/ws` (when UI is embedded)</span>

**Fallback**<span class="hljs-punctuation">:</span> `ws<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:9999/` (when no UI is embedded, backward</span>
compatible)

**Bind address**<span class="hljs-punctuation">:</span> `<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>` (localhost only)

**Security**<span class="hljs-punctuation">:</span> Only processes on the same machine can connect.

**Use cases**<span class="hljs-punctuation">:</span>

- Web UI (browser on same machine<span class="hljs-punctuation">,</span> served as embedded SPA)
- Desktop applications
- Remote tunneling (SSH port forwarding)

**Warning**<span class="hljs-punctuation">:</span> Do not expose WebSocket port to untrusted networks without TLS and
authentication.

## Best Practices

### Agent Development

<span class="hljs-number">1.</span> **Use quickstart**<span class="hljs-punctuation">:</span> Prefer `thrum quickstart` over manual register + session
   start
<span class="hljs-number">2.</span> **Use named agents**<span class="hljs-punctuation">:</span> Provide `--name` for human-readable identification
<span class="hljs-number">3.</span> **Graceful shutdown**<span class="hljs-punctuation">:</span> Always call `session.end` before exiting
<span class="hljs-number">4.</span> **Error handling**<span class="hljs-punctuation">:</span> Catch crashes<span class="hljs-punctuation">,</span> end session in cleanup
<span class="hljs-number">5.</span> **Heartbeat regularly**<span class="hljs-punctuation">:</span> Call `session.heartbeat` to update work context and
   stay visible
<span class="hljs-number">6.</span> **Idempotent registration**<span class="hljs-punctuation">:</span> Safe to call `agent.register` multiple times

### User Clients

<span class="hljs-number">1.</span> **Auto-registration**<span class="hljs-punctuation">:</span> Let the `AuthProvider` handle identity automatically
<span class="hljs-number">2.</span> **Reconnection**<span class="hljs-punctuation">:</span> Re-register with same username after disconnect
   (idempotent)
<span class="hljs-number">3.</span> **Session management**<span class="hljs-punctuation">:</span> Let daemon manage session lifecycle
<span class="hljs-number">4.</span> **Impersonation disclosure**<span class="hljs-punctuation">:</span> Set `disclosed<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>` for transparency
<span class="hljs-number">5.</span> **Error handling**<span class="hljs-punctuation">:</span> Handle authorization errors gracefully

### Security

<span class="hljs-number">1.</span> **Local only**<span class="hljs-punctuation">:</span> Do not expose daemon to network without authentication
<span class="hljs-number">2.</span> **Principle of least privilege**<span class="hljs-punctuation">:</span> Subscribe only to necessary events
<span class="hljs-number">3.</span> **Audit logging**<span class="hljs-punctuation">:</span> Log all user actions for accountability
<span class="hljs-number">4.</span> **Input validation**<span class="hljs-punctuation">:</span> Validate all user input before sending to daemon

## Examples

### Agent Registration and Session (CLI)

```bash
# One-step quickstart (recommended)
thrum quickstart --name furiosa --role implementer --module auth \
  --intent <span class="hljs-string">&quot;Implementing JWT authentication&quot;</span>

# Or step-by-step
thrum agent register --name=furiosa --role=implementer --module=auth
thrum session start
thrum send <span class="hljs-string">&quot;Starting work on auth module&quot;</span> --to @coordinator
```go

### Agent Registration and Session (WebSocket)

```typescript
import WebSocket from <span class="hljs-string">&quot;ws&quot;</span>;

const ws = new WebSocket(<span class="hljs-string">&quot;ws://localhost:9999/ws&quot;</span>);

let agentId<span class="hljs-punctuation">:</span> string;
let sessionId<span class="hljs-punctuation">:</span> string;

ws.on(<span class="hljs-string">&quot;open&quot;</span><span class="hljs-punctuation">,</span> async () =&gt; <span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// Step 1: Register agent</span>
  ws.send(
    JSON.stringify(<span class="hljs-punctuation">{</span>
      jsonrpc<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
      method<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;agent.register&quot;</span><span class="hljs-punctuation">,</span>
      params<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        name<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;furiosa&quot;</span><span class="hljs-punctuation">,</span>
        role<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;implementer&quot;</span><span class="hljs-punctuation">,</span>
        module<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      id<span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">}</span>)<span class="hljs-punctuation">,</span>
  );
<span class="hljs-punctuation">}</span>);

ws.on(<span class="hljs-string">&quot;message&quot;</span><span class="hljs-punctuation">,</span> (data<span class="hljs-punctuation">:</span> string) =&gt; <span class="hljs-punctuation">{</span>
  const msg = JSON.parse(data);

  if (msg.id === <span class="hljs-number">1</span>) <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// Registration response</span>
    agentId = msg.result.agent_id;

    <span class="hljs-comment">// Step 2: Start session</span>
    ws.send(
      JSON.stringify(<span class="hljs-punctuation">{</span>
        jsonrpc<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
        method<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;session.start&quot;</span><span class="hljs-punctuation">,</span>
        params<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> agent_id<span class="hljs-punctuation">:</span> agentId <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        id<span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">}</span>)<span class="hljs-punctuation">,</span>
    );
  <span class="hljs-punctuation">}</span>

  if (msg.id === <span class="hljs-number">2</span>) <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// Session start response</span>
    sessionId = msg.result.session_id;
    console.log(`Agent registered<span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>agentId<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> Session<span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>sessionId<span class="hljs-punctuation">}</span>`);

    <span class="hljs-comment">// Now ready to send messages</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>);
```text

### MCP Server (Native Agent Messaging)

```bash
# Start MCP server for Claude Code integration
THRUM_NAME=furiosa thrum mcp serve

# Or with explicit agent-id override
thrum mcp serve --agent-id furiosa
```text

The MCP server provides <span class="hljs-number">5</span> tools<span class="hljs-punctuation">:</span> `send_message`<span class="hljs-punctuation">,</span> `check_messages`<span class="hljs-punctuation">,</span>
`wait_for_message`<span class="hljs-punctuation">,</span> `list_agents`<span class="hljs-punctuation">,</span> `broadcast_message`. Identity is resolved
once at startup.

### User Registration (Browser Auto-Registration)

The browser handles registration automatically via `AuthProvider`. No manual
code is needed. The flow is<span class="hljs-punctuation">:</span>

```text
Page loads -&gt; AuthProvider mounts -&gt; user.identify -&gt; user.register -&gt; UI shows identity
```text

For programmatic WebSocket user registration<span class="hljs-punctuation">:</span>

```typescript
const ws = new WebSocket(<span class="hljs-string">&quot;ws://localhost:9999/ws&quot;</span>);

ws.on(<span class="hljs-string">&quot;open&quot;</span><span class="hljs-punctuation">,</span> () =&gt; <span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// User registration (idempotent)</span>
  ws.send(
    JSON.stringify(<span class="hljs-punctuation">{</span>
      jsonrpc<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span>
      method<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user.register&quot;</span><span class="hljs-punctuation">,</span>
      params<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        username<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;leon&quot;</span><span class="hljs-punctuation">,</span>
        display<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Leon Letto&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      id<span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">}</span>)<span class="hljs-punctuation">,</span>
  );
<span class="hljs-punctuation">}</span>);

ws.on(<span class="hljs-string">&quot;message&quot;</span><span class="hljs-punctuation">,</span> (data<span class="hljs-punctuation">:</span> string) =&gt; <span class="hljs-punctuation">{</span>
  const msg = JSON.parse(data);

  if (msg.id === <span class="hljs-number">1</span>) <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// User registered</span>
    console.log(`User<span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>msg.result.user_id<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> Token<span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>msg.result.token<span class="hljs-punctuation">}</span>`);
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>);
```text

## See Also

- <span class="hljs-punctuation">[</span>Identity &amp; Registration<span class="hljs-punctuation">]</span>(../identity.md) - Full agent identity system
  documentation
- <span class="hljs-punctuation">[</span>WebSocket API<span class="hljs-punctuation">]</span>(./websocket.md) - Full API reference
- <span class="hljs-punctuation">[</span>Event Reference<span class="hljs-punctuation">]</span>(./events.md) - Event types and payloads</code></pre>

    </div>
    <p style="margin-top:2rem"><a href="../docs.html#api/authentication.html">&larr; View in documentation</a></p>
  </main>
  <script>
    // Redirect browsers to the SPA for full navigation experience.
    // Crawlers (which don't execute JS) will index the static content above.
    if (window.location.search.indexOf('nospa') === -1) {
      window.location.replace('../docs.html#api/authentication.html');
    }
  </script>
</body>
</html>