<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Identity & Registration — Thrum</title>
  <meta name="description" content="Named agents, deterministic IDs, identity resolution, registration, conflicts, cleanup, and multi-agent worktrees">
  <!-- Open Graph -->
  <meta property="og:type" content="article">
  <meta property="og:title" content="Agent Identity &amp; Registration — Thrum">
  <meta property="og:description" content="Named agents, deterministic IDs, identity resolution, registration, conflicts, cleanup, and multi-agent worktrees">
  <meta property="og:url" content="https://leonletto.github.io/thrum/docs/identity.html">
  <meta property="og:site_name" content="Thrum">
  <meta property="og:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Agent Identity &amp; Registration — Thrum">
  <meta name="twitter:description" content="Named agents, deterministic IDs, identity resolution, registration, conflicts, cleanup, and multi-agent worktrees">
  <meta name="twitter:image" content="https://leonletto.github.io/thrum/img/social-card.png">
  <!-- Canonical: SPA is the primary URL -->
  <link rel="canonical" href="https://leonletto.github.io/thrum/docs.html#identity.html">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x26A1;</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/theme.css">
  <link rel="stylesheet" href="../css/docs.css">
  <script>
    (function(){var t=localStorage.getItem('thrum-theme');if(t){document.documentElement.setAttribute('data-theme',t)}else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:light)').matches){document.documentElement.setAttribute('data-theme','light')}else{document.documentElement.setAttribute('data-theme','dark')}})();
  </script>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <nav class="header-nav">
        <a href="../index.html" class="logo">
          <span class="logo-glyph">&gt;_</span>
          <span class="logo-text">thrum</span>
        </a>
        <div class="nav-links">
          <a href="../index.html" class="nav-link">Home</a>
          <a href="../docs.html" class="nav-link nav-link-active">Docs</a>
          <a href="../about.html" class="nav-link">About</a>
          <a href="https://github.com/leonletto/thrum" class="nav-link nav-link-external" target="_blank" rel="noopener">GitHub</a>
        </div>
      </nav>
    </div>
  </header>
  <main class="docs-content" style="max-width:48rem;margin:2rem auto;padding:0 1.5rem">
    <div class="docs-content-inner">
<h2>Agent Identity &amp; Registration</h2>
<h2>Overview</h2>
<p>Thrum uses a flexible identity system that supports both human-readable named<br>agents and deterministic hash-based IDs. Each agent is identified by a<br>combination of <strong>name</strong> (optional), <strong>role</strong>, and <strong>module</strong> within a<br>repository. Identity files are stored per-agent in<br><code>.thrum/identities/{name}.json</code>, supporting multiple agents per worktree.</p>
<h2>Identity Components</h2>
<h3>Agent ID</h3>
<p>Agents can have one of two ID formats:</p>
<p><strong>Named agents</strong> (recommended):</p>
<pre><code class="language-text hljs">furiosa
```text

When a `--name` flag or `THRUM_NAME` env var is provided, the name **is** the
agent ID. The name becomes the canonical identifier for display, messaging
(`@furiosa`), and file paths.

**Unnamed agents** (hash-based fallback):

```text
coordinator_1B9K33T6RK
```text

When no name is provided, the agent ID is generated deterministically:

```text
hash = crockford_base32(sha256(repo_id + &quot;|&quot; + role + &quot;|&quot; + module))[:10]
agent_id = role + &quot;_&quot; + hash
```text

This means:

- **Same role+module** in the same repository with no name set produces the
  **same agent ID**
- Different repositories produce different agent IDs (even with same
  role+module)
- Named agents always use their name as the ID regardless of role/module

**Legacy format** (backward compatible):

```text
agent:implementer:9F2K3M1Q8Z
```go

The `agent:{role}:{hash}` format is still recognized for backward compatibility
but is no longer generated. Legacy IDs are converted internally via
`AgentIDToName()`.

### Agent Name

Human-readable name for the agent. Names are validated with strict rules:

- **Allowed characters**: lowercase letters (`a-z`), digits (`0-9`), underscores
  (`_`)
- **Rejected**: hyphens, dots, spaces, path separators, uppercase, special
  characters
- **Reserved names**: `daemon`, `system`, `thrum`, `all`, `broadcast`
- **Cannot be empty** (when explicitly provided)
- **Cannot equal the role** (v0.4.5+): names that match the role are rejected to
  prevent routing ambiguity. Use a distinct name, e.g.
  `--name coord_main --role coordinator` instead of
  `--name coordinator --role coordinator`.

Names must be safe for: file paths, `@mention` targets, JSONL field values, and
git tracking.

**Validation regex**: `^[a-z0-9_]+$`

### Role

The agent&#x27;s **role** describes what type of work they do.

Common roles:

- `implementer` - Writes code, implements features
- `planner` - Designs architecture, plans work
- `reviewer` - Reviews code, provides feedback
- `tester` - Writes and runs tests
- `coordinator` - Coordinates work across agents

Roles are **user-defined** and can be anything that makes sense for your
workflow.

### Module

The **module** describes which part of the codebase the agent is responsible
for.

Common modules:

- Component names: `auth`, `sync-daemon`, `cli`, `ui`
- Feature areas: `authentication`, `messaging`, `notifications`
- System boundaries: `backend`, `frontend`, `api`

Modules help:

- Organize agent responsibilities
- Prevent conflicts (different agents working on same area)
- Track which agent worked on which code

### Display Name

Optional human-readable display name for UI presentation.

Examples:

- &quot;Auth Implementer&quot;
- &quot;Claude (Planner)&quot;
- &quot;Test Runner Bot&quot;

Set via `--display` flag, `THRUM_DISPLAY` env var, or the `display` field in the
identity file.

## Identity Resolution

Thrum resolves agent identity using a priority chain:

```text
1. THRUM_NAME env var → selects identity file     [Highest priority]
   ↓
2. --agent-id flag (CLI)
   ↓
3. CLI flags (--name, --role, --module)
   ↓
4. Environment variables (THRUM_ROLE, THRUM_MODULE, THRUM_DISPLAY)
   ↓
5. Identity file auto-selection (.thrum/identities/ directory)
   ↓
6. Error if required fields missing                [Lowest priority]
```text

### Environment Variables

```bash
export THRUM_NAME=furiosa          # Select identity file (highest priority)
export THRUM_ROLE=implementer      # Override role
export THRUM_MODULE=auth           # Override module
export THRUM_DISPLAY=&quot;Auth Agent&quot;  # Override display name
```text

`THRUM_NAME` environment variable takes highest priority in identity resolution,
overriding the `--agent-id` flag and identity file auto-selection. It is the
primary way to select which identity file to load, especially in multi-agent
worktrees. It is also used by external orchestrators (e.g., Gastown) to inject
identity into agent processes.

When `THRUM_NAME` is set and the corresponding identity file does not exist,
loading **fails** rather than falling back to env vars. This ensures validation
errors are not silently ignored.

`THRUM_ROLE` and `THRUM_MODULE` override the role and module from any identity
file but do not affect which file is loaded.

Use environment variables when:

- Running in CI/CD pipelines
- Automating agent workflows
- External orchestrators inject identity
- Temporary identity changes

### CLI Flags

```bash
thrum agent register --name=furiosa --role=implementer --module=auth
thrum quickstart --name furiosa --role implementer --module auth --intent &quot;Working on auth&quot;
```text

CLI flags (`--role`, `--module`) override environment variables and identity
file settings. The `--name` flag is available on `quickstart` and
`agent register`.

**Priority exception**: `THRUM_NAME` env var overrides the `--name` CLI flag.
This allows orchestrators to control identity even when scripts pass a `--name`
argument.

### Identity Files

Identity files are stored in `.thrum/identities/` as individual JSON files named
after the agent:

```text
.thrum/identities/
├── furiosa.json           # Named agent
├── nux.json               # Named agent
└── coordinator_1B9K33T6RK.json  # Unnamed agent (hash-based)
```text

**Identity file format** (version 2):

```json
{
  &quot;version&quot;: 2,
  &quot;repo_id&quot;: &quot;r_7K2Q1X9M3P0B&quot;,
  &quot;agent&quot;: {
    &quot;kind&quot;: &quot;agent&quot;,
    &quot;name&quot;: &quot;furiosa&quot;,
    &quot;role&quot;: &quot;implementer&quot;,
    &quot;module&quot;: &quot;auth&quot;,
    &quot;display&quot;: &quot;Auth Implementer&quot;
  },
  &quot;worktree&quot;: &quot;auth&quot;,
  &quot;confirmed_by&quot;: &quot;human:leon&quot;,
  &quot;updated_at&quot;: &quot;2026-02-03T18:02:10.000Z&quot;
}
```text

**Auto-selection rules** for identity files:

1. If `THRUM_NAME` is set, load `{THRUM_NAME}.json` directly (error if not
   found)
2. If only **one** `.json` file exists in `identities/`, load it automatically
   (solo-agent worktree backward compatibility)
3. If **multiple** files exist and no `THRUM_NAME` is set, return an error
   asking the user to set `THRUM_NAME`

Use identity files when:

- You want persistent identity across sessions
- Working in a dedicated worktree for a specific module
- Running multiple agents in the same worktree
- Want to avoid setting env vars every time

### Name-to-File Mapping

The agent name directly maps to both identity and message files:

| Agent Name               | Identity File                                   | Message File                            |
| ------------------------ | ----------------------------------------------- | --------------------------------------- |
| `furiosa`                | `.thrum/identities/furiosa.json`                | `messages/furiosa.jsonl`                |
| `nux`                    | `.thrum/identities/nux.json`                    | `messages/nux.jsonl`                    |
| `coordinator_1B9K33T6RK` | `.thrum/identities/coordinator_1B9K33T6RK.json` | `messages/coordinator_1B9K33T6RK.jsonl` |

Message files are stored in the sync worktree at
`.git/thrum-sync/a-sync/messages/`.

## Registration

### First-Time Registration

When an agent registers for the first time:

1. Agent calls `agent.register` with role, module, and optional name
2. Daemon generates agent ID (name if provided, otherwise `{role}_{hash}`)
3. Daemon checks for conflicts (same name or same role+module)
4. If no conflict:
   - Writes `agent.register` event to JSONL (in
     `.git/thrum-sync/a-sync/events.jsonl`)
   - Updates SQLite agents table
   - Returns `{agent_id, status: &quot;registered&quot;}`

### Same Agent Returning

When an agent with the **same agent ID** registers again:

- **Without `re_register` flag:** Succeeds silently (no event written), returns
  `{status: &quot;registered&quot;}`
- **With `re_register` flag:** Updates registration (writes event with status
  &quot;updated&quot;)

This allows agents to:

- Resume work after daemon restart
- Update their display name
- Refresh registration without conflict

### Re-registration

Use the `re_register` flag when:

- You lost the identity file but know your role+module
- You want to update your display name
- You want to explicitly refresh your registration

```json
{
  &quot;name&quot;: &quot;furiosa&quot;,
  &quot;role&quot;: &quot;implementer&quot;,
  &quot;module&quot;: &quot;auth&quot;,
  &quot;re_register&quot;: true
}
```text

Response:

```json
{
  &quot;agent_id&quot;: &quot;furiosa&quot;,
  &quot;status&quot;: &quot;updated&quot;
}
```text

### Quickstart (Recommended)

The `quickstart` command combines registration, session start, and intent
setting into one step:

```bash
thrum quickstart --name furiosa --role implementer --module auth --intent &quot;Working on auth&quot;
```text

This chains: `agent.register` -&gt; `session.start` -&gt; `session.setIntent` (if
intent provided). If a conflict occurs, it automatically retries with
re-register.

## Conflict Detection

A conflict occurs when:

- A **different agent** (different agent ID) tries to register with the **same
  role+module** as an existing registered agent
- A different agent tries to use the **same name** as an existing agent

### Conflict Response

When conflict is detected:

```json
{
  &quot;agent_id&quot;: &quot;&quot;,
  &quot;status&quot;: &quot;conflict&quot;,
  &quot;conflict&quot;: {
    &quot;existing_agent_id&quot;: &quot;furiosa&quot;,
    &quot;registered_at&quot;: &quot;2026-02-03T10:00:00Z&quot;,
    &quot;last_seen_at&quot;: &quot;2026-02-03T12:00:00Z&quot;
  }
}
```text

### Conflict Resolution Options

#### 1. Change Your Role or Module

The simplest solution -- pick a different area:

```bash
thrum quickstart --name nux --role implementer --module auth_testing
```text

#### 2. Use `--force` Flag

Override the existing agent (you take ownership):

```json
{
  &quot;name&quot;: &quot;furiosa&quot;,
  &quot;role&quot;: &quot;implementer&quot;,
  &quot;module&quot;: &quot;auth&quot;,
  &quot;force&quot;: true
}
```text

**Warning:** This is destructive. The previous agent&#x27;s database entry is deleted
and replaced. Only use when:

- The previous agent is no longer active
- You are taking over responsibility for this module
- You have coordinated with the team

#### 3. Coordinate with Team

Before using `--force`:

1. Check who the existing agent is
2. Verify they are not actively working
3. Coordinate the handoff
4. Document the change

### Why Conflicts Matter

Conflicts prevent:

- **Accidental overwrites** - Two agents editing same code
- **Unclear ownership** - Who is responsible for this module?
- **Lost work** - Messages/sessions attributed to wrong agent

The conflict system ensures **intentional coordination** when multiple agents
work on the same module.

## Agent Deletion and Cleanup

### Deleting a Single Agent

```bash
thrum agent delete furiosa
```text

This removes:

- Identity file (`.thrum/identities/furiosa.json`)
- Message file (`.git/thrum-sync/a-sync/messages/furiosa.jsonl`)
- SQLite database record
- Emits an `agent.cleanup` event in `events.jsonl`

### Orphan Detection and Cleanup

```bash
# Preview orphaned agents (dry-run)
thrum agent cleanup --dry-run

# Delete all orphans without prompting
thrum agent cleanup --force
```text

The cleanup command detects orphaned agents by checking:

- Whether the agent&#x27;s identity file still exists
- Whether the agent&#x27;s worktree still exists (if applicable)
- How long since the agent was last seen

Orphaned agents are those with:

- Missing identity files
- Missing worktrees
- Stale last-seen timestamps exceeding the threshold

## Identity File Best Practices

### Worktree-Specific Identity

When using git worktrees for different features/modules, each worktree can have
its own identity files:

```bash
# Main worktree - coordinator (name must differ from role)
thrum quickstart --name coord_main --role coordinator --module all

# Auth worktree - auth implementer
cd ~/.workspaces/myapp/auth
thrum quickstart --name furiosa --role implementer --module auth

# Sync worktree - sync implementer
cd ~/.workspaces/myapp/sync
thrum quickstart --name nux --role implementer --module sync
```text

Each worktree gets its own `.thrum/identities/` directory (or uses
`.thrum/redirect` to share a common `.thrum/` directory).

### Multi-Agent Worktrees

Multiple agents can operate in the same worktree. Each gets a separate identity
file:

```text
.thrum/identities/
├── furiosa.json     # agent working on implementation
├── reviewer.json    # agent reviewing code
```text

Use `THRUM_NAME` to select which identity to use:

```bash
THRUM_NAME=furiosa thrum send &quot;Implementation complete&quot;
THRUM_NAME=reviewer thrum send &quot;LGTM, approved&quot;
```text

### Gitignore Identity Files

**Important:** The `.thrum/` directory is gitignored on the main branch.
Identity files are **local configuration**, not project code. They should NOT be
committed because:

- Different developers have different roles/modules
- Identity files contain agent-specific information
- Would cause conflicts in version control

## Common Workflows

### New Agent Setup

```bash
# One-step setup (recommended)
thrum quickstart --name furiosa --role implementer --module auth --intent &quot;Starting auth work&quot;

# Or step-by-step
thrum agent register --name=furiosa --role=implementer --module=auth
thrum session start
thrum send &quot;Starting work on auth module&quot;
```text

### Check Current Identity

```bash
# See who you are and if you have an active session
thrum agent whoami
```text

Response:

```json
{
  &quot;agent_id&quot;: &quot;furiosa&quot;,
  &quot;role&quot;: &quot;implementer&quot;,
  &quot;module&quot;: &quot;auth&quot;,
  &quot;display&quot;: &quot;Auth Agent&quot;,
  &quot;source&quot;: &quot;identity_file&quot;,
  &quot;session_id&quot;: &quot;ses_01HXE8Z7R9K3Q6M2W8F4VY&quot;,
  &quot;session_start&quot;: &quot;2026-02-03T10:00:00Z&quot;
}
```text

### List All Agents

```bash
# See all registered agents
thrum agent list

# Filter by role
thrum agent list --role=implementer

# Filter by module
thrum agent list --module=auth
```go

### MCP Server Identity

The MCP server (`thrum mcp serve`) resolves identity at startup from
`.thrum/identities/{name}.json`. In multi-agent worktrees, use the `--agent-id`
flag or `THRUM_NAME` env var:

```bash
# Use THRUM_NAME
THRUM_NAME=furiosa thrum mcp serve

# Or use --agent-id flag
thrum mcp serve --agent-id furiosa
```text

The MCP server requires a named agent (the `name` field must be set in the
identity file).

### Git Username (user.identify)

The Web UI and MCP server use `user.identify` to read the git username from
`git config user.name`. This username is used to auto-register a browser agent
in the Web UI (via `user.register`) and to associate the WebSocket session with
a human identity. The git username is read at connection time — no separate
configuration is needed beyond having a valid `git config user.name` set in your
environment.

## ID Generation Functions

All ID generation is in `internal/identity/identity.go`. Thrum uses
[ULID](https://github.com/ulid/spec) (Universally Unique Lexicographically
Sortable Identifier) for all unique IDs, and deterministic hashing for agent and
repository IDs.

### ULID-Based IDs

ULIDs provide globally unique, lexicographically sortable identifiers with
embedded timestamps. They are generated using monotonic entropy with mutex
protection for thread safety.

| ID Type       | Format        | Example                      | Purpose                      |
| ------------- | ------------- | ---------------------------- | ---------------------------- |
| Session ID    | `ses_` + ULID | `ses_01HXE8Z7R9K3Q6M2W8F4VY` | Track agent work periods     |
| Session Token | `tok_` + ULID | `tok_01HXE8Z7R9K3Q6M2W8F4VY` | WebSocket reconnection       |
| Message ID    | `msg_` + ULID | `msg_01HXE8Z7R9K3Q6M2W8F4VY` | Identify messages            |
| Event ID      | `evt_` + ULID | `evt_01HXE8Z7R9K3Q6M2W8F4VY` | Deduplication in JSONL merge |

ULID timestamps can be extracted with `ParseULID()` or `ULIDTimestamp()` for
time-based queries.

### Deterministic IDs

| ID Type            | Format                          | Example                  | Purpose                        |
| ------------------ | ------------------------------- | ------------------------ | ------------------------------ |
| Repository ID      | `r_` + base32(sha256(url))[:12] | `r_7K2Q1X9M3P0B`         | Identify repos across machines |
| Agent ID (named)   | `{name}`                        | `furiosa`                | Named agent identifier         |
| Agent ID (unnamed) | `{role}_{hash10}`               | `coordinator_1B9K33T6RK` | Hash-based agent identifier    |
| User ID            | `user:{username}`               | `user:leon`              | Identify browser/UI users      |

Repository IDs are generated from the normalized Git origin URL (SSH and HTTPS
URLs for the same repo produce the same ID). The normalization strips `.git`
suffixes and converts to lowercase HTTPS format.

### Utility Functions

| Function                      | Description                                            |
| ----------------------------- | ------------------------------------------------------ |
| `ValidateAgentName(name)`     | Validates name against naming rules and reserved words |
| `ParseAgentID(agentID)`       | Extracts role and hash from any agent ID format        |
| `AgentIDToName(agentID)`      | Converts any agent ID format to filename-safe name     |
| `ExtractDisplayName(agentID)` | Extracts `@mention`-style display name from agent ID   |

## Troubleshooting

### &quot;Role not specified&quot; Error

**Cause:** No identity source available.

**Solution:** Set environment variables, create identity file, or use CLI flags:

```bash
thrum quickstart --name myagent --role your_role --module your_module
```text

### &quot;Multiple identity files found&quot; Error

**Cause:** Multiple identity files in `.thrum/identities/` and no `THRUM_NAME`
set.

**Solution:** Set the `THRUM_NAME` environment variable to select which agent
you are:

```bash
export THRUM_NAME=furiosa
```text

### Registration Conflict

**Cause:** Another agent already registered with same role+module or same name.

**Solution:**

1. Check existing agent: `thrum agent list --role=X --module=Y`
2. Either:
   - Pick a different name or module
   - Use `--force` if you are taking over
   - Coordinate with the team

### Wrong Agent ID

**Cause:** Changed name, role, or module, creating new agent ID.

**Solution:** Agent IDs are deterministic for unnamed agents. To get the same
agent ID:

- Use the **exact same** role and module in the **same repository** (same
  repo_id)
- Or use a **named agent** where the name is always the ID

### Identity Source Confusion

**Cause:** Multiple identity sources (env vars + file + flags).

**Check priority:** `THRUM_NAME` &gt; CLI flags &gt; env vars &gt; identity file

**Debug:**

```bash
# Check what identity will be used
thrum agent whoami

# The &quot;source&quot; field shows which source was used:
# - &quot;environment&quot; = env vars
# - &quot;flags&quot; = CLI flags
# - &quot;identity_file&quot; = .thrum/identities/{name}.json
```text

## References

- RPC API: `docs/rpc-api.md` - agent.register, agent.list, agent.whoami,
  agent.delete, agent.cleanup methods
- Design Document: `dev-docs/2026-02-06-jsonl-sharding-and-agent-naming.md` -
  Agent naming system design
- Foundation Code: `internal/identity/identity.go` - ID generation and
  validation functions
- Config Loading: `internal/config/config.go` - Identity resolution chain
- Agent RPC: `internal/daemon/rpc/agent.go` - Registration, deletion, cleanup
  handlers
- MCP Server: `internal/mcp/server.go` - MCP identity loading</code></pre>

    </div>
    <p style="margin-top:2rem"><a href="../docs.html#identity.html">&larr; View in documentation</a></p>
  </main>
  <script>
    // Redirect browsers to the SPA for full navigation experience.
    // Crawlers (which don't execute JS) will index the static content above.
    if (window.location.search.indexOf('nospa') === -1) {
      window.location.replace('../docs.html#identity.html');
    }
  </script>
</body>
</html>