# Implementation Prompt: UI Recovery — CSS Variables, Structural Fixes, ComposeBar

> Generated by project-setup on 2026-02-24
> Plan: dev-docs/failure-recovery/RECOVERY_PLAN.md
> Design doc: dev-docs/failure-recovery/RECOVERY_PLAN.md (contains full specs)
> Epics: thrum-7fg (CSS vars, 4 tasks), thrum-kh3 (structural fixes, 5 tasks), thrum-76v (ComposeBar, 3 tasks)
> Total: 12 tasks across 3 sequential epics

## Quick Context

This is a recovery session — re-implementing lost UI work from session transcripts after a catastrophic repo wipe. All changes are well-documented with exact diffs in the recovery plan. The work spans CSS variable migration (replacing all hardcoded cyan-* Tailwind classes), UI structural fixes (daemon port, URL hash routing, polling, hooks ordering), and ComposeBar/MentionAutocomplete redesign (two-row layout, agent name display).

**Key gotcha from original implementation:** `bg-[#0d1120]` must map to `bg-[var(--panel-bg-start)]`, NOT `--app-bg-secondary`. The latter caused transparent slide-out panels in light mode.

**Do NOT modify `tailwind.config.js`.** An attempt to override the cyan palette was rejected — use CSS variables directly.

## Task Inventory

### Epic 1: thrum-7fg — CSS Variable Migration (P1, unblocked)
| Task | Title | Deps | Parallelizable? |
|---|---|---|---|
| thrum-7fg.1 | Add 4 new CSS variables to index.css | none | entry point |
| thrum-7fg.2 | Replace cyan in UI primitives (5 files) | 7fg.1 | yes, with 7fg.3 |
| thrum-7fg.3 | Replace cyan in feature components (8 files) | 7fg.1 | yes, with 7fg.2 |
| thrum-7fg.4 | Update test files | 7fg.2 + 7fg.3 | after both done |

### Epic 2: thrum-kh3 — UI Structural Fixes (P1, blocked by 7fg)
| Task | Title | Deps | Parallelizable? |
|---|---|---|---|
| thrum-kh3.1 | Daemon port preservation (Go) | none | yes, all 5 parallel |
| thrum-kh3.2 | URL hash routing (uiStore) | none | yes |
| thrum-kh3.3 | Polling fallbacks (useMessage, useSession) | none | yes |
| thrum-kh3.4 | MessageList hooks + auto-scroll | none | yes |
| thrum-kh3.5 | Remove useBrowserNotifications | none | yes |

### Epic 3: thrum-76v — ComposeBar + MentionAutocomplete (P1, blocked by kh3)
| Task | Title | Deps | Parallelizable? |
|---|---|---|---|
| thrum-76v.1 | MentionAutocomplete search + agent names | none | entry point |
| thrum-76v.2 | ComposeBar two-row layout | 76v.1 | yes, with 76v.3 |
| thrum-76v.3 | MentionAutocomplete test updates | 76v.1 | yes, with 76v.2 |

## Suggested Execution Batches

1. **Batch 1** (Epic 1): thrum-7fg.1 first, then 7fg.2 + 7fg.3 in parallel, then 7fg.4. Commit as `refactor(ui): replace hardcoded cyan classes with CSS variable tokens`.
2. **Batch 2** (Epic 2): All 5 tasks in parallel (they touch different files). Commit as `feat(ui): WS port reuse, URL hash routing, polling fallbacks, hooks fix`.
3. **Batch 3** (Epic 3): thrum-76v.1 first, then 76v.2 + 76v.3 in parallel. Commit as `feat(ui): ComposeBar two-row layout, agent name autocomplete`.

## Final Verification

After all 3 epics complete:
```bash
cd /Users/leon/dev/opensource/thrum/ui && pnpm test -- -- --run  # all 473+ tests pass
cd /Users/leon/dev/opensource/thrum/ui && pnpm build              # clean build
go build ./cmd/thrum/                                              # Go compiles
grep -r "cyan-" ui/packages/web-app/src/components/ --include="*.tsx"  # 0 results
grep -r "#0d1120" ui/packages/web-app/src/ --include="*.tsx"           # 0 results
make install && thrum daemon restart                                    # port preserved
```

Visual verification via playwright-cli:
- Open http://localhost:<port>, dark mode looks same, light mode readable
- Refresh page → navigation state preserved (URL hash)
- Type @coordinator_ → agent names appear first in dropdown
- ComposeBar has two-row layout (addressing above, textarea below)

## Worktree Setup

```bash
./scripts/setup-worktree-thrum.sh ~/.workspaces/thrum/ui-recovery feature/ui-recovery \
  --identity impl_ui_recovery --role implementer
```

---

## Implementation Agent Template

## Purpose

Guide an agent through implementing an epic's tasks in a designated worktree.
Supports both cold-start and resume scenarios. The agent works through beads
tasks in order, runs quality gates, and pushes completed work.

## Inputs Required

- `EPIC_ID` — thrum-7fg (start here), then thrum-kh3, then thrum-76v
- `WORKTREE_PATH` — ~/.workspaces/thrum/ui-recovery
- `BRANCH_NAME` — feature/ui-recovery
- `DESIGN_DOC` — dev-docs/failure-recovery/RECOVERY_PLAN.md
- `REFERENCE_CODE` — dev-docs/failure-recovery/session4.txt, session5.txt, session6.txt (contain exact diffs)
- `QUALITY_COMMANDS` — `cd /Users/leon/dev/opensource/thrum/ui && pnpm test -- -- --run && pnpm build && cd /Users/leon/dev/opensource/thrum && go build ./cmd/thrum/`
- `COVERAGE_TARGET` — >80%
- `AGENT_NAME` — impl_ui_recovery

---

## Sub-Agent Strategy

Delegate research, independent tasks, and verification to sub-agents. Your main
context should focus on task coordination, dependency management, and
cross-cutting decisions.

### Principles

1. **Parallelize independent tasks** — When multiple unblocked tasks touch
   different files/packages, implement them simultaneously via sub-agents
2. **Delegate research** — Spawn sub-agents to explore unfamiliar code before
   implementing, rather than reading it into your context
3. **Verify in background** — Run tests and lint via background sub-agents while
   you continue with the next task
4. **Focused prompts** — Give each sub-agent the full task description, worktree
   path, quality commands, and expected deliverables

### Agent Selection

| Task                        | Agent Type                  | Model  | Background? |
| --------------------------- | --------------------------- | ------ | ----------- |
| Implement a complex task    | `general-purpose`           | sonnet | no\*        |
| Implement a simple task     | `general-purpose`           | haiku  | no\*        |
| Explore unfamiliar code     | `Explore`                   | sonnet | yes         |
| Run tests / lint            | `general-purpose`           | haiku  | yes         |
| Review implementation       | `feature-dev:code-reviewer` | sonnet | no          |
| Doc updates / config tweaks | `general-purpose`           | haiku  | yes         |

\*Use foreground when you need the result before proceeding. Use background when
you can continue other work while they run.

### When to Parallelize vs. Work Sequentially

**Parallel** (sub-agents):

- Tasks touching different files/packages with no shared state
- Independent verification (tests, lint, coverage)
- Research into multiple unrelated code areas
- Doc/config updates alongside implementation

**Sequential** (direct work):

- Tasks modifying shared files or depending on prior task output
- Tasks requiring deep context from current session's changes
- Tasks needing judgment calls mid-implementation
- Single remaining task (no parallelism benefit)

### Verifier Sub-Agent Pattern

After completing a task, spawn a background sub-agent to independently verify:

- Run the test suite and confirm all pass
- Review implementation against the task description
- Check code follows project conventions
- Confirm acceptance criteria are met

This lets you start the next task immediately while verification runs in
parallel.

---

## MANDATORY: Register Before Any Work

**STOP. Run these commands before doing anything else.** Do not skip this
section.

```bash
cd ~/.workspaces/thrum/ui-recovery
thrum quickstart --name impl_ui_recovery --role implementer --module feature/ui-recovery --intent "Implementing thrum-7fg, thrum-kh3, thrum-76v"
thrum inbox --unread
thrum send "Starting work on UI recovery epics (thrum-7fg, thrum-kh3, thrum-76v)" --to @coordinator
```

**Verify registration succeeded** — you must see your agent name in the output
of `thrum quickstart`. If it fails, check that the daemon is running with
`thrum daemon status`.

**Use the message listener** — Spawn a background listener to get async
notifications. Re-arm it every time it returns (both MESSAGES_RECEIVED and
NO_MESSAGES_TIMEOUT).

When your work is complete (Phase 4), send a completion message:

```bash
thrum send "Completed UI recovery (thrum-7fg, thrum-kh3, thrum-76v). All tasks done, tests passing." --to @coordinator
```

If you hit a blocker from another agent's work, escalate:

```bash
thrum send "Blocked on <TASK_ID> by <BLOCKER_ID>" --to @coordinator
```

---

## Phase 1: Orient

Whether starting fresh or resuming after context loss, always begin here. This
phase is idempotent — running it multiple times is safe and expected.

### Step 1: Check Epic & Task Status

```bash
cd ~/.workspaces/thrum/ui-recovery

# Check epic status — see which tasks are done, in_progress, or pending
bd show thrum-7fg
bd show thrum-kh3
bd show thrum-76v

# Check for any in-progress tasks (may be from a prior session)
bd list --status=in_progress

# Check completed tasks
bd list --status=completed
```

### Step 2: Check Git State

```bash
git branch --show-current
git status
git --no-pager log --oneline -10
git pull --rebase
```

### Step 3: Explore Existing Code

Use `auggie-mcp codebase-retrieval` to understand what already exists:

1. Check which files/packages have been created
2. Review existing implementations for patterns to follow
3. Identify the current state of any in-progress tasks

Read the design doc: `dev-docs/failure-recovery/RECOVERY_PLAN.md`

Reference the session transcripts for exact diffs: `dev-docs/failure-recovery/session4.txt`, `session5.txt`, `session6.txt`

### Step 4: Determine Starting Point

- If **all tasks are complete**: Skip to Phase 3 (Verify Quality) then Phase 4 (Complete)
- If **a task is `in_progress`**: Review its state — check what's partially implemented, check git diff, then continue from where it left off
- If **tasks are pending**: Start with the first unblocked pending task (lowest dependency order)

**CRITICAL: DO NOT redo completed work.** Trust the beads status and git history. Pick up from exactly where the previous session stopped.

---

## Phase 2: Implement Tasks

### Task Execution Loop

For each task (in dependency order, foundations first):

#### 1. Claim the Task

```bash
bd update <TASK_ID> --status=in_progress
```

#### 2. Read the Task Details

```bash
bd show <TASK_ID>
```

The task description is the **source of truth** for what to build. It contains
file paths, signatures, code examples, and acceptance criteria. Follow it
precisely.

#### 3. Implement the Task

- Follow the task description
- Write tests alongside implementation (TDD when appropriate)
- Follow existing code patterns and conventions in the codebase
- Reference `dev-docs/failure-recovery/RECOVERY_PLAN.md` for architectural context when needed

#### 4. Verify the Task

```bash
cd /Users/leon/dev/opensource/thrum/ui && pnpm test -- -- --run && pnpm build && cd /Users/leon/dev/opensource/thrum && go build ./cmd/thrum/
```

All tests must pass before proceeding. If tests fail, fix them before moving on.
Do not skip failing tests or mark them as known failures without explicit
instruction.

#### 5. Commit the Work

```bash
git add <specific-files>
git commit -m "<epic-title>: <concise task description>"
```

Commit after each task, not in bulk at the end. Use descriptive commit messages
that explain what was built.

#### 6. Close the Task

```bash
bd close <TASK_ID>
```

#### 7. Move to Next Task

Repeat from step 1 with the next unblocked pending task.

---

### Parallel Task Implementation

When multiple tasks are unblocked and independent, implement them simultaneously.

#### Identify Parallelizable Tasks

After completing a task, check for unblocked work:

```bash
bd show <EPIC_ID>  # Which tasks are pending and unblocked?
```

#### Launch Pattern

Give each sub-agent everything it needs to work autonomously:

```text
# Launched in ONE message for parallel execution
Task(subagent_type="general-purpose", model="sonnet",
  prompt="Implement a task in ~/.workspaces/thrum/ui-recovery on branch feature/ui-recovery.

  ## Task Details
  <paste full bd show output for task A>

  ## Instructions
  1. Read the task description — it is the source of truth
  2. Implement following existing code patterns
  3. Run tests: cd /Users/leon/dev/opensource/thrum/ui && pnpm test -- -- --run && pnpm build
  4. Commit: git commit -m '<epic-title>: <task summary>'
  5. Return: what was built, test results, commit hash")
```

#### After Sub-Agents Complete

1. Review reported results (commit hashes, test output)
2. Check for conflicts: `git --no-pager log --oneline -5`
3. Close completed tasks: `bd close <TASK_A> <TASK_B>`
4. Run unified quality gate
5. Check for newly unblocked tasks — repeat if more are available

#### Guardrails

- **2-3 concurrent sub-agents** is the sweet spot
- **Partition by file/package** to avoid git conflicts
- **Always run a final unified test pass** after parallel work

---

### Handling Blockers

If a task is blocked:

1. Check what's blocking it: `bd show <BLOCKER_ID>`
2. If the blocker is another task **within your epic**, work on the blocker first
3. If the blocker is **external** (different epic, different agent), skip the blocked task and work on the next unblocked one
4. Document the blocker: `bd update <TASK_ID> --notes="Blocked by <BLOCKER_ID>: <reason>"`

---

## Phase 3: Verify Quality

After all tasks are complete, run the full verification suite.

```bash
cd ~/.workspaces/thrum/ui-recovery

# Run all tests
cd /Users/leon/dev/opensource/thrum/ui && pnpm test -- -- --run && pnpm build && cd /Users/leon/dev/opensource/thrum && go build ./cmd/thrum/

# Verification
grep -r "cyan-" ui/packages/web-app/src/components/ --include="*.tsx"  # must be 0 results
grep -r "#0d1120" ui/packages/web-app/src/ --include="*.tsx"           # must be 0 results
```

### Verification Checklist

- [ ] All tasks in all 3 epics are closed
- [ ] All tests pass (473+)
- [ ] Build passes (UI + Go)
- [ ] 0 remaining cyan- references in components
- [ ] 0 remaining #0d1120 references
- [ ] Commit history is clean and descriptive

---

## Phase 4: Complete & Land

### Step 1: Close the Epics

```bash
bd close thrum-7fg --reason="CSS variable migration complete"
bd close thrum-kh3 --reason="UI structural fixes complete"
bd close thrum-76v --reason="ComposeBar redesign complete"
```

### Step 2: Merge to Main

```bash
git fetch origin main
git rebase origin/main
cd /Users/leon/dev/opensource/thrum/ui && pnpm test -- -- --run && pnpm build && cd /Users/leon/dev/opensource/thrum && go build ./cmd/thrum/
cd /Users/leon/dev/opensource/thrum
git checkout main
git merge feature/ui-recovery
```

### Step 3: Push

```bash
git push origin main
```

### Step 4: Report Completion

```bash
thrum send "Completed UI recovery (thrum-7fg, thrum-kh3, thrum-76v). All tasks done, tests passing, merged to main." --to @coordinator
```

---

## Resume Quick Reference

```bash
# 1. Re-register with Thrum (MANDATORY)
cd ~/.workspaces/thrum/ui-recovery
thrum quickstart --name impl_ui_recovery --role implementer --module feature/ui-recovery --intent "Resuming UI recovery"
thrum inbox --unread

# 2. Orient from beads and git
bd show thrum-7fg
bd show thrum-kh3
bd show thrum-76v
bd list --status=in_progress
git --no-pager log --oneline -10
git status
# Then pick up from the first incomplete task — DO NOT redo completed work
```
